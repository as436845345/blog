<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>å¯¹æ•°å…¬å¼å¤§å…¨ï¼šlogã€lnã€lg äº’æ¢ä¸è¿ç®—æŒ‡å—</title>
      <link href="/2026/02/26/logarithm-formulas-guide-md/"/>
      <url>/2026/02/26/logarithm-formulas-guide-md/</url>
      
        <content type="html"><![CDATA[<h3 id="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-26-18-02-28"><a href="#æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-26-18-02-28" class="headerlink" title="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-26 18:02:28"></a><strong>æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-26 18:02:28</strong></h3><p>æœ¬æ–‡é€šè¿‡ Qwen3.5&#x3D;Plus è¾…åŠ©ç”Ÿæˆï¼</p><hr><blockquote><p>ğŸ“Œ <strong>ç¬¦å·çº¦å®š</strong>ï¼ˆæœ¬æ–‡é‡‡ç”¨è®¡ç®—æœºç§‘å­¦&#x2F;å·¥ç¨‹æ ‡å‡†ï¼‰ï¼š</p><table><thead><tr><th>ç¬¦å·</th><th>å«ä¹‰</th><th>åº•æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>$\log x$</td><td>å¸¸ç”¨å¯¹æ•°</td><td><strong>10</strong></td><td>å·¥ç¨‹ã€ç§‘å­¦è®¡ç®—é»˜è®¤</td></tr><tr><td>$\ln x$</td><td>è‡ªç„¶å¯¹æ•°</td><td><strong>e</strong> â‰ˆ 2.71828</td><td>æ•°å­¦åˆ†æã€å¾®ç§¯åˆ†æ ‡å‡†</td></tr><tr><td>$\lg x$</td><td>äºŒè¿›åˆ¶å¯¹æ•°</td><td><strong>2</strong></td><td>ç®—æ³•ã€ä¿¡æ¯è®ºã€è®¡ç®—æœºé¢†åŸŸ</td></tr></tbody></table></blockquote><hr><h2 id="ä¸€ã€å¯¹æ•°çš„å®šä¹‰ä¸æ ¸å¿ƒäº’é€†å…³ç³»"><a href="#ä¸€ã€å¯¹æ•°çš„å®šä¹‰ä¸æ ¸å¿ƒäº’é€†å…³ç³»" class="headerlink" title="ä¸€ã€å¯¹æ•°çš„å®šä¹‰ä¸æ ¸å¿ƒäº’é€†å…³ç³»"></a>ä¸€ã€å¯¹æ•°çš„å®šä¹‰ä¸æ ¸å¿ƒäº’é€†å…³ç³»</h2><p>è¿™æ˜¯ç†è§£æ‰€æœ‰å¯¹æ•°å…¬å¼çš„åŸºç¡€ã€‚å¯¹æ•°è¿ç®—æ˜¯æŒ‡æ•°è¿ç®—çš„é€†è¿ç®—ã€‚</p><h3 id="1-1-å®šä¹‰å¼"><a href="#1-1-å®šä¹‰å¼" class="headerlink" title="1.1 å®šä¹‰å¼"></a>1.1 å®šä¹‰å¼</h3><p>è‹¥ $a^n &#x3D; x$ï¼ˆå…¶ä¸­ $a&gt;0, a\neq1, x&gt;0$ï¼‰ï¼Œåˆ™ï¼š<br>$$n &#x3D; \log_a x$$</p><p><strong>äº’æ¢å…¬å¼</strong>ï¼š<br>$$ \log_a x &#x3D; n \iff a^n &#x3D; x $$</p><p><strong>ç¤ºä¾‹</strong>ï¼š</p><ul><li>å› ä¸º $2^3 &#x3D; 8$ï¼Œæ‰€ä»¥ $\log_2 8 &#x3D; 3$</li><li>å› ä¸º $10^2 &#x3D; 100$ï¼Œæ‰€ä»¥ $\log_{10} 100 &#x3D; 2$</li><li>å› ä¸º $e^1 &#x3D; e$ï¼Œæ‰€ä»¥ $\ln e &#x3D; 1$</li></ul><h3 id="1-2-åŸºæœ¬æ’ç­‰å¼"><a href="#1-2-åŸºæœ¬æ’ç­‰å¼" class="headerlink" title="1.2 åŸºæœ¬æ’ç­‰å¼"></a>1.2 åŸºæœ¬æ’ç­‰å¼</h3><p>åŸºäºå®šä¹‰å¼æ¨å¯¼å‡ºçš„ç›´æ¥ç»“è®ºï¼š</p><table><thead><tr><th>å…¬å¼</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>$\log_a 1 &#x3D; 0$</td><td>1 çš„å¯¹æ•°æ°¸è¿œä¸º 0</td><td>$\log_{10} 1 &#x3D; 0$ ï¼ˆå› ä¸º $10^0&#x3D;1$ï¼‰</td></tr><tr><td>$\log_a a &#x3D; 1$</td><td>åº•æ•°çš„å¯¹æ•°æ°¸è¿œä¸º 1</td><td>$\ln e &#x3D; 1$ ï¼ˆå› ä¸º $e^1&#x3D;e$ï¼‰</td></tr><tr><td>$a^{\log_a x} &#x3D; x$</td><td>æŒ‡æ•°è¿˜åŸçœŸæ•°</td><td>$2^{\log_2 5} &#x3D; 5$</td></tr><tr><td>$\log_a (a^x) &#x3D; x$</td><td>å¯¹æ•°è¿˜åŸæŒ‡æ•°</td><td>$\log_3 (3^7) &#x3D; 7$</td></tr><tr><td>$\log_a x &#x3D; \frac{1}{\log_x a}$</td><td>åº•æ•°ä¸çœŸæ•°äº’æ¢</td><td>$\log_2 8 &#x3D; \frac{1}{\log_8 2} &#x3D; 3$</td></tr></tbody></table><hr><h2 id="äºŒã€å¯¹æ•°è¿ç®—æ³•åˆ™"><a href="#äºŒã€å¯¹æ•°è¿ç®—æ³•åˆ™" class="headerlink" title="äºŒã€å¯¹æ•°è¿ç®—æ³•åˆ™"></a>äºŒã€å¯¹æ•°è¿ç®—æ³•åˆ™</h2><h3 id="2-1-ä¹˜é™¤æ³•åˆ™"><a href="#2-1-ä¹˜é™¤æ³•åˆ™" class="headerlink" title="2.1 ä¹˜é™¤æ³•åˆ™"></a>2.1 ä¹˜é™¤æ³•åˆ™</h3><table><thead><tr><th>å…¬å¼</th><th>æ–‡å­—æè¿°</th><th>æ•°å€¼ç¤ºä¾‹</th></tr></thead><tbody><tr><td>$\log_a (M \cdot N) &#x3D; \log_a M + \log_a N$</td><td>ç§¯çš„å¯¹æ•° &#x3D; å¯¹æ•°ä¹‹å’Œ</td><td>$\log_{10}(100 \times 1000) &#x3D; 2 + 3 &#x3D; 5$</td></tr><tr><td>$\log_a \left(\frac{M}{N}\right) &#x3D; \log_a M - \log_a N$</td><td>å•†çš„å¯¹æ•° &#x3D; å¯¹æ•°ä¹‹å·®</td><td>$\ln\left(\frac{e^5}{e^2}\right) &#x3D; 5 - 2 &#x3D; 3$</td></tr></tbody></table><h3 id="2-2-å¹‚ä¸æ ¹æ³•åˆ™"><a href="#2-2-å¹‚ä¸æ ¹æ³•åˆ™" class="headerlink" title="2.2 å¹‚ä¸æ ¹æ³•åˆ™"></a>2.2 å¹‚ä¸æ ¹æ³•åˆ™</h3><table><thead><tr><th>å…¬å¼</th><th>æ–‡å­—æè¿°</th><th>æ•°å€¼ç¤ºä¾‹</th></tr></thead><tbody><tr><td>$\log_a (M^k) &#x3D; k \cdot \log_a M$</td><td>å¹‚çš„å¯¹æ•° &#x3D; æŒ‡æ•°Ã—å¯¹æ•°</td><td>$\log_2(8^3) &#x3D; 3 \cdot \log_2 8 &#x3D; 3 \times 3 &#x3D; 9$</td></tr><tr><td>$\log_a (\sqrt[n]{M}) &#x3D; \frac{1}{n} \cdot \log_a M$</td><td>æ ¹çš„å¯¹æ•° &#x3D; å¯¹æ•°Ã·æ ¹æŒ‡æ•°</td><td>$\lg(\sqrt{1024}) &#x3D; \frac{1}{2} \lg 1024 &#x3D; 5$</td></tr><tr><td>$\log_{a^n} M &#x3D; \frac{1}{n} \cdot \log_a M$</td><td>åº•æ•°ä¸ºå¹‚æ—¶çš„å˜æ¢</td><td>$\log_{100} 1000 &#x3D; \frac{1}{2} \log_{10} 1000 &#x3D; 1.5$</td></tr></tbody></table><hr><h2 id="ä¸‰ã€æ¢åº•å…¬å¼ï¼ˆæ ¸å¿ƒï¼ï¼‰"><a href="#ä¸‰ã€æ¢åº•å…¬å¼ï¼ˆæ ¸å¿ƒï¼ï¼‰" class="headerlink" title="ä¸‰ã€æ¢åº•å…¬å¼ï¼ˆæ ¸å¿ƒï¼ï¼‰"></a>ä¸‰ã€æ¢åº•å…¬å¼ï¼ˆæ ¸å¿ƒï¼ï¼‰</h2><p>è¿™æ˜¯è¿æ¥ä¸åŒåº•æ•°å¯¹æ•°çš„æ¡¥æ¢ã€‚</p><p>$$ \boxed{\log_a x &#x3D; \frac{\log_b x}{\log_b a}} $$</p><p><strong>è®°å¿†å£è¯€</strong>ï¼šã€Œæ–°åº•åšåˆ†æ¯ï¼ŒçœŸæ•°ä¸å˜ï¼ŒåŸåº•å˜åˆ†å­ã€</p><h3 id="3-1-ä¸‰åº•æ•°äº’æ¢é€ŸæŸ¥è¡¨-log-10-ln-log-2"><a href="#3-1-ä¸‰åº•æ•°äº’æ¢é€ŸæŸ¥è¡¨-log-10-ln-log-2" class="headerlink" title="3.1 ä¸‰åº•æ•°äº’æ¢é€ŸæŸ¥è¡¨ ($\log_{10}, \ln, \log_2$)"></a>3.1 ä¸‰åº•æ•°äº’æ¢é€ŸæŸ¥è¡¨ ($\log_{10}, \ln, \log_2$)</h3><table><thead><tr><th>è½¬æ¢æ–¹å‘</th><th>å…¬å¼</th><th>è¿‘ä¼¼ç³»æ•°</th><th>ç¤ºä¾‹è®¡ç®—</th></tr></thead><tbody><tr><td><strong>$\log_{10} \to \ln$</strong></td><td>$\ln x &#x3D; \log_{10} x \times \ln 10$</td><td>$\times 2.302585$</td><td>$\ln 100 &#x3D; 2 \times 2.3026 \approx 4.605$</td></tr><tr><td><strong>$\ln \to \log_{10}$</strong></td><td>$\log_{10} x &#x3D; \frac{\ln x}{\ln 10}$</td><td>$\div 2.302585$</td><td>$\log_{10} e &#x3D; 1 \div 2.3026 \approx 0.434$</td></tr><tr><td><strong>$\log_2 \to \ln$</strong></td><td>$\ln x &#x3D; \log_2 x \times \ln 2$</td><td>$\times 0.693147$</td><td>$\ln 8 &#x3D; 3 \times 0.6931 \approx 2.079$</td></tr><tr><td><strong>$\ln \to \log_2$</strong></td><td>$\log_2 x &#x3D; \frac{\ln x}{\ln 2}$</td><td>$\div 0.693147$</td><td>$\log_2 10 &#x3D; 2.3026 \div 0.6931 \approx 3.322$</td></tr><tr><td><strong>$\log_{10} \to \log_2$</strong></td><td>$\log_2 x &#x3D; \frac{\log_{10} x}{\log_{10} 2}$</td><td>$\div 0.301030$</td><td>$\log_2 100 &#x3D; 2 \div 0.3010 \approx 6.644$</td></tr><tr><td><strong>$\log_2 \to \log_{10}$</strong></td><td>$\log_{10} x &#x3D; \log_2 x \times \log_{10} 2$</td><td>$\times 0.301030$</td><td>$\log_{10} 8 &#x3D; 3 \times 0.3010 \approx 0.903$</td></tr></tbody></table><h3 id="3-2-å¸¸ç”¨å¸¸æ•°é€ŸæŸ¥"><a href="#3-2-å¸¸ç”¨å¸¸æ•°é€ŸæŸ¥" class="headerlink" title="3.2 å¸¸ç”¨å¸¸æ•°é€ŸæŸ¥"></a>3.2 å¸¸ç”¨å¸¸æ•°é€ŸæŸ¥</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># è‡ªç„¶å¸¸æ•°</span><br><span class="line">ln(2)  â‰ˆ 0.69314718</span><br><span class="line">ln(10) â‰ˆ 2.30258509</span><br><span class="line"></span><br><span class="line"># å¸¸ç”¨å¯¹æ•°</span><br><span class="line">logâ‚â‚€(2) â‰ˆ 0.30103000</span><br><span class="line">logâ‚â‚€(e) â‰ˆ 0.43429448</span><br><span class="line"></span><br><span class="line"># äºŒè¿›åˆ¶å¯¹æ•°</span><br><span class="line">logâ‚‚(10) â‰ˆ 3.32192809</span><br><span class="line">logâ‚‚(e)  â‰ˆ 1.44269504</span><br><span class="line"></span><br><span class="line"># å€’æ•°å…³ç³»ï¼ˆç”¨äºä¹˜æ³•æ›¿ä»£é™¤æ³•ï¼Œæé«˜è®¡ç®—é€Ÿåº¦ï¼‰</span><br><span class="line">1/ln(2)      â‰ˆ 1.442695  (ln è½¬ logâ‚‚ çš„ä¹˜æ•°)</span><br><span class="line">1/ln(10)     â‰ˆ 0.434294  (ln è½¬ logâ‚â‚€ çš„ä¹˜æ•°)</span><br><span class="line">1/logâ‚â‚€(2)   â‰ˆ 3.321928  (logâ‚â‚€ è½¬ logâ‚‚ çš„ä¹˜æ•°)</span><br></pre></td></tr></table></figure><hr><h2 id="å››ã€ç‰¹æ®Šå€¼ä¸æé™"><a href="#å››ã€ç‰¹æ®Šå€¼ä¸æé™" class="headerlink" title="å››ã€ç‰¹æ®Šå€¼ä¸æé™"></a>å››ã€ç‰¹æ®Šå€¼ä¸æé™</h2><h3 id="4-1-å¸¸è§ç‰¹æ®Šå€¼è¡¨"><a href="#4-1-å¸¸è§ç‰¹æ®Šå€¼è¡¨" class="headerlink" title="4.1 å¸¸è§ç‰¹æ®Šå€¼è¡¨"></a>4.1 å¸¸è§ç‰¹æ®Šå€¼è¡¨</h3><table><thead><tr><th>$x$</th><th>$\log_{10} x$</th><th>$\ln x$</th><th>$\log_2 x$</th></tr></thead><tbody><tr><td>1</td><td>0</td><td>0</td><td>0</td></tr><tr><td>2</td><td>0.30103</td><td>0.69315</td><td>1</td></tr><tr><td>$e$</td><td>0.43429</td><td>1</td><td>1.44270</td></tr><tr><td>10</td><td>1</td><td>2.30259</td><td>3.32193</td></tr><tr><td>100</td><td>2</td><td>4.60517</td><td>6.64386</td></tr><tr><td>1000</td><td>3</td><td>6.90776</td><td>9.96578</td></tr></tbody></table><h3 id="4-2-æé™ä¸è¿‘ä¼¼"><a href="#4-2-æé™ä¸è¿‘ä¼¼" class="headerlink" title="4.2 æé™ä¸è¿‘ä¼¼"></a>4.2 æé™ä¸è¿‘ä¼¼</h3><table><thead><tr><th>å…¬å¼</th><th>æ¡ä»¶</th><th>åº”ç”¨ç¤ºä¾‹</th></tr></thead><tbody><tr><td>$\lim_{x \to 0^+} \log_a x &#x3D; -\infty$</td><td>$a &gt; 1$</td><td>$\log_{10}(0.001) &#x3D; -3$</td></tr><tr><td>$\lim_{x \to +\infty} \log_a x &#x3D; +\infty$</td><td>$a &gt; 1$</td><td>$\log_2(1024) &#x3D; 10$</td></tr><tr><td>$\log_a(1+x) \approx \frac{x}{\ln a}$</td><td>$x \to 0$ (å°é‡è¿‘ä¼¼)</td><td>$\ln(1.01) \approx 0.01$</td></tr></tbody></table><hr><h2 id="äº”ã€å¾®ç§¯åˆ†ç›¸å…³å…¬å¼"><a href="#äº”ã€å¾®ç§¯åˆ†ç›¸å…³å…¬å¼" class="headerlink" title="äº”ã€å¾®ç§¯åˆ†ç›¸å…³å…¬å¼"></a>äº”ã€å¾®ç§¯åˆ†ç›¸å…³å…¬å¼</h2><h3 id="5-1-å¯¼æ•°å…¬å¼"><a href="#5-1-å¯¼æ•°å…¬å¼" class="headerlink" title="5.1 å¯¼æ•°å…¬å¼"></a>5.1 å¯¼æ•°å…¬å¼</h3><table><thead><tr><th>å‡½æ•° $f(x)$</th><th>å¯¼æ•° $fâ€™(x)$</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>$\ln x$</td><td>$\frac{1}{x}$</td><td>$\frac{d}{dx} \ln(5x) &#x3D; \frac{1}{x}$</td></tr><tr><td>$\log_a x$</td><td>$\frac{1}{x \ln a}$</td><td>$\frac{d}{dx} \log_{10} x &#x3D; \frac{1}{x \ln 10}$</td></tr><tr><td>$\log_a f(x)$</td><td>$\frac{fâ€™(x)}{f(x) \ln a}$</td><td>$\frac{d}{dx} \ln(x^2+1) &#x3D; \frac{2x}{x^2+1}$</td></tr></tbody></table><h3 id="5-2-ç§¯åˆ†å…¬å¼"><a href="#5-2-ç§¯åˆ†å…¬å¼" class="headerlink" title="5.2 ç§¯åˆ†å…¬å¼"></a>5.2 ç§¯åˆ†å…¬å¼</h3><table><thead><tr><th>ç§¯åˆ†è¡¨è¾¾å¼</th><th>ç»“æœ</th><th>éªŒè¯</th></tr></thead><tbody><tr><td>$\int \frac{1}{x} dx$</td><td>$\ln |x| + C$</td><td>$\int_1^e \frac{1}{x} dx &#x3D; \ln e - \ln 1 &#x3D; 1$</td></tr><tr><td>$\int \log_a x , dx$</td><td>$\frac{x \ln x - x}{\ln a} + C$</td><td>-</td></tr><tr><td>$\int x^k \ln x , dx$</td><td>$\frac{x^{k+1}}{k+1} \ln x - \frac{x^{k+1}}{(k+1)^2} + C$</td><td>$k \neq -1$</td></tr></tbody></table><hr><h2 id="å…­ã€å®Œæ•´è®¡ç®—ç¤ºä¾‹"><a href="#å…­ã€å®Œæ•´è®¡ç®—ç¤ºä¾‹" class="headerlink" title="å…­ã€å®Œæ•´è®¡ç®—ç¤ºä¾‹"></a>å…­ã€å®Œæ•´è®¡ç®—ç¤ºä¾‹</h2><h3 id="ç¤ºä¾‹-1ï¼šæ··åˆè¿ç®—éªŒè¯"><a href="#ç¤ºä¾‹-1ï¼šæ··åˆè¿ç®—éªŒè¯" class="headerlink" title="ç¤ºä¾‹ 1ï¼šæ··åˆè¿ç®—éªŒè¯"></a>ç¤ºä¾‹ 1ï¼šæ··åˆè¿ç®—éªŒè¯</h3><p><strong>é¢˜ç›®</strong>ï¼šè®¡ç®— $\log_2(100 \times \sqrt{10})$</p><p><strong>è§£æ³• 1ï¼šåˆ©ç”¨å¯¹æ•°æ€§è´¨æ‹†åˆ†</strong><br>$$<br>\begin{aligned}<br>\log_2(100 \times \sqrt{10}) &amp;&#x3D; \log_2(100) + \log_2(10^{0.5}) \<br>&amp;&#x3D; \log_2(100) + 0.5 \times \log_2(10) \<br>&amp;\approx 6.643856 + 0.5 \times 3.321928 \<br>&amp;\approx 6.643856 + 1.660964 \<br>&amp;\approx 8.304820<br>\end{aligned}<br>$$</p><p><strong>è§£æ³• 2ï¼šå…¨è½¬ $\ln$ è®¡ç®—ï¼ˆæ¢åº•å…¬å¼ï¼‰</strong><br>$$<br>\begin{aligned}<br>\log_2(100 \times \sqrt{10}) &amp;&#x3D; \frac{\ln(100 \times \sqrt{10})}{\ln 2} \<br>&amp;&#x3D; \frac{\ln 100 + 0.5 \ln 10}{\ln 2} \<br>&amp;&#x3D; \frac{4.605170 + 0.5(2.302585)}{0.693147} \<br>&amp;&#x3D; \frac{5.756463}{0.693147} \<br>&amp;\approx 8.304820<br>\end{aligned}<br>$$</p><p><strong>éªŒè¯</strong>ï¼š$2^{8.304820} \approx 316.227$ï¼Œè€Œ $100 \times \sqrt{10} \approx 316.227$ã€‚ç»“æœæ­£ç¡®ã€‚</p><hr><h3 id="ç¤ºä¾‹-2ï¼šç®—æ³•å¤æ‚åº¦è½¬æ¢"><a href="#ç¤ºä¾‹-2ï¼šç®—æ³•å¤æ‚åº¦è½¬æ¢" class="headerlink" title="ç¤ºä¾‹ 2ï¼šç®—æ³•å¤æ‚åº¦è½¬æ¢"></a>ç¤ºä¾‹ 2ï¼šç®—æ³•å¤æ‚åº¦è½¬æ¢</h3><p><strong>é¢˜ç›®</strong>ï¼šå°† $O(\log_2 n)$ è½¬æ¢ä¸ºä»¥ 10 ä¸ºåº•çš„å¯¹æ•°è¡¨ç¤ºã€‚</p><p><strong>æ¨å¯¼</strong>ï¼š<br>$$ \log_2 n &#x3D; \frac{\log_{10} n}{\log_{10} 2} \approx \frac{\log_{10} n}{0.301030} \approx 3.321928 \times \log_{10} n $$</p><p><strong>ç»“è®º</strong>ï¼š<br>åœ¨ç®—æ³•å¤æ‚åº¦åˆ†æï¼ˆå¤§ O è®°å·ï¼‰ä¸­ï¼Œå¸¸æ•°å€æ•°è¢«å¿½ç•¥ï¼Œå› æ­¤ï¼š<br>$$ O(\log_2 n) &#x3D; O(\log_{10} n) &#x3D; O(\ln n) $$</p><p><strong>å®é™…åº”ç”¨</strong>ï¼š<br>å¯¹äº $n &#x3D; 1,000,000$ çš„äºŒåˆ†æŸ¥æ‰¾ï¼š</p><ul><li>$\log_2 n \approx 19.93$ ï¼ˆçº¦ 20 æ¬¡æ¯”è¾ƒï¼‰</li><li>$\log_{10} n &#x3D; 6$</li><li>éªŒè¯ï¼š$6 \times 3.321928 \approx 19.93$</li></ul><hr><h3 id="ç¤ºä¾‹-3ï¼šç§‘å­¦è®¡æ•°æ³•ä¸-pH-å€¼"><a href="#ç¤ºä¾‹-3ï¼šç§‘å­¦è®¡æ•°æ³•ä¸-pH-å€¼" class="headerlink" title="ç¤ºä¾‹ 3ï¼šç§‘å­¦è®¡æ•°æ³•ä¸ pH å€¼"></a>ç¤ºä¾‹ 3ï¼šç§‘å­¦è®¡æ•°æ³•ä¸ pH å€¼</h3><p><strong>é¢˜ç›®</strong>ï¼šå·²çŸ¥ pH å®šä¹‰ä¸º $\text{pH} &#x3D; -\log_{10}[H^+]$ï¼Œæ±‚ $[H^+] &#x3D; 2.5 \times 10^{-4} \text{ mol&#x2F;L}$ æ—¶çš„ pH å€¼ã€‚</p><p><strong>è®¡ç®—</strong>ï¼š<br>$$<br>\begin{aligned}<br>\text{pH} &amp;&#x3D; -\log_{10}(2.5 \times 10^{-4}) \<br>&amp;&#x3D; -(\log_{10} 2.5 + \log_{10} 10^{-4}) \<br>&amp;&#x3D; -(0.397940 - 4) \<br>&amp;&#x3D; -(-3.602060) \<br>&amp;&#x3D; 3.602060<br>\end{aligned}<br>$$</p><p><strong>éªŒè¯</strong>ï¼š$10^{-3.602060} \approx 2.5 \times 10^{-4}$ã€‚ç»“æœæ­£ç¡®ã€‚</p><hr><h2 id="ä¸ƒã€å¸¸è§è¯¯åŒºä¸é¿å‘æŒ‡å—"><a href="#ä¸ƒã€å¸¸è§è¯¯åŒºä¸é¿å‘æŒ‡å—" class="headerlink" title="ä¸ƒã€å¸¸è§è¯¯åŒºä¸é¿å‘æŒ‡å—"></a>ä¸ƒã€å¸¸è§è¯¯åŒºä¸é¿å‘æŒ‡å—</h2><table><thead><tr><th>âŒ é”™è¯¯å†™æ³•</th><th>âœ… æ­£ç¡®å†™æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>$\log(a + b) &#x3D; \log a + \log b$</td><td>$\log(a \times b) &#x3D; \log a + \log b$</td><td>å¯¹æ•°å¯¹ä¹˜æ³•åˆ†é…ï¼Œä¸å¯¹åŠ æ³•</td></tr><tr><td>$\log(a &#x2F; b) &#x3D; \log a &#x2F; \log b$</td><td>$\log(a &#x2F; b) &#x3D; \log a - \log b$</td><td>å•†çš„å¯¹æ•°æ˜¯å¯¹æ•°ä¹‹å·®</td></tr><tr><td>$\log(a^n) &#x3D; (\log a)^n$</td><td>$\log(a^n) &#x3D; n \times \log a$</td><td>æŒ‡æ•°æåˆ°å‰é¢åšç³»æ•°</td></tr><tr><td>$\log(-x) &#x3D; -\log x$</td><td>$\log(-x)$ æ— å®šä¹‰ï¼ˆå®æ•°åŸŸï¼‰</td><td>çœŸæ•°å¿…é¡» $&gt; 0$</td></tr><tr><td>æ··æ·† $\log$ çš„åº•æ•°</td><td>æ˜ç¡®å†™å‡º $\ln, \log_{10}, \log_2$</td><td>é¿å…æ­§ä¹‰ï¼Œæ˜¾å¼æŒ‡å®š</td></tr><tr><td>$\log_0 x$ æˆ– $\log_1 x$</td><td>åº•æ•°å¿…é¡» $&gt; 0$ ä¸” $\neq 1$</td><td>æ•°å­¦å®šä¹‰é™åˆ¶</td></tr></tbody></table><hr><h2 id="å…«ã€é€ŸæŸ¥é€Ÿè®°å¡"><a href="#å…«ã€é€ŸæŸ¥é€Ÿè®°å¡" class="headerlink" title="å…«ã€é€ŸæŸ¥é€Ÿè®°å¡"></a>å…«ã€é€ŸæŸ¥é€Ÿè®°å¡</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">## ğŸ”„ æ¢åº•å…¬å¼ï¼ˆèƒŒè¿™ä¸ªå°±å¤Ÿäº†ï¼ï¼‰</span></span><br><span class="line">log<span class="emphasis">_a(x) = log_</span>b(x) Ã· log<span class="emphasis">_b(a)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">## ğŸ”¢ ä¸‰åº•æ•°è½¬æ¢ç³»æ•°</span></span><br><span class="line"><span class="emphasis">ln(2) â‰ˆ 0.693147    | 1/ln(2) â‰ˆ 1.442695</span></span><br><span class="line"><span class="emphasis">ln(10) â‰ˆ 2.302585   | 1/ln(10) â‰ˆ 0.434294</span></span><br><span class="line"><span class="emphasis">logâ‚â‚€(2) â‰ˆ 0.301030 | 1/logâ‚â‚€(2) â‰ˆ 3.321928</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">## ğŸ“ è¿ç®—æ³•åˆ™å£è¯€</span></span><br><span class="line"><span class="emphasis">â€¢ ç§¯ â†’ å’Œï¼šlog(MN) = log M + log N</span></span><br><span class="line"><span class="emphasis">â€¢ å•† â†’ å·®ï¼šlog(M/N) = log M - log N  </span></span><br><span class="line"><span class="emphasis">â€¢ å¹‚ â†’ ç§¯ï¼šlog(M^k) = k Ã— log M</span></span><br><span class="line"><span class="emphasis">â€¢ æ ¹ â†’ é™¤ï¼šlog(â¿âˆšM) = (1/n) Ã— log M</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">## âš¡ æ ¸å¿ƒå®šä¹‰</span></span><br><span class="line"><span class="emphasis">y = log_</span>a(x)  &lt;==&gt;  a^y = x</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ¯ <strong>ç»ˆæå»ºè®®</strong>ï¼š  </p><ol><li><strong>ä»£ç ä¸­æ°¸è¿œæ˜¾å¼å†™æ¸…åº•æ•°</strong>ï¼ˆ<code>Log</code>&#x2F;<code>Log10</code>&#x2F;<code>Log2</code>ï¼‰  </li><li><strong>æ¢åº•æ—¶ä¼˜å…ˆç”¨ä¹˜æ³•</strong>ï¼ˆé¢„å­˜å€’æ•°å¸¸æ•°ï¼Œå¦‚ $\times 1.442695$ ä»£æ›¿ $\div 0.693147$ï¼‰  </li><li><strong>éªŒè¯è¾¹ç•Œ</strong>ï¼š$x \le 0$ æ—¶å¯¹æ•°æ— å®šä¹‰ï¼Œéœ€æå‰æ£€æŸ¥</li></ol></blockquote>]]></content>
      
      
      <categories>
          
          <category> Math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Math </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºå‘é‡çš„çº¿æ®µç®­å¤´ç»˜åˆ¶è¯¦è§£</title>
      <link href="/2026/02/20/vector-based-arrow-rendering-for-line-segments-md/"/>
      <url>/2026/02/20/vector-based-arrow-rendering-for-line-segments-md/</url>
      
        <content type="html"><![CDATA[<h3 id="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-20-21-08-05"><a href="#æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-20-21-08-05" class="headerlink" title="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-20 21:08:05"></a><strong>æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-20 21:08:05</strong></h3><p>æœ¬æ–‡é€šè¿‡è±†åŒ…è¾…åŠ©ç”Ÿæˆï¼</p><hr><p>æœ¬æ–‡å°†è¯¦ç»†è§£æå¦‚ä½•é€šè¿‡å‘é‡è¿ç®—åœ¨ SkiaSharp ä¸­ä¸ºçº¿æ®µç»˜åˆ¶ç®­å¤´ï¼Œå¹¶ç³»ç»Ÿè®²è§£è¿‡ç¨‹ä¸­æ¶‰åŠçš„å‘é‡æ•°å­¦åŸç†ä¸å®ç°é€»è¾‘ã€‚</p><h2 id="ä¸€ã€æ ¸å¿ƒéœ€æ±‚æ¦‚è¿°"><a href="#ä¸€ã€æ ¸å¿ƒéœ€æ±‚æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ ¸å¿ƒéœ€æ±‚æ¦‚è¿°"></a>ä¸€ã€æ ¸å¿ƒéœ€æ±‚æ¦‚è¿°</h2><p>ä½ å¸Œæœ›é€šè¿‡å‘é‡è¿ç®—ï¼Œåœ¨ SkiaSharp çš„ç»˜åˆ¶åœºæ™¯ä¸­ï¼Œä¸ºä»»æ„çº¿æ®µçš„ç«¯ç‚¹ï¼ˆç¤ºä¾‹ä¸­ä¸º startPos åˆ° endPos çš„çº¿æ®µç»ˆç‚¹ï¼‰ç»˜åˆ¶æ ‡å‡†çš„ç®­å¤´æ ·å¼ï¼Œæ ¸å¿ƒæ˜¯åˆ©ç”¨å‘é‡çš„å‡æ³•ã€å½’ä¸€åŒ–ã€æ³•å‘é‡ã€ç¼©æ”¾ã€åŠ æ³•ç­‰è¿ç®—å®ç°ç®­å¤´ä¸¤ä¸ªæ–œè¾¹çš„ç²¾å‡†å®šä½ã€‚</p><h2 id="äºŒã€å‘é‡åŸºç¡€å®šä¹‰"><a href="#äºŒã€å‘é‡åŸºç¡€å®šä¹‰" class="headerlink" title="äºŒã€å‘é‡åŸºç¡€å®šä¹‰"></a>äºŒã€å‘é‡åŸºç¡€å®šä¹‰</h2><h3 id="1-äºŒç»´å‘é‡ç»“æ„ä½“ï¼ˆPEVectorï¼‰"><a href="#1-äºŒç»´å‘é‡ç»“æ„ä½“ï¼ˆPEVectorï¼‰" class="headerlink" title="1. äºŒç»´å‘é‡ç»“æ„ä½“ï¼ˆPEVectorï¼‰"></a>1. äºŒç»´å‘é‡ç»“æ„ä½“ï¼ˆPEVectorï¼‰</h3><p>ç¤ºä¾‹ä¸­å®šä¹‰äº† PEVector ç»“æ„ä½“æ¥å°è£…äºŒç»´å‘é‡çš„å±æ€§ä¸æ ¸å¿ƒè¿ç®—ï¼Œæ ¸å¿ƒå±æ€§å’Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æˆå‘˜</th><th>è¯´æ˜</th><th>æ•°å­¦è¡¨è¾¾</th></tr></thead><tbody><tr><td>X&#x2F;Y</td><td>å‘é‡çš„xã€yåˆ†é‡</td><td>å‘é‡ $\vec{v} &#x3D; (X, Y)$</td></tr><tr><td>Length</td><td>å‘é‡çš„æ¨¡ï¼ˆé•¿åº¦ï¼‰</td><td>$|\vec{v}| &#x3D; \sqrt{X^2 + Y^2}$</td></tr><tr><td>Normalize()</td><td>å‘é‡å½’ä¸€åŒ–ï¼ˆè½¬ä¸ºå•ä½å‘é‡ï¼‰</td><td>$\hat{v} &#x3D; \frac{\vec{v}}{|\vec{v}|}$</td></tr><tr><td>GetNormal()</td><td>è·å–å‘é‡çš„æ³•å‘é‡</td><td>è‹¥ $\vec{v}&#x3D;(x,y)$ï¼Œåˆ™æ³•å‘é‡ä¸º $(y, -x)$</td></tr><tr><td>Add(v1, v2)</td><td>å‘é‡åŠ æ³•</td><td>$\vec{v_1} + \vec{v_2} &#x3D; (x_1+x_2, y_1+y_2)$</td></tr><tr><td>Sub(v1, v2)</td><td>å‘é‡å‡æ³•</td><td>$\vec{v_1} - \vec{v_2} &#x3D; (x_1-x_2, y_1-y_2)$</td></tr><tr><td>Scale(v, s)</td><td>å‘é‡ç¼©æ”¾</td><td>$s \cdot \vec{v} &#x3D; (s \cdot x, s \cdot y)$</td></tr></tbody></table><h3 id="2-å‘é‡å…³é”®æ¦‚å¿µè¡¥å……"><a href="#2-å‘é‡å…³é”®æ¦‚å¿µè¡¥å……" class="headerlink" title="2. å‘é‡å…³é”®æ¦‚å¿µè¡¥å……"></a>2. å‘é‡å…³é”®æ¦‚å¿µè¡¥å……</h3><ul><li><strong>å•ä½å‘é‡</strong>ï¼šæ¨¡ä¸º 1 çš„å‘é‡ï¼Œä»…è¡¨ç¤ºæ–¹å‘ï¼Œæ— é•¿åº¦å±æ€§ï¼Œå…¬å¼ï¼š$\hat{v} &#x3D; \frac{\vec{v}}{|\vec{v}|}$ï¼ˆè¦æ±‚ $|\vec{v}| \neq 0$ï¼‰ã€‚</li><li><strong>æ³•å‘é‡</strong>ï¼šä¸åŸå‘é‡å‚ç›´çš„å‘é‡ï¼ŒäºŒç»´å‘é‡ $(x,y)$ æœ‰ä¸¤ä¸ªæ­£äº¤æ³•å‘é‡ï¼š$(y, -x)$ å’Œ $(-y, x)$ï¼ˆä¸¤è€…æ–¹å‘ç›¸åï¼‰ã€‚</li><li><strong>å‘é‡å‡æ³•å‡ ä½•æ„ä¹‰</strong>ï¼š$\vec{v_1} - \vec{v_2}$ è¡¨ç¤ºä» $v_2$ æŒ‡å‘ $v_1$ çš„å‘é‡ã€‚</li></ul><h2 id="ä¸‰ã€ç®­å¤´ç»˜åˆ¶å®Œæ•´æµç¨‹ï¼ˆé™„æ•°å­¦å…¬å¼ï¼‰"><a href="#ä¸‰ã€ç®­å¤´ç»˜åˆ¶å®Œæ•´æµç¨‹ï¼ˆé™„æ•°å­¦å…¬å¼ï¼‰" class="headerlink" title="ä¸‰ã€ç®­å¤´ç»˜åˆ¶å®Œæ•´æµç¨‹ï¼ˆé™„æ•°å­¦å…¬å¼ï¼‰"></a>ä¸‰ã€ç®­å¤´ç»˜åˆ¶å®Œæ•´æµç¨‹ï¼ˆé™„æ•°å­¦å…¬å¼ï¼‰</h2><p>ä»¥ä¸‹æŒ‰ä»£ç æ‰§è¡Œé¡ºåºï¼Œæ‹†è§£ç®­å¤´ç»˜åˆ¶çš„æ¯ä¸€æ­¥é€»è¾‘ä¸å¯¹åº”çš„æ•°å­¦è¿ç®—ï¼š</p><h3 id="æ­¥éª¤1ï¼šå®šä¹‰åŸºç¡€å‚æ•°ä¸çº¿æ®µèµ·ç‚¹-ç»ˆç‚¹"><a href="#æ­¥éª¤1ï¼šå®šä¹‰åŸºç¡€å‚æ•°ä¸çº¿æ®µèµ·ç‚¹-ç»ˆç‚¹" class="headerlink" title="æ­¥éª¤1ï¼šå®šä¹‰åŸºç¡€å‚æ•°ä¸çº¿æ®µèµ·ç‚¹&#x2F;ç»ˆç‚¹"></a>æ­¥éª¤1ï¼šå®šä¹‰åŸºç¡€å‚æ•°ä¸çº¿æ®µèµ·ç‚¹&#x2F;ç»ˆç‚¹</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">int</span> Gap = <span class="number">10</span>; <span class="comment">// ç®­å¤´æ–œè¾¹çš„é•¿åº¦ï¼ˆåƒç´ ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> startPos = <span class="keyword">new</span> PEVector(<span class="number">200</span>, <span class="number">600</span>); <span class="comment">// çº¿æ®µèµ·ç‚¹ S(200,600)</span></span><br><span class="line"><span class="keyword">var</span> endPos = <span class="keyword">new</span> PEVector(<span class="number">600</span>, <span class="number">200</span>);   <span class="comment">// çº¿æ®µç»ˆç‚¹ E(600,200)</span></span><br><span class="line">canvas.DrawLine(startPos.ToSKPoint(), endPos.ToSKPoint(), linePaint); <span class="comment">// ç»˜åˆ¶åŸºç¡€çº¿æ®µ</span></span><br></pre></td></tr></table></figure><p>åŸºç¡€çº¿æ®µä¸ºï¼šä»ç‚¹ $S(x_s, y_s)$ åˆ°ç‚¹ $E(x_e, y_e)$ çš„ç›´çº¿æ®µã€‚</p><h3 id="æ­¥éª¤2ï¼šè®¡ç®—çº¿æ®µçš„æ–¹å‘å‘é‡"><a href="#æ­¥éª¤2ï¼šè®¡ç®—çº¿æ®µçš„æ–¹å‘å‘é‡" class="headerlink" title="æ­¥éª¤2ï¼šè®¡ç®—çº¿æ®µçš„æ–¹å‘å‘é‡"></a>æ­¥éª¤2ï¼šè®¡ç®—çº¿æ®µçš„æ–¹å‘å‘é‡</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> direction = PEVector.Sub(endPos, startPos); <span class="comment">// ä»èµ·ç‚¹æŒ‡å‘ç»ˆç‚¹çš„æ–¹å‘å‘é‡</span></span><br></pre></td></tr></table></figure><p>æ•°å­¦å…¬å¼ï¼š<br>$$\vec{direction} &#x3D; E - S &#x3D; (x_e - x_s, y_e - y_s)$$<br>å‡ ä½•æ„ä¹‰ï¼šè¯¥å‘é‡å®Œå…¨è¡¨ç¤ºçº¿æ®µSEçš„æ–¹å‘å’Œé•¿åº¦ã€‚</p><h3 id="æ­¥éª¤3ï¼šå°†æ–¹å‘å‘é‡å½’ä¸€åŒ–ï¼ˆè½¬ä¸ºå•ä½å‘é‡ï¼‰"><a href="#æ­¥éª¤3ï¼šå°†æ–¹å‘å‘é‡å½’ä¸€åŒ–ï¼ˆè½¬ä¸ºå•ä½å‘é‡ï¼‰" class="headerlink" title="æ­¥éª¤3ï¼šå°†æ–¹å‘å‘é‡å½’ä¸€åŒ–ï¼ˆè½¬ä¸ºå•ä½å‘é‡ï¼‰"></a>æ­¥éª¤3ï¼šå°†æ–¹å‘å‘é‡å½’ä¸€åŒ–ï¼ˆè½¬ä¸ºå•ä½å‘é‡ï¼‰</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">direction.Normalize(); <span class="comment">// å½’ä¸€åŒ–å¾—åˆ°å•ä½æ–¹å‘å‘é‡</span></span><br></pre></td></tr></table></figure><p>æ•°å­¦å…¬å¼ï¼š<br>$$\hat{direction} &#x3D; \frac{\vec{direction}}{|\vec{direction}|} &#x3D; \frac{(x_e - x_s, y_e - y_s)}{\sqrt{(x_e - x_s)^2 + (y_e - y_s)^2}}$$<br>ä½œç”¨ï¼šæ¶ˆé™¤é•¿åº¦å½±å“ï¼Œä»…ä¿ç•™æ–¹å‘ä¿¡æ¯ï¼Œæ–¹ä¾¿åç»­æŒ‰å›ºå®šé•¿åº¦ï¼ˆGapï¼‰åç§»ã€‚</p><h3 id="æ­¥éª¤4ï¼šè®¡ç®—ç®­å¤´ä¸­å¿ƒç‚¹ï¼ˆç®­å¤´æ–œè¾¹çš„äº¤æ±‡èµ·ç‚¹ï¼‰"><a href="#æ­¥éª¤4ï¼šè®¡ç®—ç®­å¤´ä¸­å¿ƒç‚¹ï¼ˆç®­å¤´æ–œè¾¹çš„äº¤æ±‡èµ·ç‚¹ï¼‰" class="headerlink" title="æ­¥éª¤4ï¼šè®¡ç®—ç®­å¤´ä¸­å¿ƒç‚¹ï¼ˆç®­å¤´æ–œè¾¹çš„äº¤æ±‡èµ·ç‚¹ï¼‰"></a>æ­¥éª¤4ï¼šè®¡ç®—ç®­å¤´ä¸­å¿ƒç‚¹ï¼ˆç®­å¤´æ–œè¾¹çš„äº¤æ±‡èµ·ç‚¹ï¼‰</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> endHeadCenter = PEVector.Sub(endPos, PEVector.Scale(direction, Gap));</span><br></pre></td></tr></table></figure><p>æ•°å­¦å…¬å¼ï¼š<br>$$P_{center} &#x3D; E - Gap \cdot \hat{direction}$$<br>å‡ ä½•æ„ä¹‰ï¼šä»çº¿æ®µç»ˆç‚¹ Eï¼Œæ²¿ç€çº¿æ®µåæ–¹å‘ï¼ˆ-$\hat{direction}$ï¼‰ç§»åŠ¨ Gap åƒç´ ï¼Œå¾—åˆ°ç®­å¤´çš„ä¸­å¿ƒç‚¹ $P_{center}$ï¼Œç®­å¤´çš„ä¸¤ä¸ªæ–œè¾¹å°†ä»è¯¥ç‚¹å‘Eçš„å·¦å³ä¸¤ä¾§å»¶ä¼¸ã€‚</p><h3 id="æ­¥éª¤5ï¼šè®¡ç®—å·¦ä¾§æ–œè¾¹çš„ç«¯ç‚¹"><a href="#æ­¥éª¤5ï¼šè®¡ç®—å·¦ä¾§æ–œè¾¹çš„ç«¯ç‚¹" class="headerlink" title="æ­¥éª¤5ï¼šè®¡ç®—å·¦ä¾§æ–œè¾¹çš„ç«¯ç‚¹"></a>æ­¥éª¤5ï¼šè®¡ç®—å·¦ä¾§æ–œè¾¹çš„ç«¯ç‚¹</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–æ–¹å‘å‘é‡çš„æ³•å‘é‡ï¼ˆå·¦æ–¹å‘ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> directionToLeft = direction.GetNormal(); </span><br><span class="line"><span class="comment">// è®¡ç®—å·¦ä¾§ç«¯ç‚¹ï¼šä¸­å¿ƒç‚¹ + å·¦æ³•å‘é‡Ã—Gap</span></span><br><span class="line"><span class="keyword">var</span> leftEndHeadPos = PEVector.Add(endHeadCenter, PEVector.Scale(directionToLeft, Gap));</span><br><span class="line"><span class="comment">// ç»˜åˆ¶å·¦ä¾§æ–œè¾¹ï¼ˆä»å·¦ç«¯ç‚¹åˆ°ç»ˆç‚¹Eï¼‰</span></span><br><span class="line">canvas.DrawLine(leftEndHeadPos.ToSKPoint(), endPos.ToSKPoint(), linePaint);</span><br></pre></td></tr></table></figure><p>æ•°å­¦å…¬å¼ï¼š<br>$$\vec{n_{left}} &#x3D; (y_{\hat{direction}}, -x_{\hat{direction}}) \quad \text{ï¼ˆå·¦æ³•å‘é‡ï¼‰}$$<br>$$P_{left} &#x3D; P_{center} + Gap \cdot \vec{n_{left}}$$<br>å‡ ä½•æ„ä¹‰ï¼šå·¦æ³•å‘é‡ä¸åŸæ–¹å‘å‘é‡å‚ç›´ï¼Œæ²¿è¯¥æ–¹å‘åç§» Gap åƒç´ ï¼Œå¾—åˆ°ç®­å¤´å·¦ä¾§æ–œè¾¹çš„ç«¯ç‚¹ $P_{left}$ï¼Œè¿æ¥ $P_{left}$ å’Œ E å³ç®­å¤´å·¦æ–œè¾¹ã€‚</p><h3 id="æ­¥éª¤6ï¼šè®¡ç®—å³ä¾§æ–œè¾¹çš„ç«¯ç‚¹"><a href="#æ­¥éª¤6ï¼šè®¡ç®—å³ä¾§æ–œè¾¹çš„ç«¯ç‚¹" class="headerlink" title="æ­¥éª¤6ï¼šè®¡ç®—å³ä¾§æ–œè¾¹çš„ç«¯ç‚¹"></a>æ­¥éª¤6ï¼šè®¡ç®—å³ä¾§æ–œè¾¹çš„ç«¯ç‚¹</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–æ–¹å‘å‘é‡çš„å³æ³•å‘é‡ï¼ˆå·¦æ³•å‘é‡å–åï¼‰</span></span><br><span class="line"><span class="keyword">var</span> directionToRight = PEVector.Scale(direction.GetNormal(), <span class="number">-1</span>);</span><br><span class="line"><span class="comment">// è®¡ç®—å³ä¾§ç«¯ç‚¹ï¼šä¸­å¿ƒç‚¹ + å³æ³•å‘é‡Ã—Gap</span></span><br><span class="line"><span class="keyword">var</span> rightEndHeadPos = PEVector.Add(endHeadCenter, PEVector.Scale(directionToRight, Gap));</span><br><span class="line"><span class="comment">// ç»˜åˆ¶å³ä¾§æ–œè¾¹ï¼ˆä»å³ç«¯ç‚¹åˆ°ç»ˆç‚¹Eï¼‰</span></span><br><span class="line">canvas.DrawLine(rightEndHeadPos.ToSKPoint(), endPos.ToSKPoint(), linePaint);</span><br></pre></td></tr></table></figure><p>æ•°å­¦å…¬å¼ï¼š<br>$$\vec{n_{right}} &#x3D; -\vec{n_{left}} &#x3D; (-y_{\hat{direction}}, x_{\hat{direction}}) \quad \text{ï¼ˆå³æ³•å‘é‡ï¼‰}$$<br>$$P_{right} &#x3D; P_{center} + Gap \cdot \vec{n_{right}}$$<br>å‡ ä½•æ„ä¹‰ï¼šå³æ³•å‘é‡ä¸å·¦æ³•å‘é‡æ–¹å‘ç›¸åï¼Œæ²¿è¯¥æ–¹å‘åç§» Gap åƒç´ ï¼Œå¾—åˆ°ç®­å¤´å³ä¾§æ–œè¾¹çš„ç«¯ç‚¹ $P_{right}$ï¼Œè¿æ¥ $P_{right}$ å’Œ E å³ç®­å¤´å³æ–œè¾¹ã€‚</p><h3 id="æ­¥éª¤7ï¼ˆå¯é€‰ï¼‰ï¼šç»˜åˆ¶è¾…åŠ©å®šä½åœ†"><a href="#æ­¥éª¤7ï¼ˆå¯é€‰ï¼‰ï¼šç»˜åˆ¶è¾…åŠ©å®šä½åœ†" class="headerlink" title="æ­¥éª¤7ï¼ˆå¯é€‰ï¼‰ï¼šç»˜åˆ¶è¾…åŠ©å®šä½åœ†"></a>æ­¥éª¤7ï¼ˆå¯é€‰ï¼‰ï¼šç»˜åˆ¶è¾…åŠ©å®šä½åœ†</h3><p>é€šè¿‡ç»˜åˆ¶çº¢&#x2F;ç»¿è‰²å°åœ†æ ‡è®°å…³é”®ç‚¹ä½ï¼ˆ$P_{center}$ã€$P_{left}$ã€$P_{right}$ï¼‰ï¼Œä¾¿äºè°ƒè¯•ç®­å¤´ä½ç½®ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ShowCircle)</span><br><span class="line">&#123;</span><br><span class="line">    canvas.DrawCircle(endHeadCenter.ToSKPoint(), <span class="number">3</span>, <span class="keyword">new</span> SKPaint &#123; Color = SKColors.Red &#125;); <span class="comment">// ä¸­å¿ƒç‚¹ï¼ˆçº¢ï¼‰</span></span><br><span class="line">    canvas.DrawCircle(leftEndHeadPos.ToSKPoint(), <span class="number">3</span>, <span class="keyword">new</span> SKPaint &#123; Color = SKColors.Green &#125;); <span class="comment">// å·¦ç«¯ç‚¹ï¼ˆç»¿ï¼‰</span></span><br><span class="line">    canvas.DrawCircle(rightEndHeadPos.ToSKPoint(), <span class="number">3</span>, <span class="keyword">new</span> SKPaint &#123; Color = SKColors.Green &#125;); <span class="comment">// å³ç«¯ç‚¹ï¼ˆç»¿ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››ã€å®Œæ•´ä»£ç æ•´åˆ"><a href="#å››ã€å®Œæ•´ä»£ç æ•´åˆ" class="headerlink" title="å››ã€å®Œæ•´ä»£ç æ•´åˆ"></a>å››ã€å®Œæ•´ä»£ç æ•´åˆ</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> SkiaSharp;</span><br><span class="line"><span class="keyword">using</span> SkiaSharp.Views.Desktop;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> PEVector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">double</span> X;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">double</span> Y;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PEVector</span>()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PEVector</span>(<span class="params"><span class="built_in">double</span> x, <span class="built_in">double</span> y</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        X = x;</span><br><span class="line">        Y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é‡çš„æ¨¡ï¼ˆé•¿åº¦ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="built_in">double</span> Length =&gt; Math.Sqrt(X * X + Y * Y);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> å½’ä¸€åŒ–ï¼šå°†å‘é‡è½¬ä¸ºå•ä½å‘é‡ï¼ˆæ¨¡â‰ˆ1ï¼‰</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Normalize</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> length = Length;</span><br><span class="line">        <span class="keyword">if</span> (length &lt; <span class="number">1e-9</span>) <span class="keyword">return</span>; <span class="comment">// é¿å…é™¤ä»¥0</span></span><br><span class="line">        X /= length;</span><br><span class="line">        Y /= length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> è·å–å‘é‡çš„æ³•å‘é‡ï¼ˆå‚ç›´å‘é‡ï¼‰ï¼š(x,y) â†’ (y, -x)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PEVector <span class="title">GetNormal</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PEVector &#123; X = Y, Y = -X &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> å‘é‡åŠ æ³•</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PEVector <span class="title">Add</span>(<span class="params">PEVector v1, PEVector v2</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PEVector &#123; X = v1.X + v2.X, Y = v1.Y + v2.Y &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> å‘é‡å‡æ³•</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PEVector <span class="title">Sub</span>(<span class="params">PEVector v1, PEVector v2</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PEVector &#123; X = v1.X - v2.X, Y = v1.Y - v2.Y &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> å‘é‡ç¼©æ”¾</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PEVector <span class="title">Scale</span>(<span class="params">PEVector v, <span class="built_in">double</span> scale</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PEVector &#123; X = v.X * scale, Y = v.Y * scale &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PEVectorExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> å‘é‡è½¬ä¸ºSkiaSharpçš„ç‚¹</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SKPoint <span class="title">ToSKPoint</span>(<span class="params"><span class="keyword">this</span> PEVector v</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SKPoint((<span class="built_in">float</span>)v.X, (<span class="built_in">float</span>)v.Y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArrowDrawing</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SKElement_PaintSurface</span>(<span class="params"><span class="built_in">object</span> sender, SKPaintSurfaceEventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">int</span> Gap = <span class="number">10</span>; <span class="comment">// ç®­å¤´å°ºå¯¸ï¼ˆåƒç´ ï¼‰</span></span><br><span class="line">        <span class="built_in">bool</span> ShowCircle = <span class="literal">false</span>; <span class="comment">// æ˜¯å¦æ˜¾ç¤ºè¾…åŠ©å®šä½åœ†</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> canvas = e.Surface.Canvas;</span><br><span class="line">        canvas.Clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ç”»ç¬”</span></span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> linePaint = <span class="keyword">new</span> SKPaint &#123; Color = SKColors.Black, StrokeWidth = <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. å®šä¹‰çº¿æ®µèµ·ç‚¹å’Œç»ˆç‚¹</span></span><br><span class="line">        <span class="keyword">var</span> startPos = <span class="keyword">new</span> PEVector(<span class="number">200</span>, <span class="number">600</span>);</span><br><span class="line">        <span class="keyword">var</span> endPos = <span class="keyword">new</span> PEVector(<span class="number">600</span>, <span class="number">200</span>);</span><br><span class="line">        <span class="comment">// ç»˜åˆ¶åŸºç¡€çº¿æ®µ</span></span><br><span class="line">        canvas.DrawLine(startPos.ToSKPoint(), endPos.ToSKPoint(), linePaint);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è®¡ç®—ä»èµ·ç‚¹åˆ°ç»ˆç‚¹çš„æ–¹å‘å‘é‡</span></span><br><span class="line">        <span class="keyword">var</span> direction = PEVector.Sub(endPos, startPos);</span><br><span class="line">        <span class="comment">// 3. å½’ä¸€åŒ–æ–¹å‘å‘é‡ï¼ˆè½¬ä¸ºå•ä½å‘é‡ï¼‰</span></span><br><span class="line">        direction.Normalize();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. è®¡ç®—ç®­å¤´ä¸­å¿ƒç‚¹ï¼ˆä»ç»ˆç‚¹åæ–¹å‘åç§»Gapï¼‰</span></span><br><span class="line">        <span class="keyword">var</span> endHeadCenter = PEVector.Sub(endPos, PEVector.Scale(direction, Gap));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. è®¡ç®—ç®­å¤´å·¦ä¾§æ–œè¾¹ç«¯ç‚¹å¹¶ç»˜åˆ¶</span></span><br><span class="line">        <span class="keyword">var</span> directionToLeft = direction.GetNormal(); <span class="comment">// å·¦æ³•å‘é‡</span></span><br><span class="line">        <span class="keyword">var</span> leftEndHeadPos = PEVector.Add(endHeadCenter, PEVector.Scale(directionToLeft, Gap));</span><br><span class="line">        canvas.DrawLine(leftEndHeadPos.ToSKPoint(), endPos.ToSKPoint(), linePaint);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. è®¡ç®—ç®­å¤´å³ä¾§æ–œè¾¹ç«¯ç‚¹å¹¶ç»˜åˆ¶</span></span><br><span class="line">        <span class="keyword">var</span> directionToRight = PEVector.Scale(direction.GetNormal(), <span class="number">-1</span>); <span class="comment">// å³æ³•å‘é‡</span></span><br><span class="line">        <span class="keyword">var</span> rightEndHeadPos = PEVector.Add(endHeadCenter, PEVector.Scale(directionToRight, Gap));</span><br><span class="line">        canvas.DrawLine(rightEndHeadPos.ToSKPoint(), endPos.ToSKPoint(), linePaint);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯é€‰ï¼šç»˜åˆ¶è¾…åŠ©å®šä½åœ†</span></span><br><span class="line">        <span class="keyword">if</span> (ShowCircle)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> redPaint = <span class="keyword">new</span> SKPaint &#123; Color = SKColors.Red, StrokeWidth = <span class="number">1</span>, Style = SKPaintStyle.Fill &#125;;</span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> greenPaint = <span class="keyword">new</span> SKPaint &#123; Color = SKColors.Green, StrokeWidth = <span class="number">1</span>, Style = SKPaintStyle.Fill &#125;;</span><br><span class="line">            canvas.DrawCircle(endHeadCenter.ToSKPoint(), <span class="number">3</span>, redPaint);</span><br><span class="line">            canvas.DrawCircle(leftEndHeadPos.ToSKPoint(), <span class="number">3</span>, greenPaint);</span><br><span class="line">            canvas.DrawCircle(rightEndHeadPos.ToSKPoint(), <span class="number">3</span>, greenPaint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol><li><strong>æ ¸å¿ƒå‘é‡è¿ç®—</strong>ï¼šç®­å¤´ç»˜åˆ¶çš„å…³é”®æ˜¯é€šè¿‡<strong>å‘é‡å‡æ³•</strong>è·å–æ–¹å‘ã€<strong>å½’ä¸€åŒ–</strong>æ¶ˆé™¤é•¿åº¦å½±å“ã€<strong>æ³•å‘é‡</strong>è·å–å‚ç›´æ–¹å‘ã€<strong>ç¼©æ”¾+åŠ æ³•</strong>å®ç°ç‚¹ä½åç§»ï¼›</li><li><strong>å…³é”®å…¬å¼</strong>ï¼š<ul><li>æ–¹å‘å‘é‡ï¼š$\vec{direction} &#x3D; E - S$</li><li>å•ä½å‘é‡ï¼š$\hat{direction} &#x3D; \vec{direction} &#x2F; |\vec{direction}|$</li><li>ç®­å¤´ä¸­å¿ƒç‚¹ï¼š$P_{center} &#x3D; E - Gap \cdot \hat{direction}$</li><li>å·¦å³ç«¯ç‚¹ï¼š$P_{left&#x2F;right} &#x3D; P_{center} Â± Gap \cdot (y_{\hat{direction}}, -x_{\hat{direction}})$ï¼›</li></ul></li><li><strong>æ‰©å±•å»ºè®®</strong>ï¼šå¯é€šè¿‡è°ƒæ•´ Gap å‚æ•°æ§åˆ¶ç®­å¤´å¤§å°ï¼Œè‹¥éœ€ä¸ºçº¿æ®µèµ·ç‚¹ç»˜åˆ¶ç®­å¤´ï¼Œä»…éœ€åè½¬æ–¹å‘å‘é‡çš„è®¡ç®—é€»è¾‘ï¼ˆ$\vec{direction} &#x3D; S - E$ï¼‰å³å¯ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
          <category> Vector </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> SkiaSharp </tag>
            
            <tag> Vector </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å°½é‡ä½¿ç”¨ stackalloc è¡¨è¾¾å¼</title>
      <link href="/2026/01/24/perfer-stackalloc-usage/"/>
      <url>/2026/01/24/perfer-stackalloc-usage/</url>
      
        <content type="html"><![CDATA[<h3 id="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-20-19-54-51"><a href="#æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-20-19-54-51" class="headerlink" title="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-20 19:54:51"></a><strong>æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-20 19:54:51</strong></h3><p>æœ¬æ–‡é€šè¿‡è±†åŒ…+ChatGptè¾…åŠ©ç”Ÿæˆï¼</p><hr><p>åœ¨ .NET æ€§èƒ½ä¼˜åŒ–é¢†åŸŸï¼Œstackalloc æ˜¯ç»•ä¸å¼€çš„æ ¸å¿ƒå…³é”®è¯ã€‚å®ƒå…è®¸å¼€å‘è€…<strong>ç›´æ¥åœ¨å½“å‰æ–¹æ³•çš„æ ˆå¸§ä¸Šåˆ†é…è¿ç»­å†…å­˜</strong>ï¼Œå½»åº•ç»•è¿‡ GC ç®¡ç†ã€é¿å…å †åˆ†é…å¼€é”€ï¼Œæ›´æ˜¯ Span&lt;T&gt; ç­‰é«˜æ€§èƒ½ API çš„åº•å±‚åŸºçŸ³ã€‚</p><p>ä½† stackalloc çŠ¹å¦‚ä¸€æŠŠâ€œåŒåˆƒå‰‘â€ï¼šç”¨å¾—å¥½èƒ½æˆä¸ºæ€§èƒ½é£™å‡çš„åˆ©å™¨ï¼Œç”¨ä¸å¥½åˆ™å¯èƒ½å¼•å‘ StackOverflowException æˆ–éšè—çš„ç”Ÿå‘½å‘¨æœŸ bugã€‚æœ¬æ–‡å°†ç³»ç»Ÿæ‹†è§£å…¶æ ¸å¿ƒé€»è¾‘ã€ä¼˜åŠ¿ã€é™åˆ¶ï¼Œå¹¶ç»™å‡ºâ€œæ ˆ+å¯¹è±¡æ± â€çš„æ¨èä½¿ç”¨æ¨¡å¼ã€‚</p><h2 id="ä¸€ã€stackalloc-æ ¸å¿ƒæ¦‚è¿°"><a href="#ä¸€ã€stackalloc-æ ¸å¿ƒæ¦‚è¿°" class="headerlink" title="ä¸€ã€stackalloc æ ¸å¿ƒæ¦‚è¿°"></a>ä¸€ã€stackalloc æ ¸å¿ƒæ¦‚è¿°</h2><h3 id="1-ä»€ä¹ˆæ˜¯-stackallocï¼Ÿ"><a href="#1-ä»€ä¹ˆæ˜¯-stackallocï¼Ÿ" class="headerlink" title="1. ä»€ä¹ˆæ˜¯ stackallocï¼Ÿ"></a>1. ä»€ä¹ˆæ˜¯ stackallocï¼Ÿ</h3><p>stackalloc æ˜¯ .NET ä¸­çš„<strong>å†…å­˜åˆ†é…è¡¨è¾¾å¼</strong>ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯åœ¨<strong>å½“å‰æ–¹æ³•çš„è°ƒç”¨æ ˆï¼ˆstack frameï¼‰ä¸Š</strong>åˆ†é…ä¸€æ®µè¿ç»­å†…å­˜ã€‚</p><p>å…¶æ ¸å¿ƒè¯­ä¹‰ï¼ˆå¿…é¡»ç‰¢è®°ï¼‰ï¼š</p><ul><li>åˆ†é…ä½ç½®ï¼šä»…é™å½“å‰çº¿ç¨‹çš„è°ƒç”¨æ ˆï¼Œè€Œéæ‰˜ç®¡å †ï¼›</li><li>ç”Ÿå‘½å‘¨æœŸï¼šä¸å½“å‰æ–¹æ³•ç»‘å®šï¼Œæ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œæ ˆæŒ‡é’ˆå›é€€ï¼Œå†…å­˜è‡ªåŠ¨é‡Šæ”¾ï¼›</li><li>é‡Šæ”¾æ–¹å¼ï¼šæ— éœ€æ‰‹åŠ¨é‡Šæ”¾ï¼Œä¹Ÿä¸å…è®¸æ˜¾å¼é‡Šæ”¾ï¼›</li><li>GC äº¤äº’ï¼šå®Œå…¨ä¸å— GC ç®¡ç†ï¼ŒGC æ— æ³•æ„ŸçŸ¥è¿™æ®µå†…å­˜ï¼›</li><li>å†…å­˜å›ºå®šï¼šæ— éœ€ fixed å…³é”®å­—ï¼Œæ ˆå†…å­˜å¤©ç„¶ä¸ä¼šè¢« GC ç§»åŠ¨ã€‚</li></ul><p>è¿™æ˜¯å®ƒä¸ new T[] å †åˆ†é…çš„æœ¬è´¨åŒºåˆ«â€”â€”å †åˆ†é…éœ€ GC è·Ÿè¸ªã€å›æ”¶ï¼Œè€Œæ ˆåˆ†é…æ˜¯â€œå³ç”¨å³å¼ƒâ€çš„ç¡®å®šæ€§å†…å­˜æ“ä½œã€‚</p><h3 id="2-ä¸¤ç§åŸºæœ¬åˆ›å»ºæ–¹å¼"><a href="#2-ä¸¤ç§åŸºæœ¬åˆ›å»ºæ–¹å¼" class="headerlink" title="2. ä¸¤ç§åŸºæœ¬åˆ›å»ºæ–¹å¼"></a>2. ä¸¤ç§åŸºæœ¬åˆ›å»ºæ–¹å¼</h3><p>stackalloc æ”¯æŒä¸¤ç§ä½¿ç”¨å½¢å¼ï¼Œè¯­ä¹‰å±‚çº§å’Œé€‚ç”¨åœºæ™¯ä¸åŒï¼Œç°ä»£å¼€å‘æ›´æ¨èç¬¬ä¸€ç§ï¼š</p><h4 id="2-1-Span-stackallocï¼ˆç°ä»£æ¨èï¼‰"><a href="#2-1-Span-stackallocï¼ˆç°ä»£æ¨èï¼‰" class="headerlink" title="2-1. Span + stackallocï¼ˆç°ä»£æ¨èï¼‰"></a>2-1. Span<T> + stackallocï¼ˆç°ä»£æ¨èï¼‰</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Span&lt;<span class="built_in">int</span>&gt; buffer = <span class="keyword">stackalloc</span> <span class="built_in">int</span>[] &#123; <span class="number">1</span>, <span class="number">2</span> &#125;;</span><br></pre></td></tr></table></figure><ul><li>æœ¬è´¨ï¼šåœ¨æ ˆä¸Šåˆ†é… int[2] æ•°ç»„ï¼Œè¿”å› Span&lt;T&gt; ä½œä¸ºå†…å­˜è§†å›¾ï¼›</li><li>ä¼˜åŠ¿ï¼šç¼–è¯‘å™¨å¼ºåˆ¶ç”Ÿå‘½å‘¨æœŸå®‰å…¨æ£€æŸ¥ï¼Œæ— éœ€ unsafe å—ï¼Œå¯åœ¨å®‰å…¨ä»£ç ä¸­ä½¿ç”¨ï¼›</li><li>é€‚ç”¨åœºæ™¯ï¼šç»å¤§å¤šæ•°é«˜æ€§èƒ½å†…å­˜æ“ä½œåœºæ™¯ï¼Œæ˜¯å½“å‰ .NET æ¨èçš„ä¸»æµç”¨æ³•ã€‚</li></ul><h4 id="2-2-è£¸æŒ‡é’ˆå½¢å¼ï¼ˆåº•å±‚-ä¸å®‰å…¨åœºæ™¯ï¼‰"><a href="#2-2-è£¸æŒ‡é’ˆå½¢å¼ï¼ˆåº•å±‚-ä¸å®‰å…¨åœºæ™¯ï¼‰" class="headerlink" title="2-2. è£¸æŒ‡é’ˆå½¢å¼ï¼ˆåº•å±‚&#x2F;ä¸å®‰å…¨åœºæ™¯ï¼‰"></a>2-2. è£¸æŒ‡é’ˆå½¢å¼ï¼ˆåº•å±‚&#x2F;ä¸å®‰å…¨åœºæ™¯ï¼‰</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsafe</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span>* buffer = <span class="keyword">stackalloc</span> <span class="built_in">int</span>[] &#123; <span class="number">1</span>, <span class="number">2</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æœ¬è´¨ï¼šç›´æ¥è¿”å›æŒ‡å‘æ ˆå†…å­˜çš„è£¸æŒ‡é’ˆï¼ˆint*ï¼‰ï¼›</li><li>é£é™©ï¼šç¼–è¯‘å™¨ä¸å†åšç”Ÿå‘½å‘¨æœŸæ£€æŸ¥ï¼Œææ˜“å‡ºç°<strong>æ‚¬å‚æŒ‡é’ˆï¼ˆè®¿é—®å·²é‡Šæ”¾çš„æ ˆå†…å­˜ï¼‰</strong>ï¼›</li><li>é€‚ç”¨åœºæ™¯ï¼šä»…ç”¨äºåº•å±‚éæ‰˜ç®¡äº¤äº’ã€æè‡´æ€§èƒ½ä¼˜åŒ–ç­‰ç‰¹æ®Šåœºæ™¯ï¼Œéœ€æ‰‹åŠ¨ä¿è¯å†…å­˜å®‰å…¨ã€‚</li></ul><blockquote><p>ç°ä»£ .NET å¼€å‘å…±è¯†ï¼šstackalloc å‡ ä¹æ€»æ˜¯ä¸ Span&lt;T&gt; é…åˆä½¿ç”¨ï¼Œé¿å…ç›´æ¥æ“ä½œè£¸æŒ‡é’ˆã€‚</p></blockquote><h2 id="äºŒã€stackalloc-çš„æ ¸å¿ƒä¼˜åŠ¿"><a href="#äºŒã€stackalloc-çš„æ ¸å¿ƒä¼˜åŠ¿" class="headerlink" title="äºŒã€stackalloc çš„æ ¸å¿ƒä¼˜åŠ¿"></a>äºŒã€stackalloc çš„æ ¸å¿ƒä¼˜åŠ¿</h2><h3 id="1-å½»åº•é¿å…å †åˆ†é…å¼€é”€"><a href="#1-å½»åº•é¿å…å †åˆ†é…å¼€é”€" class="headerlink" title="1. å½»åº•é¿å…å †åˆ†é…å¼€é”€"></a>1. å½»åº•é¿å…å †åˆ†é…å¼€é”€</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Span&lt;<span class="built_in">byte</span>&gt; buffer = <span class="keyword">stackalloc</span> <span class="built_in">byte</span>[<span class="number">256</span>];</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸ä¼šäº§ç”Ÿä»»ä½•å †åˆ†é…ç›¸å…³çš„å¼€é”€ï¼š</p><ul><li>æ—  newobj æŒ‡ä»¤ï¼ˆå †åˆ†é…çš„æ ¸å¿ƒæŒ‡ä»¤ï¼‰ï¼›</li><li>æ—  GC è·Ÿè¸ªæˆæœ¬ï¼ˆGC æ— éœ€è®°å½•è¿™æ®µå†…å­˜ï¼‰ï¼›</li><li>æ— å¯¹è±¡ä»£é™…æ™‹å‡ï¼ˆå †åˆ†é…çš„å°å¯¹è±¡æ˜“è¿›å…¥ Gen 0ï¼Œè§¦å‘é¢‘ç¹ GCï¼‰ã€‚</li></ul><p>å¯¹æ¯”å †åˆ†é…ï¼ˆnew byte[256]ï¼‰ï¼Œæ ˆåˆ†é…çœå»äº†â€œæŸ¥æ‰¾å †ç©ºé—²åŒºåŸŸã€å†™å…¥å¯¹è±¡å¤´ã€é›¶åˆå§‹åŒ–å†…å­˜â€ç­‰æ­¥éª¤ï¼Œåœ¨é«˜é¢‘è°ƒç”¨åœºæ™¯ï¼ˆå¦‚å¾ªç¯å†…åˆ›å»ºä¸´æ—¶ç¼“å†²åŒºï¼‰ä¸­æ€§èƒ½ä¼˜åŠ¿æå…¶æ˜æ˜¾ã€‚</p><h3 id="2-ä¸-Span-å¤©ç„¶å¥‘åˆ"><a href="#2-ä¸-Span-å¤©ç„¶å¥‘åˆ" class="headerlink" title="2. ä¸ Span å¤©ç„¶å¥‘åˆ"></a>2. ä¸ Span<T> å¤©ç„¶å¥‘åˆ</h3><p>Span&lt;T&gt; æœ¬èº«æ˜¯ <code>ref struct</code> ç±»å‹ï¼Œè®¾è®¡ç›®æ ‡å°±æ˜¯â€œå®‰å…¨æ“ä½œè¿ç»­å†…å­˜â€ï¼Œå…¶ç‰¹æ€§ä¸ stackalloc å®Œç¾åŒ¹é…ï¼š</p><ul><li>Span&lt;T&gt; ä¸èƒ½è£…ç®±ã€ä¸èƒ½é€ƒé€¸åˆ°å †ã€ä¸èƒ½è·¨ async&#x2F;awaitï¼›</li><li>ç¼–è¯‘å™¨å¼ºåˆ¶ Span&lt;T&gt; çš„ç”Ÿå‘½å‘¨æœŸä¸è¶…è¿‡å…¶å¼•ç”¨çš„å†…å­˜ï¼ˆå¦‚æ ˆå†…å­˜ï¼‰ï¼›</li><li>ä¸¤è€…ç»“åˆæ—¢ä¿ç•™äº†æ ˆåˆ†é…çš„é«˜æ€§èƒ½ï¼Œåˆé€šè¿‡ Span&lt;T&gt; çš„å®‰å…¨æ£€æŸ¥é¿å…äº†å†…å­˜é£é™©ã€‚</li></ul><p>è¿™ç§ç»„åˆæ˜¯ .NET é«˜æ€§èƒ½å†…å­˜æ“ä½œçš„â€œé»„é‡‘æ­æ¡£â€ï¼Œå¹¿æ³›åº”ç”¨äº System.Text.Jsonã€Socketã€Pipelines ç­‰åº•å±‚ API ä¸­ã€‚</p><h2 id="ä¸‰ã€stackalloc-çš„é™åˆ¶ä¸æ½œåœ¨é£é™©"><a href="#ä¸‰ã€stackalloc-çš„é™åˆ¶ä¸æ½œåœ¨é£é™©" class="headerlink" title="ä¸‰ã€stackalloc çš„é™åˆ¶ä¸æ½œåœ¨é£é™©"></a>ä¸‰ã€stackalloc çš„é™åˆ¶ä¸æ½œåœ¨é£é™©</h2><h3 id="1-æ ˆç©ºé—´æœ‰é™ï¼Œè¶…å¤§åˆ†é…æ˜“æº¢å‡º"><a href="#1-æ ˆç©ºé—´æœ‰é™ï¼Œè¶…å¤§åˆ†é…æ˜“æº¢å‡º" class="headerlink" title="1. æ ˆç©ºé—´æœ‰é™ï¼Œè¶…å¤§åˆ†é…æ˜“æº¢å‡º"></a>1. æ ˆç©ºé—´æœ‰é™ï¼Œè¶…å¤§åˆ†é…æ˜“æº¢å‡º</h3><p>è¿™æ˜¯ stackalloc æœ€å¸¸è§ä¹Ÿæœ€å±é™©çš„é—®é¢˜ã€‚ä»¥ä¸‹ä»£ç ä¼šç›´æ¥è§¦å‘ StackOverflowExceptionï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Span&lt;<span class="built_in">byte</span>&gt; buffer = <span class="keyword">stackalloc</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>]; <span class="comment">// âŒ 1MB æ ˆåˆ†é…ï¼Œè¿œè¶…æ ˆå®¹é‡</span></span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒåŸå› ï¼š</p><ul><li>æ¯ä¸ª .NET çº¿ç¨‹çš„æ ˆå¤§å°æ˜¯å›ºå®šçš„ï¼ˆé»˜è®¤ 1MB~8MBï¼Œå–å†³äºæ“ä½œç³»ç»Ÿå’Œæ¶æ„ï¼‰ï¼›</li><li>æ ˆç©ºé—´å¹¶éä»…ç”¨äº stackalloc åˆ†é…ï¼Œè¿˜éœ€å®¹çº³ï¼šæ–¹æ³•å±€éƒ¨å˜é‡ã€å‡½æ•°è°ƒç”¨é“¾ã€JIT ä¸´æ—¶å˜é‡ã€ABI å†…å­˜å¯¹é½ç­‰ï¼›</li><li>å³ä½¿æ˜¯ 512KB çš„ stackalloc åˆ†é…ï¼Œä¹Ÿå¯èƒ½å› å½“å‰æ ˆç©ºé—´å·²è¢«å ç”¨è€Œæº¢å‡ºã€‚</li></ul><h3 id="2-æ ˆæº¢å‡ºæ˜¯ä¸å¯æ¢å¤çš„è‡´å‘½é”™è¯¯"><a href="#2-æ ˆæº¢å‡ºæ˜¯ä¸å¯æ¢å¤çš„è‡´å‘½é”™è¯¯" class="headerlink" title="2. æ ˆæº¢å‡ºæ˜¯ä¸å¯æ¢å¤çš„è‡´å‘½é”™è¯¯"></a>2. æ ˆæº¢å‡ºæ˜¯ä¸å¯æ¢å¤çš„è‡´å‘½é”™è¯¯</h3><p>è¿™æ˜¯ stackalloc ä¸å †åˆ†é…çš„å…³é”®åŒºåˆ«ï¼š</p><ul><li>å †åˆ†é…å¤±è´¥ï¼ˆOutOfMemoryExceptionï¼‰ï¼šå¯é€šè¿‡ try-catch æ•è·ï¼Œç¨‹åºæœ‰æœºä¼šæ¢å¤ï¼›</li><li>æ ˆæº¢å‡ºï¼ˆStackOverflowExceptionï¼‰ï¼š.NET ä¸å…è®¸æ•è·ï¼Œç›´æ¥å¯¼è‡´<strong>è¿›ç¨‹ç»ˆæ­¢</strong>ã€‚</li></ul><p>è¿™æ„å‘³ç€ï¼šä¸€æ¬¡æœªåšé™åˆ¶çš„ stackalloc è°ƒç”¨ï¼Œå¯èƒ½ç›´æ¥è®©æ•´ä¸ªåº”ç”¨å´©æºƒã€‚</p><h3 id="3-ç”Ÿå‘½å‘¨æœŸä¸¥æ ¼å—é™ï¼Œæ— æ³•è·¨åœºæ™¯ä¼ é€’"><a href="#3-ç”Ÿå‘½å‘¨æœŸä¸¥æ ¼å—é™ï¼Œæ— æ³•è·¨åœºæ™¯ä¼ é€’" class="headerlink" title="3. ç”Ÿå‘½å‘¨æœŸä¸¥æ ¼å—é™ï¼Œæ— æ³•è·¨åœºæ™¯ä¼ é€’"></a>3. ç”Ÿå‘½å‘¨æœŸä¸¥æ ¼å—é™ï¼Œæ— æ³•è·¨åœºæ™¯ä¼ é€’</h3><p>stackalloc åˆ†é…çš„å†…å­˜ç”Ÿå‘½å‘¨æœŸä¸å½“å‰æ–¹æ³•å®Œå…¨ç»‘å®šï¼Œç¼–è¯‘å™¨ä¼šå¼ºåˆ¶é˜»æ­¢â€œå†…å­˜é€ƒé€¸â€ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Span&lt;<span class="built_in">int</span>&gt; <span class="title">GetStackAllocSpan</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Span&lt;<span class="built_in">int</span>&gt; buffer = <span class="keyword">stackalloc</span> <span class="built_in">int</span>[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">return</span> buffer; <span class="comment">// âŒ ç¼–è¯‘æŠ¥é”™ï¼šæ— æ³•è¿”å›æŒ‡å‘æ ˆå†…å­˜çš„ Span</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼çš„é™åˆ¶è¿˜åŒ…æ‹¬ï¼š</p><ul><li>ä¸èƒ½å°†æ ˆå†…å­˜çš„ Span&lt;T&gt; å­˜å…¥ç±»çš„å­—æ®µï¼›</li><li>ä¸èƒ½åœ¨ lambda&#x2F;é—­åŒ… ä¸­æ•è·æ ˆå†…å­˜å¼•ç”¨ï¼›</li><li>ä¸èƒ½è·¨ async&#x2F;await ä¼ é€’ï¼ˆå¼‚æ­¥æ–¹æ³•ä¼šåˆ‡æ¢è°ƒç”¨æ ˆï¼‰ã€‚</li></ul><p>è¿™äº›é™åˆ¶æ˜¯ç¼–è¯‘å™¨çš„â€œå®‰å…¨æŠ¤æ â€ï¼Œé¿å…å¼€å‘è€…æ— æ„é—´ä½¿ç”¨å·²é‡Šæ”¾çš„æ ˆå†…å­˜ã€‚</p><h2 id="å››ã€æ¨èæ¨¡å¼ï¼šstackalloc-ArrayPool-ç»„åˆä½¿ç”¨"><a href="#å››ã€æ¨èæ¨¡å¼ï¼šstackalloc-ArrayPool-ç»„åˆä½¿ç”¨" class="headerlink" title="å››ã€æ¨èæ¨¡å¼ï¼šstackalloc + ArrayPool ç»„åˆä½¿ç”¨"></a>å››ã€æ¨èæ¨¡å¼ï¼šstackalloc + ArrayPool ç»„åˆä½¿ç”¨</h2><h3 id="1-ç»„åˆçš„æ ¸å¿ƒé€»è¾‘"><a href="#1-ç»„åˆçš„æ ¸å¿ƒé€»è¾‘" class="headerlink" title="1. ç»„åˆçš„æ ¸å¿ƒé€»è¾‘"></a>1. ç»„åˆçš„æ ¸å¿ƒé€»è¾‘</h3><p>ç°å®å¼€å‘ä¸­ï¼Œä¸´æ—¶ç¼“å†²åŒºçš„å¤§å°å¾€å¾€ä¸å›ºå®šï¼š</p><ul><li>å°ç¼“å†²åŒºï¼ˆå¦‚ â‰¤ 1KBï¼‰ï¼šstackalloc æ€§èƒ½æœ€ä¼˜ï¼Œæ—  GC å¼€é”€ï¼›</li><li>å¤§ç¼“å†²åŒºï¼ˆå¦‚ &gt; 1KBï¼‰ï¼šæ ˆç©ºé—´ä¸è¶³ï¼Œæ— æ³•ç”¨ stackallocï¼›</li><li>ç›´æ¥ new T[]ï¼šé«˜é¢‘è°ƒç”¨ä¼šäº§ç”Ÿå¤§é‡ä¸´æ—¶å¯¹è±¡ï¼Œå¼•å‘ GC å‹åŠ›ã€‚</li></ul><p>è§£å†³æ–¹æ¡ˆï¼š<strong>å°ç”¨æ ˆï¼Œå¤§ç”¨æ± </strong>â€”â€”é€šè¿‡é˜ˆå€¼åŒºåˆ†ï¼Œå°ç¼“å†²åŒºç”¨ stackallocï¼Œå¤§ç¼“å†²åŒºç”¨ ArrayPool&lt;T&gt; å¤ç”¨ï¼Œå…¼é¡¾æ€§èƒ½ä¸å®‰å…¨æ€§ã€‚</p><h3 id="2-å¯ç›´æ¥å¤ç”¨çš„ä»£ç å®ç°"><a href="#2-å¯ç›´æ¥å¤ç”¨çš„ä»£ç å®ç°" class="headerlink" title="2. å¯ç›´æ¥å¤ç”¨çš„ä»£ç å®ç°"></a>2. å¯ç›´æ¥å¤ç”¨çš„ä»£ç å®ç°</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProcessBuffer</span>(<span class="params"><span class="built_in">int</span> length</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è®¾å®šæ ˆåˆ†é…é˜ˆå€¼ï¼ˆæ¨è 1024 å­—èŠ‚ï¼Œå¯æ ¹æ®åœºæ™¯è°ƒæ•´ï¼‰</span></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">int</span> MAX_STACKALLOC_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span>[]? pooledArray = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// æŒ‰é•¿åº¦é€‰æ‹©åˆ†é…æ–¹å¼ï¼šå°å°ºå¯¸æ ˆåˆ†é…ï¼Œå¤§å°ºå¯¸å¯¹è±¡æ± ç§Ÿå€Ÿ</span></span><br><span class="line">    Span&lt;<span class="built_in">int</span>&gt; buffer = length &lt;= MAX_STACKALLOC_SIZE </span><br><span class="line">        ? <span class="keyword">stackalloc</span> <span class="built_in">int</span>[length] </span><br><span class="line">        : (pooledArray = ArrayPool&lt;<span class="built_in">int</span>&gt;.Shared.Rent(length)).AsSpan();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ä¸šåŠ¡é€»è¾‘ï¼šå®‰å…¨æ“ä½œ bufferï¼ˆè¯»å†™ã€åˆ‡ç‰‡ç­‰ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (buffer.Length &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            buffer[<span class="number">0</span>] = <span class="number">42</span>;</span><br><span class="line">            <span class="comment">// ... å…¶ä»–å†…å­˜æ“ä½œ</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å…³é”®ï¼šå½’è¿˜å¯¹è±¡æ± æ•°ç»„ï¼Œé¿å…èµ„æºæ³„æ¼</span></span><br><span class="line">        <span class="keyword">if</span> (pooledArray != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ArrayPool&lt;<span class="built_in">int</span>&gt;.Shared.Return(pooledArray);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-æ¨¡å¼èƒŒåçš„-NET-æ€§èƒ½å“²å­¦"><a href="#3-æ¨¡å¼èƒŒåçš„-NET-æ€§èƒ½å“²å­¦" class="headerlink" title="3. æ¨¡å¼èƒŒåçš„ .NET æ€§èƒ½å“²å­¦"></a>3. æ¨¡å¼èƒŒåçš„ .NET æ€§èƒ½å“²å­¦</h3><p>è¿™ç§â€œæŒ‰å°ºå¯¸é€‰æ‹©åˆ†é…ç­–ç•¥â€çš„æ¨¡å¼ï¼Œæ˜¯ .NET åº•å±‚è®¾è®¡çš„æ ¸å¿ƒå“²å­¦ï¼Œåœ¨ BCLï¼ˆåŸºç¡€ç±»åº“ï¼‰ä¸­è¢«å¹¿æ³›åº”ç”¨ï¼š</p><table><thead><tr><th>ç¼“å†²åŒºå°ºå¯¸</th><th>åˆ†é…ç­–ç•¥</th><th>æ ¸å¿ƒä¼˜åŠ¿</th></tr></thead><tbody><tr><td>å°ï¼ˆâ‰¤1KBï¼‰</td><td>stackalloc æ ˆåˆ†é…</td><td>æè‡´æ€§èƒ½ï¼Œæ—  GC å¼€é”€</td></tr><tr><td>ä¸­ï¼ˆ1KB~100KBï¼‰</td><td>ArrayPool å¤ç”¨</td><td>é¿å…é‡å¤å †åˆ†é…ï¼Œæ§åˆ¶ GC</td></tr><tr><td>å¤§ï¼ˆ&gt;100KBï¼‰</td><td>æ˜¾å¼å †åˆ†é…ï¼ˆnewï¼‰</td><td>æ ˆ&#x2F;æ± ä¸é€‚åˆï¼Œç›´æ¥å †åˆ†é…æ›´ç¨³å®š</td></tr></tbody></table><p>ä½ å¯ä»¥åœ¨ ValueStringBuilderã€Utf8Formatterã€System.Text.Json ç­‰é«˜æ€§èƒ½ç»„ä»¶ä¸­ï¼Œçœ‹åˆ°å®Œå…¨ä¸€è‡´çš„è®¾è®¡æ€è·¯ã€‚</p><h2 id="äº”ã€æ€»ç»“ä¸ä½¿ç”¨å»ºè®®"><a href="#äº”ã€æ€»ç»“ä¸ä½¿ç”¨å»ºè®®" class="headerlink" title="äº”ã€æ€»ç»“ä¸ä½¿ç”¨å»ºè®®"></a>äº”ã€æ€»ç»“ä¸ä½¿ç”¨å»ºè®®</h2><h3 id="ä¸€å¥è¯æ€»ç»“-stackalloc"><a href="#ä¸€å¥è¯æ€»ç»“-stackalloc" class="headerlink" title="ä¸€å¥è¯æ€»ç»“ stackalloc"></a>ä¸€å¥è¯æ€»ç»“ stackalloc</h3><p>stackalloc æ˜¯ .NET ä¸­<strong>ç”¨â€œä¸¥æ ¼ç”Ÿå‘½å‘¨æœŸé™åˆ¶â€æ¢å–â€œæè‡´æ€§èƒ½â€ã€ç”¨â€œç¡®å®šæ€§å†…å­˜ç®¡ç†â€æ¢å–â€œå®‰å…¨è¾¹ç•Œâ€çš„å·¥å…·</strong>â€”â€”é€‚åˆç‰¹å®šåœºæ™¯ï¼Œä½†ç»éä¸‡èƒ½ã€‚</p><h3 id="é€‚ç”¨åœºæ™¯ï¼ˆâœ…-æ¨èï¼‰"><a href="#é€‚ç”¨åœºæ™¯ï¼ˆâœ…-æ¨èï¼‰" class="headerlink" title="é€‚ç”¨åœºæ™¯ï¼ˆâœ… æ¨èï¼‰"></a>é€‚ç”¨åœºæ™¯ï¼ˆâœ… æ¨èï¼‰</h3><ul><li>çŸ­ç”Ÿå‘½å‘¨æœŸçš„ä¸´æ—¶ç¼“å†²åŒºï¼ˆä»…åœ¨å½“å‰æ–¹æ³•å†…ä½¿ç”¨ï¼‰ï¼›</li><li>é«˜é¢‘è°ƒç”¨çš„æ€§èƒ½æ•æ„Ÿåœºæ™¯ï¼ˆå¦‚å¾ªç¯å†…çš„å°å°ºå¯¸å†…å­˜æ“ä½œï¼‰ï¼›</li><li>ä¸ Span&lt;T&gt; é…åˆï¼Œè¿›è¡Œå®‰å…¨çš„å†…å­˜è¯»å†™ã€åˆ‡ç‰‡ç­‰æ“ä½œã€‚</li></ul><h3 id="ä¸é€‚ç”¨åœºæ™¯ï¼ˆâŒ-é¿å…ï¼‰"><a href="#ä¸é€‚ç”¨åœºæ™¯ï¼ˆâŒ-é¿å…ï¼‰" class="headerlink" title="ä¸é€‚ç”¨åœºæ™¯ï¼ˆâŒ é¿å…ï¼‰"></a>ä¸é€‚ç”¨åœºæ™¯ï¼ˆâŒ é¿å…ï¼‰</h3><ul><li>å¤§å°ºå¯¸å†…å­˜åˆ†é…ï¼ˆè¶…è¿‡ 1KB éœ€è°¨æ…è¯„ä¼°æ ˆç©ºé—´ï¼‰ï¼›</li><li>é•¿åº¦ä¸ç¡®å®šçš„å†…å­˜éœ€æ±‚ï¼ˆæ— æ³•é¢„åˆ¤æ˜¯å¦è¶…å‡ºæ ˆå®¹é‡ï¼‰ï¼›</li><li>éœ€è¦è·¨æ–¹æ³•ã€è·¨å¼‚æ­¥åœºæ™¯ä¼ é€’çš„å†…å­˜ï¼›</li><li>æ™®é€šä¸šåŠ¡ä»£ç éšæ„ä½¿ç”¨ï¼ˆä¼˜å…ˆä¿è¯ç¨³å®šæ€§ï¼Œè€Œéæè‡´æ€§èƒ½ï¼‰ã€‚</li></ul><p>stackalloc ä¸æ˜¯â€œæ€§èƒ½é“¶å¼¹â€ï¼Œä½†æŒæ¡å…¶æ ¸å¿ƒé€»è¾‘ä¸ç»„åˆæ¨¡å¼åï¼Œèƒ½åœ¨å…³é”®åœºæ™¯ä¸­æ˜¾è‘—æå‡ .NET åº”ç”¨çš„æ€§èƒ½ï¼ŒåŒæ—¶è§„é¿æ½œåœ¨é£é™©ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
          <category> stackalloc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> stackalloc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Span&lt;T&gt;ï¼šçµæ´»é«˜æ•ˆçš„å¯å†™å†…å­˜æ“ä½œ</title>
      <link href="/2026/01/19/span-usage/"/>
      <url>/2026/01/19/span-usage/</url>
      
        <content type="html"><![CDATA[<h3 id="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-19-10-30-49"><a href="#æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-19-10-30-49" class="headerlink" title="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-19 10:30:49"></a><strong>æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-19 10:30:49</strong></h3><p>æœ¬æ–‡é€šè¿‡è±†åŒ…è¾…åŠ©ç”Ÿæˆï¼</p><hr><!-- è¿™ä¸ªæ˜¯å…³äº ReadOnlySpan<T> çš„æ–‡ç« ï¼Œè¯·ç”Ÿæˆä¸€ç¯‡å…³äº Span<T> çš„æ–‡ç« ã€‚å› ä¸º Span<T> ä¸ ReadOnlySpan<T> å¤§è‡´ç›¸åŒï¼Œæ‰€ä»¥è¯·æè¿° ReadOnlySpan<T> æ²¡æœ‰çš„å†…å®¹ï¼Œè®²è§£ä¼˜åŠ¿ï¼Œå¹¶æä¾›æ¡ˆä¾‹ã€‚ --><p>åœ¨ C# é«˜æ€§èƒ½å†…å­˜æ“ä½œä½“ç³»ä¸­ï¼ŒSpan&lt;T&gt; æ˜¯ ReadOnlySpan&lt;T&gt; çš„â€œå¯å†™ç‰ˆå…„å¼Ÿâ€â€”â€”å®ƒç»§æ‰¿äº† ReadOnlySpan&lt;T&gt; è½»é‡ã€é›¶æ‹·è´ã€æ ˆåˆ†é…çš„æ ¸å¿ƒä¼˜åŠ¿ï¼ŒåŒæ—¶è§£é”äº†<strong>ä¿®æ”¹å†…å­˜å†…å®¹</strong>çš„èƒ½åŠ›ï¼Œæ˜¯é«˜é¢‘è¯»å†™åœºæ™¯ä¸‹çš„æ ¸å¿ƒå·¥å…·ã€‚æœ¬æ–‡å°†ä»â€œä¸ ReadOnlySpan&lt;T&gt; çš„å·®å¼‚ã€æ ¸å¿ƒèƒ½åŠ›ã€ä½¿ç”¨æ•™ç¨‹ã€ä¼˜åŠ¿åœºæ™¯â€å››ä¸ªç»´åº¦ï¼Œå…¨é¢è§£æ Span&lt;T&gt; çš„ä½¿ç”¨æ–¹å¼ã€‚</p><h2 id="ä¸€ã€Span-ä¸-ReadOnlySpan-æ ¸å¿ƒå·®å¼‚"><a href="#ä¸€ã€Span-ä¸-ReadOnlySpan-æ ¸å¿ƒå·®å¼‚" class="headerlink" title="ä¸€ã€Span&lt;T&gt; ä¸ ReadOnlySpan&lt;T&gt; æ ¸å¿ƒå·®å¼‚"></a>ä¸€ã€Span&lt;T&gt; ä¸ ReadOnlySpan&lt;T&gt; æ ¸å¿ƒå·®å¼‚</h2><p>Span&lt;T&gt; å’Œ ReadOnlySpan&lt;T&gt; åŒå±â€œå†…å­˜è·¨åº¦ç±»å‹â€ï¼Œåº•å±‚å‡ä¸ºæ ˆåˆ†é…çš„å†…å­˜è§†å›¾ï¼Œä½†æ ¸å¿ƒåŒºåˆ«åœ¨äº<strong>å¯å†™æ€§</strong>ï¼Œå…·ä½“å·®å¼‚å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>ç‰¹æ€§</th><th>ReadOnlySpan&lt;T&gt;</th><th>Span&lt;T&gt;</th></tr></thead><tbody><tr><td>å†…å­˜æ“ä½œæƒé™</td><td>ä»…å¯è¯»ï¼Œæ— æ³•ä¿®æ”¹å†…å­˜å†…å®¹</td><td>å¯è¯»å¯å†™ï¼Œæ”¯æŒä¿®æ”¹å†…å­˜åŸå†…å®¹</td></tr><tr><td>ç±»å‹ç»§æ‰¿&#x2F;è½¬æ¢</td><td>Span&lt;T&gt; å¯éšå¼è½¬ä¸º ReadOnlySpan&lt;T&gt;</td><td>ReadOnlySpan&lt;T&gt; æ— æ³•è½¬ä¸º Span&lt;T&gt;</td></tr><tr><td>æ ¸å¿ƒé€‚ç”¨åœºæ™¯</td><td>åªè¯»æ•°æ®å¤„ç†ï¼ˆå¦‚æ•°æ®è§£æã€è¯»å–ï¼‰</td><td>å¯å†™æ•°æ®å¤„ç†ï¼ˆå¦‚æ•°æ®ä¿®æ”¹ã€ç»„è£…ï¼‰</td></tr><tr><td>æ ¸å¿ƒæ–¹æ³•&#x2F;å±æ€§</td><td>æ— å†™æ“ä½œç›¸å…³èƒ½åŠ›</td><td>åŒ…å«å†™æ“ä½œï¼ˆå¦‚ç´¢å¼•èµ‹å€¼ã€Fillï¼‰</td></tr></tbody></table><p>æ ¸å¿ƒå®šä¹‰ï¼š<br>Span&lt;T&gt; æ˜¯ .NET Core 2.1+&#x2F;.NET 5+ å¼•å…¥çš„<strong>å¯å†™å†…å­˜è·¨åº¦ç±»å‹</strong>ï¼Œæœ¬è´¨æ˜¯å¯¹è¿ç»­å†…å­˜ï¼ˆå­—ç¬¦ä¸²ã€æ•°ç»„ã€éæ‰˜ç®¡å†…å­˜ï¼‰çš„è½»é‡å¯å†™è§†å›¾ï¼ŒåŒæ ·å…·å¤‡æ ˆåˆ†é…ã€é›¶æ‹·è´ã€ä½ GC å¼€é”€çš„ç‰¹æ€§ï¼Œä¸”æ”¯æŒç›´æ¥ä¿®æ”¹æŒ‡å‘çš„å†…å­˜å†…å®¹ã€‚</p><blockquote><p>æ³¨æ„ï¼šä¸ ReadOnlySpan&lt;T&gt; ä¸€è‡´ï¼ŒSpan&lt;T&gt; åŒæ ·æ˜¯æ ˆç±»å‹ï¼Œæ— æ³•ç”¨äºå¼‚æ­¥æ–¹æ³•è¿”å›å€¼ã€ç±»å­—æ®µç­‰è·¨ä¸Šä¸‹æ–‡åœºæ™¯ï¼Œè·¨ä¸Šä¸‹æ–‡å¯å†™åœºæ™¯éœ€æ”¹ç”¨ Memory&lt;T&gt;ã€‚</p></blockquote><h2 id="äºŒã€Span-ç‹¬æœ‰çš„æ ¸å¿ƒèƒ½åŠ›ï¼ˆReadOnlySpan-æ— ï¼‰"><a href="#äºŒã€Span-ç‹¬æœ‰çš„æ ¸å¿ƒèƒ½åŠ›ï¼ˆReadOnlySpan-æ— ï¼‰" class="headerlink" title="äºŒã€Span&lt;T&gt; ç‹¬æœ‰çš„æ ¸å¿ƒèƒ½åŠ›ï¼ˆReadOnlySpan&lt;T&gt; æ— ï¼‰"></a>äºŒã€Span&lt;T&gt; ç‹¬æœ‰çš„æ ¸å¿ƒèƒ½åŠ›ï¼ˆReadOnlySpan&lt;T&gt; æ— ï¼‰</h2><p>Span&lt;T&gt; æœ€æ ¸å¿ƒçš„ä»·å€¼æ˜¯<strong>å¯ä¿®æ”¹å†…å­˜å†…å®¹</strong>ï¼ŒåŒæ—¶æ‰©å±•äº†ä¸€ç³»åˆ—å†™æ“ä½œç›¸å…³çš„æ–¹æ³•&#x2F;å±æ€§ï¼Œä»¥ä¸‹æ˜¯å…¶ç‹¬æœ‰çš„å…³é”®èƒ½åŠ›ï¼š</p><h3 id="1-ç´¢å¼•å™¨å¯å†™ï¼šç›´æ¥ä¿®æ”¹æŒ‡å®šä½ç½®çš„å…ƒç´ "><a href="#1-ç´¢å¼•å™¨å¯å†™ï¼šç›´æ¥ä¿®æ”¹æŒ‡å®šä½ç½®çš„å…ƒç´ " class="headerlink" title="1. ç´¢å¼•å™¨å¯å†™ï¼šç›´æ¥ä¿®æ”¹æŒ‡å®šä½ç½®çš„å…ƒç´ "></a>1. ç´¢å¼•å™¨å¯å†™ï¼šç›´æ¥ä¿®æ”¹æŒ‡å®šä½ç½®çš„å…ƒç´ </h3><p>ReadOnlySpan&lt;T&gt; çš„ç´¢å¼•å™¨ä»…æ”¯æŒâ€œè¯»â€ï¼Œè€Œ Span&lt;T&gt; æ”¯æŒé€šè¿‡ç´¢å¼•ç›´æ¥ä¿®æ”¹åŸå†…å­˜ä¸­çš„æ•°æ®ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span>[] nums = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line"><span class="comment">// ReadOnlySpan&lt;T&gt; ä»…å¯è¯»</span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">int</span>&gt; readOnlySpan = nums.AsSpan();</span><br><span class="line"><span class="comment">// readOnlySpan[0] = 100; // ç¼–è¯‘æŠ¥é”™ï¼šåªè¯»ç´¢å¼•å™¨æ— æ³•èµ‹å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Span&lt;T&gt; å¯å†™</span></span><br><span class="line">Span&lt;<span class="built_in">int</span>&gt; writableSpan = nums.AsSpan();</span><br><span class="line">writableSpan[<span class="number">0</span>] = <span class="number">100</span>; <span class="comment">// ç›´æ¥ä¿®æ”¹åŸæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, nums)); <span class="comment">// è¾“å‡ºï¼š100,2,3,4,5</span></span><br></pre></td></tr></table></figure><h3 id="2-ä¸“å±å†™æ“ä½œæ–¹æ³•"><a href="#2-ä¸“å±å†™æ“ä½œæ–¹æ³•" class="headerlink" title="2. ä¸“å±å†™æ“ä½œæ–¹æ³•"></a>2. ä¸“å±å†™æ“ä½œæ–¹æ³•</h3><p>Span&lt;T&gt; æä¾›äº† ReadOnlySpan&lt;T&gt; æ²¡æœ‰çš„å†™æ“ä½œæ–¹æ³•ï¼Œå…¸å‹å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>Fill(T)</td><td>å°† Span&lt;T&gt; çš„æ‰€æœ‰å…ƒç´ å¡«å……ä¸ºæŒ‡å®šå€¼</td></tr><tr><td>Clear()</td><td>å°† Span&lt;T&gt; çš„æ‰€æœ‰å…ƒç´ é‡ç½®ä¸ºç±»å‹é»˜è®¤å€¼ï¼ˆå¦‚ int é‡ç½®ä¸º 0ï¼Œstring é‡ç½®ä¸º nullï¼‰</td></tr><tr><td>CopyTo(Span&lt;T&gt;)</td><td>ï¼ˆè™½ ReadOnlySpan&lt;T&gt; ä¹Ÿæœ‰ï¼Œä½† Span&lt;T&gt; å¯å¤åˆ¶åˆ°å¯å†™ç›®æ ‡åä¿®æ”¹ï¼‰</td></tr></tbody></table><h4 id="æ¡ˆä¾‹1ï¼šFill-å¡«å……æ‰€æœ‰å…ƒç´ "><a href="#æ¡ˆä¾‹1ï¼šFill-å¡«å……æ‰€æœ‰å…ƒç´ " class="headerlink" title="æ¡ˆä¾‹1ï¼šFill å¡«å……æ‰€æœ‰å…ƒç´ "></a>æ¡ˆä¾‹1ï¼šFill å¡«å……æ‰€æœ‰å…ƒç´ </h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ– byte æ•°ç»„</span></span><br><span class="line"><span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">5</span>];</span><br><span class="line">Span&lt;<span class="built_in">byte</span>&gt; bufferSpan = buffer.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¡«å……æ‰€æœ‰å…ƒç´ ä¸º 0xFF</span></span><br><span class="line">bufferSpan.Fill(<span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºï¼š255,255,255,255,255</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, buffer));</span><br></pre></td></tr></table></figure><h4 id="æ¡ˆä¾‹2ï¼šClear-é‡ç½®å…ƒç´ ä¸ºé»˜è®¤å€¼"><a href="#æ¡ˆä¾‹2ï¼šClear-é‡ç½®å…ƒç´ ä¸ºé»˜è®¤å€¼" class="headerlink" title="æ¡ˆä¾‹2ï¼šClear é‡ç½®å…ƒç´ ä¸ºé»˜è®¤å€¼"></a>æ¡ˆä¾‹2ï¼šClear é‡ç½®å…ƒç´ ä¸ºé»˜è®¤å€¼</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span>[] strs = &#123; <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span> &#125;;</span><br><span class="line">Span&lt;<span class="built_in">string</span>&gt; strSpan = strs.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç©º Span å†…æ‰€æœ‰å…ƒç´ ï¼ˆé‡ç½®ä¸º nullï¼‰</span></span><br><span class="line">strSpan.Clear();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºï¼š, , , ï¼ˆæ‰€æœ‰å…ƒç´ ä¸º nullï¼‰</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, strs));</span><br></pre></td></tr></table></figure><h3 id="3-æ”¯æŒéšå¼è½¬æ¢ä¸º-ReadOnlySpan"><a href="#3-æ”¯æŒéšå¼è½¬æ¢ä¸º-ReadOnlySpan" class="headerlink" title="3. æ”¯æŒéšå¼è½¬æ¢ä¸º ReadOnlySpan&lt;T&gt;"></a>3. æ”¯æŒéšå¼è½¬æ¢ä¸º ReadOnlySpan&lt;T&gt;</h3><p>Span&lt;T&gt; å¯éšå¼è½¬ä¸º ReadOnlySpan&lt;T&gt;ï¼ˆå› å¯å†™åŒ…å«åªè¯»èƒ½åŠ›ï¼‰ï¼Œåä¹‹åˆ™ä¸è¡Œï¼Œè¿™è®© Span&lt;T&gt; é€‚é…æ›´å¤šåªè¯»åœºæ™¯ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span>[] arr = &#123; <span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span> &#125;;</span><br><span class="line">Span&lt;<span class="built_in">int</span>&gt; span = arr.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// éšå¼è½¬æ¢ä¸º ReadOnlySpan&lt;T&gt;</span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">int</span>&gt; readOnlySpan = span;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£å¸¸è¯»å–</span></span><br><span class="line">Console.WriteLine(readOnlySpan[<span class="number">1</span>]); <span class="comment">// è¾“å‡ºï¼š20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»æ— æ³•ä¿®æ”¹ï¼ˆReadOnlySpan&lt;T&gt; ç‰¹æ€§ï¼‰</span></span><br><span class="line"><span class="comment">// readOnlySpan[1] = 200; // ç¼–è¯‘æŠ¥é”™</span></span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€å¦‚ä½•åˆ›å»º-è½¬æ¢-Spanï¼Ÿ"><a href="#ä¸‰ã€å¦‚ä½•åˆ›å»º-è½¬æ¢-Spanï¼Ÿ" class="headerlink" title="ä¸‰ã€å¦‚ä½•åˆ›å»º&#x2F;è½¬æ¢ Span&lt;T&gt;ï¼Ÿ"></a>ä¸‰ã€å¦‚ä½•åˆ›å»º&#x2F;è½¬æ¢ Span&lt;T&gt;ï¼Ÿ</h2><p>ä¸ ReadOnlySpan&lt;T&gt; ç±»ä¼¼ï¼ŒSpan&lt;T&gt; æ— å…¬å…±æ„é€ å‡½æ•°ï¼Œéœ€é€šè¿‡ MemoryExtensions.AsSpan æ–¹æ³•è½¬æ¢å¸¸è§ç±»å‹ï¼Œä½ç‰ˆæœ¬ .NET åŒæ ·éœ€å®‰è£… System.Memory NuGet åŒ…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½ç‰ˆæœ¬ .NET å®‰è£…ä¾èµ–</span></span><br><span class="line">Install-Package System.Memory</span><br><span class="line"><span class="comment"># æˆ– .NET CLI</span></span><br><span class="line">dotnet add package System.Memory</span><br></pre></td></tr></table></figure><h3 id="1-æ•°ç»„è½¬-Spanï¼ˆæœ€å¸¸ç”¨ï¼‰"><a href="#1-æ•°ç»„è½¬-Spanï¼ˆæœ€å¸¸ç”¨ï¼‰" class="headerlink" title="1. æ•°ç»„è½¬ Span&lt;T&gt;ï¼ˆæœ€å¸¸ç”¨ï¼‰"></a>1. æ•°ç»„è½¬ Span&lt;T&gt;ï¼ˆæœ€å¸¸ç”¨ï¼‰</h3><p>ä»»æ„æ•°ç»„å¯ç›´æ¥è½¬ä¸º Span&lt;T&gt;ï¼Œè½¬æ¢åä¿®æ”¹ Span&lt;T&gt; ä¼šåŒæ­¥ä¿®æ”¹åŸæ•°ç»„ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹æ•°ç»„</span></span><br><span class="line"><span class="built_in">char</span>[] chars = &#123; <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;o&#x27;</span> &#125;;</span><br><span class="line"><span class="comment">// è½¬ä¸º Span&lt;char&gt;</span></span><br><span class="line">Span&lt;<span class="built_in">char</span>&gt; charSpan = chars.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹ Span å†…å®¹ï¼ˆåŒæ­¥ä¿®æ”¹åŸæ•°ç»„ï¼‰</span></span><br><span class="line">charSpan[<span class="number">4</span>] = <span class="string">&#x27;O&#x27;</span>; <span class="comment">// å°†æœ€åä¸€ä¸ª &#x27;l&#x27; æ”¹ä¸º &#x27;O&#x27;</span></span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;&quot;</span>, chars)); <span class="comment">// è¾“å‡ºï¼šHellO</span></span><br></pre></td></tr></table></figure><h3 id="2-å­—ç¬¦ä¸²è½¬-Spanï¼ˆç‰¹æ®Šæ³¨æ„ï¼‰"><a href="#2-å­—ç¬¦ä¸²è½¬-Spanï¼ˆç‰¹æ®Šæ³¨æ„ï¼‰" class="headerlink" title="2. å­—ç¬¦ä¸²è½¬ Spanï¼ˆç‰¹æ®Šæ³¨æ„ï¼‰"></a>2. å­—ç¬¦ä¸²è½¬ Span<char>ï¼ˆç‰¹æ®Šæ³¨æ„ï¼‰</h3><p>å­—ç¬¦ä¸²æ˜¯<strong>ä¸å¯å˜ç±»å‹</strong>ï¼Œå› æ­¤å­—ç¬¦ä¸²è½¬æ¢çš„ Span<char> æœ¬è´¨ä»æ˜¯åªè¯»ï¼ˆåº•å±‚åšäº†ä¿æŠ¤ï¼‰ï¼Œå°è¯•ä¿®æ”¹ä¼šæŠ›å‡º System.AccessViolationExceptionï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> str = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"><span class="comment">// å­—ç¬¦ä¸²è½¬ Span&lt;char&gt;ï¼ˆå®é™…æ˜¯åªè¯»å°è£…ï¼‰</span></span><br><span class="line">Span&lt;<span class="built_in">char</span>&gt; strSpan = str.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸‹ä»£ç ä¼šè¿è¡Œæ—¶æŠ¥é”™ï¼šå°è¯•ä¿®æ”¹åªè¯»å†…å­˜</span></span><br><span class="line"><span class="comment">// strSpan[0] = &#x27;h&#x27;; </span></span><br></pre></td></tr></table></figure><blockquote><p>è‹¥éœ€ä¿®æ”¹å­—ç¬¦ä¸²å†…å®¹ï¼Œéœ€å…ˆå°†å­—ç¬¦ä¸²è½¬ä¸º char æ•°ç»„ï¼Œå†è½¬ Span&lt;T&gt;ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> str = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"><span class="built_in">char</span>[] charArr = str.ToCharArray(); <span class="comment">// æ‹·è´å­—ç¬¦ä¸²åˆ°æ•°ç»„ï¼ˆä»…æ­¤å¤„æœ‰æ‹·è´ï¼‰</span></span><br><span class="line">Span&lt;<span class="built_in">char</span>&gt; charSpan = charArr.AsSpan();</span><br><span class="line">charSpan[<span class="number">0</span>] = <span class="string">&#x27;h&#x27;</span>;</span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;&quot;</span>, charArr)); <span class="comment">// è¾“å‡ºï¼šhello</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="3-List-è½¬-Span"><a href="#3-List-è½¬-Span" class="headerlink" title="3. List&lt;T&gt; è½¬ Span&lt;T&gt;"></a>3. List&lt;T&gt; è½¬ Span&lt;T&gt;</h3><p>ä¸ ReadOnlySpan&lt;T&gt; ä¸€è‡´ï¼ŒList&lt;T&gt; éœ€é€šè¿‡ CollectionsMarshal.AsSpanï¼ˆ.NET 5+ï¼‰æˆ–å…ˆè½¬æ•°ç»„å†è½¬ Span&lt;T&gt;ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;<span class="built_in">int</span>&gt; numList = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt; &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line"><span class="comment">// .NET 5+ ç›´æ¥è½¬ï¼ˆæ— æ‹·è´ï¼‰</span></span><br><span class="line">Span&lt;<span class="built_in">int</span>&gt; listSpan = CollectionsMarshal.AsSpan(numList);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹ Span å†…å®¹ï¼ˆåŒæ­¥ä¿®æ”¹ Listï¼‰</span></span><br><span class="line">listSpan[<span class="number">1</span>] = <span class="number">200</span>;</span><br><span class="line">Console.WriteLine(numList[<span class="number">1</span>]); <span class="comment">// è¾“å‡ºï¼š200</span></span><br></pre></td></tr></table></figure><h2 id="å››ã€Span-çš„æ ¸å¿ƒä¼˜åŠ¿ï¼ˆå¯¹æ¯”-ReadOnlySpan-ä¼ ç»Ÿæ“ä½œï¼‰"><a href="#å››ã€Span-çš„æ ¸å¿ƒä¼˜åŠ¿ï¼ˆå¯¹æ¯”-ReadOnlySpan-ä¼ ç»Ÿæ“ä½œï¼‰" class="headerlink" title="å››ã€Span&lt;T&gt; çš„æ ¸å¿ƒä¼˜åŠ¿ï¼ˆå¯¹æ¯” ReadOnlySpan&lt;T&gt; + ä¼ ç»Ÿæ“ä½œï¼‰"></a>å››ã€Span&lt;T&gt; çš„æ ¸å¿ƒä¼˜åŠ¿ï¼ˆå¯¹æ¯” ReadOnlySpan&lt;T&gt; + ä¼ ç»Ÿæ“ä½œï¼‰</h2><h3 id="1-ä¿ç•™é›¶æ‹·è´-æ ˆåˆ†é…ä¼˜åŠ¿ï¼Œæ–°å¢å¯å†™èƒ½åŠ›"><a href="#1-ä¿ç•™é›¶æ‹·è´-æ ˆåˆ†é…ä¼˜åŠ¿ï¼Œæ–°å¢å¯å†™èƒ½åŠ›" class="headerlink" title="1. ä¿ç•™é›¶æ‹·è´ + æ ˆåˆ†é…ä¼˜åŠ¿ï¼Œæ–°å¢å¯å†™èƒ½åŠ›"></a>1. ä¿ç•™é›¶æ‹·è´ + æ ˆåˆ†é…ä¼˜åŠ¿ï¼Œæ–°å¢å¯å†™èƒ½åŠ›</h3><p>Span&lt;T&gt; ç»§æ‰¿äº† ReadOnlySpan&lt;T&gt; é›¶æ‹·è´ã€æ ˆåˆ†é…æ—  GC å¼€é”€çš„ç‰¹æ€§ï¼ŒåŒæ—¶è§£å†³äº† ReadOnlySpan&lt;T&gt; æ— æ³•ä¿®æ”¹æ•°æ®çš„ç—›ç‚¹ï¼Œæ— éœ€ä¸ºä¿®æ”¹æ•°æ®é¢å¤–åˆ›å»ºæ‹·è´ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼ï¼šä¿®æ”¹æ•°ç»„ç‰‡æ®µéœ€æ‹·è´</span></span><br><span class="line"><span class="built_in">int</span>[] source = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line"><span class="built_in">int</span>[] subCopy = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">3</span>];</span><br><span class="line">Array.Copy(source, <span class="number">1</span>, subCopy, <span class="number">0</span>, <span class="number">3</span>); <span class="comment">// æ‹·è´æ•°æ®</span></span><br><span class="line">subCopy[<span class="number">0</span>] = <span class="number">200</span>; <span class="comment">// ä¿®æ”¹æ‹·è´åçš„æ•°ç»„ï¼ŒåŸæ•°ç»„æ— å˜åŒ–</span></span><br><span class="line">Console.WriteLine(source[<span class="number">1</span>]); <span class="comment">// è¾“å‡ºï¼š2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Span&lt;T&gt; æ–¹å¼ï¼šé›¶æ‹·è´ä¿®æ”¹åŸæ•°ç»„ç‰‡æ®µ</span></span><br><span class="line">Span&lt;<span class="built_in">int</span>&gt; sourceSpan = source.AsSpan();</span><br><span class="line">Span&lt;<span class="built_in">int</span>&gt; subSpan = sourceSpan.Slice(<span class="number">1</span>, <span class="number">3</span>); <span class="comment">// é›¶æ‹·è´æˆªå–</span></span><br><span class="line">subSpan[<span class="number">0</span>] = <span class="number">200</span>; <span class="comment">// ç›´æ¥ä¿®æ”¹åŸæ•°ç»„</span></span><br><span class="line">Console.WriteLine(source[<span class="number">1</span>]); <span class="comment">// è¾“å‡ºï¼š200</span></span><br></pre></td></tr></table></figure><h3 id="2-é«˜æ€§èƒ½ä¿®æ”¹è¿ç»­å†…å­˜ï¼Œé¿å…ä¸´æ—¶å¯¹è±¡"><a href="#2-é«˜æ€§èƒ½ä¿®æ”¹è¿ç»­å†…å­˜ï¼Œé¿å…ä¸´æ—¶å¯¹è±¡" class="headerlink" title="2. é«˜æ€§èƒ½ä¿®æ”¹è¿ç»­å†…å­˜ï¼Œé¿å…ä¸´æ—¶å¯¹è±¡"></a>2. é«˜æ€§èƒ½ä¿®æ”¹è¿ç»­å†…å­˜ï¼Œé¿å…ä¸´æ—¶å¯¹è±¡</h3><p>ä¼ ç»Ÿä¿®æ”¹æ•°ç»„&#x2F;å­—ç¬¦ä¸²çš„æ–¹å¼æ˜“äº§ç”Ÿå¤§é‡ä¸´æ—¶å¯¹è±¡ï¼ˆå¦‚ string.Substringã€Array.Copyï¼‰ï¼Œè€Œ Span&lt;T&gt; ç›´æ¥æ“ä½œåŸå†…å­˜ï¼Œæ— é¢å¤–å†…å­˜åˆ†é…ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœºæ™¯ï¼šæ‰¹é‡ä¿®æ”¹å­—èŠ‚æ•°ç»„å‰10ä¸ªå…ƒç´ ä¸º 0x01</span></span><br><span class="line"><span class="built_in">byte</span>[] data = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼ï¼šå¾ªç¯èµ‹å€¼ï¼ˆæ— æ‹·è´ï¼Œä½†è¯­æ³•ç¹çï¼‰</span></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    data[i] = <span class="number">0x01</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Span&lt;T&gt; æ–¹å¼ï¼šSlice + Fill ç®€æ´é«˜æ•ˆ</span></span><br><span class="line">data.AsSpan(<span class="number">0</span>, <span class="number">10</span>).Fill(<span class="number">0x01</span>); <span class="comment">// æˆªå–å‰10ä¸ªå…ƒç´ å¹¶å¡«å……ï¼Œé›¶æ‹·è´</span></span><br></pre></td></tr></table></figure><h3 id="3-å†…å­˜å®‰å…¨ï¼šè¶Šç•Œæ“ä½œç›´æ¥æŠ›å¼‚å¸¸ï¼Œé¿å…å†…å­˜è¶Šè®¿é—®"><a href="#3-å†…å­˜å®‰å…¨ï¼šè¶Šç•Œæ“ä½œç›´æ¥æŠ›å¼‚å¸¸ï¼Œé¿å…å†…å­˜è¶Šè®¿é—®" class="headerlink" title="3. å†…å­˜å®‰å…¨ï¼šè¶Šç•Œæ“ä½œç›´æ¥æŠ›å¼‚å¸¸ï¼Œé¿å…å†…å­˜è¶Šè®¿é—®"></a>3. å†…å­˜å®‰å…¨ï¼šè¶Šç•Œæ“ä½œç›´æ¥æŠ›å¼‚å¸¸ï¼Œé¿å…å†…å­˜è¶Šè®¿é—®</h3><p>Span&lt;T&gt; ä¼šæ ¡éªŒç´¢å¼•&#x2F;é•¿åº¦çš„åˆæ³•æ€§ï¼Œè¶Šç•Œæ“ä½œï¼ˆå¦‚ Slice è¶…å‡ºèŒƒå›´ã€ç´¢å¼•è®¿é—®è¶Šç•Œï¼‰ä¼šç«‹å³æŠ›å‡º ArgumentOutOfRangeExceptionï¼Œç›¸æ¯”ç›´æ¥æ“ä½œæŒ‡é’ˆæ›´å®‰å…¨ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span>[] nums = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line">Span&lt;<span class="built_in">int</span>&gt; span = nums.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¶Šç•Œè®¿é—®ç´¢å¼•ï¼Œç›´æ¥æŠ›å¼‚å¸¸</span></span><br><span class="line"><span class="comment">// Console.WriteLine(span[3]); // æŠ¥é”™ï¼šç´¢å¼•è¶…å‡ºèŒƒå›´</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¶Šç•Œ Sliceï¼Œç›´æ¥æŠ›å¼‚å¸¸</span></span><br><span class="line"><span class="comment">// span.Slice(1, 3); // æŠ¥é”™ï¼šé•¿åº¦è¶…å‡ºèŒƒå›´</span></span><br></pre></td></tr></table></figure><h2 id="äº”ã€Span-æ ¸å¿ƒæ–¹æ³•å®æˆ˜ï¼ˆå¯¹æ¯”-ReadOnlySpan-è¡¥å……ï¼‰"><a href="#äº”ã€Span-æ ¸å¿ƒæ–¹æ³•å®æˆ˜ï¼ˆå¯¹æ¯”-ReadOnlySpan-è¡¥å……ï¼‰" class="headerlink" title="äº”ã€Span&lt;T&gt; æ ¸å¿ƒæ–¹æ³•å®æˆ˜ï¼ˆå¯¹æ¯” ReadOnlySpan&lt;T&gt; è¡¥å……ï¼‰"></a>äº”ã€Span&lt;T&gt; æ ¸å¿ƒæ–¹æ³•å®æˆ˜ï¼ˆå¯¹æ¯” ReadOnlySpan&lt;T&gt; è¡¥å……ï¼‰</h2><p>é™¤äº† ReadOnlySpan&lt;T&gt; ä¹Ÿæœ‰çš„ CopyTo&#x2F;TryCopyTo&#x2F;Slice æ–¹æ³•ï¼Œä»¥ä¸‹èšç„¦ Span&lt;T&gt; ç‹¬æœ‰çš„å†™æ“ä½œæ–¹æ³•æ¡ˆä¾‹ï¼š</p><h3 id="1-Fillï¼šæ‰¹é‡å¡«å……å…ƒç´ "><a href="#1-Fillï¼šæ‰¹é‡å¡«å……å…ƒç´ " class="headerlink" title="1. Fillï¼šæ‰¹é‡å¡«å……å…ƒç´ "></a>1. Fillï¼šæ‰¹é‡å¡«å……å…ƒç´ </h3><p>é€‚ç”¨äºåˆå§‹åŒ–ç¼“å†²åŒºã€é‡ç½®æ•°æ®ç­‰åœºæ™¯ï¼Œæ¯”å¾ªç¯èµ‹å€¼æ›´ç®€æ´é«˜æ•ˆï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœºæ™¯ï¼šåˆå§‹åŒ– 1024 å­—èŠ‚çš„ç¼“å†²åŒºä¸º 0</span></span><br><span class="line"><span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">Span&lt;<span class="built_in">byte</span>&gt; bufferSpan = buffer.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¹é‡å¡«å……</span></span><br><span class="line">bufferSpan.Fill(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯ï¼šå‰10ä¸ªå…ƒç´ å‡ä¸º 0</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, bufferSpan.Slice(<span class="number">0</span>, <span class="number">10</span>))); <span class="comment">// è¾“å‡ºï¼š0,0,0,0,0,0,0,0,0,0</span></span><br></pre></td></tr></table></figure><h3 id="2-ç´¢å¼•å™¨å†™æ“ä½œï¼šç²¾å‡†ä¿®æ”¹å•ä¸ªå…ƒç´ "><a href="#2-ç´¢å¼•å™¨å†™æ“ä½œï¼šç²¾å‡†ä¿®æ”¹å•ä¸ªå…ƒç´ " class="headerlink" title="2. ç´¢å¼•å™¨å†™æ“ä½œï¼šç²¾å‡†ä¿®æ”¹å•ä¸ªå…ƒç´ "></a>2. ç´¢å¼•å™¨å†™æ“ä½œï¼šç²¾å‡†ä¿®æ”¹å•ä¸ªå…ƒç´ </h3><p>é€‚ç”¨äºæŒ‰éœ€ä¿®æ”¹å†…å­˜ä¸­æŒ‡å®šä½ç½®çš„æ•°æ®ï¼Œæ— æ‹·è´å¼€é”€ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœºæ™¯ï¼šä¿®æ”¹æ•°ç»„ä¸­æŒ‡å®šä½ç½®çš„æ•°å€¼</span></span><br><span class="line"><span class="built_in">int</span>[] scores = &#123; <span class="number">80</span>, <span class="number">85</span>, <span class="number">90</span>, <span class="number">95</span> &#125;;</span><br><span class="line">Span&lt;<span class="built_in">int</span>&gt; scoreSpan = scores.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹ç¬¬äºŒä¸ªåˆ†æ•°ä¸º 99</span></span><br><span class="line">scoreSpan[<span class="number">1</span>] = <span class="number">99</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºï¼š80,99,90,95</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, scores));</span><br></pre></td></tr></table></figure><h3 id="3-Clearï¼šå¿«é€Ÿé‡ç½®å†…å­˜å†…å®¹"><a href="#3-Clearï¼šå¿«é€Ÿé‡ç½®å†…å­˜å†…å®¹" class="headerlink" title="3. Clearï¼šå¿«é€Ÿé‡ç½®å†…å­˜å†…å®¹"></a>3. Clearï¼šå¿«é€Ÿé‡ç½®å†…å­˜å†…å®¹</h3><p>é€‚ç”¨äºæ•°æ®è„±æ•ã€å†…å­˜å›æ”¶å‰çš„é‡ç½®æ“ä½œï¼Œæ¯”å¾ªç¯èµ‹å€¼é»˜è®¤å€¼æ›´é«˜æ•ˆï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœºæ™¯ï¼šé‡ç½®æ•æ„Ÿæ•°æ®ï¼ˆå¦‚å¯†ç æ•°ç»„ï¼‰</span></span><br><span class="line"><span class="built_in">char</span>[] password = &#123; <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span> &#125;;</span><br><span class="line">Span&lt;<span class="built_in">char</span>&gt; pwdSpan = password.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç©ºå¯†ç ï¼ˆé‡ç½®ä¸º &#x27;\0&#x27;ï¼‰</span></span><br><span class="line">pwdSpan.Clear();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºï¼š,,,,ï¼ˆæ‰€æœ‰å…ƒç´ ä¸ºé»˜è®¤å€¼ï¼‰</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;&quot;</span>, password));</span><br></pre></td></tr></table></figure><h2 id="å…­ã€Span-é€‚ç”¨åœºæ™¯-æ³¨æ„äº‹é¡¹"><a href="#å…­ã€Span-é€‚ç”¨åœºæ™¯-æ³¨æ„äº‹é¡¹" class="headerlink" title="å…­ã€Span&lt;T&gt; é€‚ç”¨åœºæ™¯ &amp; æ³¨æ„äº‹é¡¹"></a>å…­ã€Span&lt;T&gt; é€‚ç”¨åœºæ™¯ &amp; æ³¨æ„äº‹é¡¹</h2><h3 id="é€‚ç”¨åœºæ™¯"><a href="#é€‚ç”¨åœºæ™¯" class="headerlink" title="é€‚ç”¨åœºæ™¯"></a>é€‚ç”¨åœºæ™¯</h3><ol><li><strong>é«˜é¢‘æ•°æ®ä¿®æ”¹</strong>ï¼šå¦‚ç½‘ç»œç¼“å†²åŒºè¯»å†™ã€æ–‡ä»¶æµæ•°æ®å¤„ç†ã€äºŒè¿›åˆ¶æ•°æ®è§£æ&#x2F;ç»„è£…ï¼›</li><li><strong>å†…å­˜æ•æ„Ÿåœºæ™¯</strong>ï¼šå¦‚ä½å»¶è¿ŸæœåŠ¡ã€åµŒå…¥å¼å¼€å‘ï¼Œé¿å… GC å¼€é”€å’Œä¸´æ—¶å¯¹è±¡ï¼›</li><li><strong>æ•°ç»„ç‰‡æ®µä¿®æ”¹</strong>ï¼šæ— éœ€æ‹·è´æ•°ç»„ï¼Œç›´æ¥ä¿®æ”¹æŒ‡å®šèŒƒå›´çš„å…ƒç´ ã€‚</li></ol><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ol><li>æ ˆç±»å‹é™åˆ¶ï¼šæ— æ³•ç”¨äºå¼‚æ­¥æ–¹æ³•è¿”å›å€¼ã€ç±»å­—æ®µã€é—­åŒ…ç­‰åœºæ™¯ï¼Œè·¨ä¸Šä¸‹æ–‡éœ€æ”¹ç”¨ Memory&lt;T&gt;ï¼›</li><li>å­—ç¬¦ä¸²ä¸å¯å˜ï¼šç›´æ¥è½¬æ¢å­—ç¬¦ä¸²å¾—åˆ°çš„ Span<char> ä¸å¯å†™ï¼Œä¿®æ”¹éœ€å…ˆè½¬ char æ•°ç»„ï¼›</li><li>ç”Ÿå‘½å‘¨æœŸï¼šSpan&lt;T&gt; å¼•ç”¨çš„å†…å­˜éœ€ä¿è¯åœ¨ Span&lt;T&gt; ç”Ÿå‘½å‘¨æœŸå†…æœ‰æ•ˆï¼ˆå¦‚é¿å…å¼•ç”¨å·²é‡Šæ”¾çš„éæ‰˜ç®¡å†…å­˜ã€å·²å›æ”¶çš„æ•°ç»„ï¼‰ã€‚</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>Span&lt;T&gt; æ˜¯ ReadOnlySpan&lt;T&gt; çš„å¯å†™ç‰ˆæœ¬ï¼Œæ ¸å¿ƒå·®å¼‚æ˜¯æ”¯æŒä¿®æ”¹å†…å­˜å†…å®¹ï¼Œä¸”å¯éšå¼è½¬ä¸º ReadOnlySpan&lt;T&gt;ï¼›</li><li>ç‹¬æœ‰èƒ½åŠ›ï¼šå¯å†™ç´¢å¼•å™¨ã€Fill&#x2F;Clear ç­‰å†™æ“ä½œæ–¹æ³•ï¼Œé›¶æ‹·è´ä¿®æ”¹åŸå†…å­˜ï¼›</li><li>æ ¸å¿ƒä¼˜åŠ¿ï¼šä¿ç•™æ ˆåˆ†é…ã€é›¶æ‹·è´ã€ä½ GC å¼€é”€çš„åŒæ—¶ï¼Œè§£é”é«˜æ•ˆå¯å†™å†…å­˜æ“ä½œï¼›</li><li>é€‚ç”¨åœºæ™¯ï¼šé«˜é¢‘æ•°æ®ä¿®æ”¹ã€å†…å­˜æ•æ„Ÿåœºæ™¯ã€æ•°ç»„ç‰‡æ®µæ“ä½œã€‚</li></ol><p>Span&lt;T&gt; ä¸ ReadOnlySpan&lt;T&gt; é…åˆï¼Œè¦†ç›–äº† C# ä¸­â€œåªè¯»â€å’Œâ€œå¯å†™â€çš„é«˜æ€§èƒ½å†…å­˜æ“ä½œåœºæ™¯ï¼Œæ˜¯æ„å»ºé«˜æ€§èƒ½ .NET åº”ç”¨çš„æ ¸å¿ƒå·¥å…·ã€‚</p><h2 id="å¤–éƒ¨é“¾æ¥"><a href="#å¤–éƒ¨é“¾æ¥" class="headerlink" title="å¤–éƒ¨é“¾æ¥"></a>å¤–éƒ¨é“¾æ¥</h2><p><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.span-1?view=net-8.0">Span&lt;T&gt; ç»“æ„ - Microsoft Learn</a><br><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.memory-1?view=net-8.0">Memory&lt;T&gt; ç»“æ„ - Microsoft Learn</a><br><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.runtime.interopservices.collectionsmarshal?view=net-9.0">CollectionsMarshal ç±» - Microsoft Learn</a><br><a href="https://www.nuget.org/packages/System.Memory">System.Memory - NuGet Gallery</a></p>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> Span&lt;T&gt; </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ReadOnlySpan&lt;T&gt;ï¼šè½»é‡é«˜æ•ˆçš„åªè¯»å†…å­˜æ“ä½œ</title>
      <link href="/2026/01/18/readonlyspan-usage/"/>
      <url>/2026/01/18/readonlyspan-usage/</url>
      
        <content type="html"><![CDATA[<h3 id="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-18-14-29-29"><a href="#æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-18-14-29-29" class="headerlink" title="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-18 14:29:29"></a><strong>æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-18 14:29:29</strong></h3><p>æœ¬æ–‡é€šè¿‡è±†åŒ…è¾…åŠ©ç”Ÿæˆï¼</p><hr><!--å¸®æˆ‘å†™ä¸€ç¯‡ markdown æ–‡ç« ï¼Œæ˜¯å…³äº C# çš„ ReadOnlySpan<T> ç®€å•ä»‹ç»+ç®€å•çš„ä½¿ç”¨æ•™ç¨‹+æ¡ˆä¾‹ çš„å†…å®¹ï¼Œéœ€è¦æŠŠä»¥ä¸‹æ‰€æœ‰è¦æ±‚ç½—åˆ—å‡ºæ¥ï¼š1. ä»‹ç» ReadOnlySpan<T> æ˜¯ä»€ä¹ˆï¼›2. åœ¨ stringã€æ•°ç»„ã€List<T>ï¼ˆå…¶ä»–åˆ—è¡¨ä¸çŸ¥é“è¡Œä¸è¡Œï¼‰ä¸­ï¼Œé€šè¿‡ MemoryExtensions.AsSpan è½¬åŒ–ä¸º ReadOnlySpan<T> ï¼ˆå¦‚æœå½“å‰ .net ç‰ˆæœ¬ä¸å­˜åœ¨ MemoryExtensions æ—¶ï¼Œé€šè¿‡ NuGet å®‰è£… System.Memory åº“ï¼‰ï¼›3. ä¸ºä»€ä¹ˆä½¿ç”¨ ReadOnlySpan<T>ï¼Ÿæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ  1. ReadOnlySpan<T> çš„ä¼˜åŠ¿ï¼›  2. ç›¸æ¯”ç›´æ¥æ“ä½œ string çš„æ–¹æ³•ï¼Œé€šè¿‡ MemoryExtensions.AsSpan è½¬æ¢ä¸º ReadOnlySpan<char> æ—¶ï¼Œé‚£äº›æ–¹æ³•çš„æ‰§è¡Œæ•ˆç‡æé«˜ï¼ˆé«˜ç‰ˆæœ¬çš„ string çš„æ–¹æ³•å†…éƒ¨å®ç°ä¹Ÿä½¿ç”¨äº† ReadOnlySpanï¼Œåªæœ‰ä½ç‰ˆæœ¬æ²¡ä¼˜åŒ–ï¼‰ï¼›  3. ä¹Ÿä»‹ç» æ•°ç»„ã€åˆ—è¡¨ ç­‰å…¶ä»–ã€‚4. ReadOnlySpan<T> å±æ€§æ•™ç¨‹+æ¡ˆä¾‹ï¼ˆæ¡ˆä¾‹ç”¨ stringï¼‰ï¼Œåªä»‹ç»ï¼š  - Item[Int32]ï¼šä»æŒ‡å®šä»é›¶å¼€å§‹çš„ç´¢å¼•å¤„çš„åªè¯»èŒƒå›´è·å–é¡¹ã€‚  - Lengthï¼šåªè¯»èŒƒå›´ä¸­çš„é¡¹æ•°ã€‚5. ReadOnlySpan<T> æ–¹æ³•æ•™ç¨‹+æ¡ˆä¾‹ï¼ˆæ¡ˆä¾‹ç”¨ æ•°ç»„ï¼‰ï¼Œåªä»‹ç»ï¼š  - CopyTo(Span<T>)ï¼šå°†æ­¤ ReadOnlySpan<T> çš„å†…å®¹å¤åˆ¶åˆ°ç›®æ ‡ Span<T>ã€‚  - TryCopyTo(Span<T>)ï¼šå°è¯•å°†æ­¤ ReadOnlySpan<T> çš„å†…å®¹å¤åˆ¶åˆ° Span<T> ä¸­ï¼Œå¹¶è¿”å›ä¸€ä¸ªå€¼ä»¥æŒ‡ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸã€‚  - Slice(Int32)ï¼šå½¢æˆä»å½“å‰åªè¯»èŒƒå›´å¼€å§‹çš„åˆ‡ç‰‡ï¼Œè¯¥èŒƒå›´ä»æŒ‡å®šçš„ç´¢å¼•å¤„å¼€å§‹ã€‚  - Slice(Int32, Int32)ï¼šå½¢æˆä»æŒ‡å®šé•¿åº¦çš„æŒ‡å®šç´¢å¼•å¤„å¼€å§‹çš„å½“å‰åªè¯»èŒƒå›´çš„åˆ‡ç‰‡ã€‚  - è¿˜æœ‰å…¶ä»–åƒ Containsã€StartsWithã€EndsWithã€IndexOf ç­‰ï¼Œé€šè¿‡æ–‡æ¡£ / ç½‘ç»œæ•™ç¨‹æŸ¥çœ‹ã€‚--><p>åœ¨ C# ä¸­ï¼ŒReadOnlySpan&lt;T&gt; æ˜¯å¤„ç†å†…å­˜ç‰‡æ®µçš„æ ¸å¿ƒç±»å‹ï¼Œå°¤å…¶é€‚åˆé«˜é¢‘è¯»å†™ã€ä½å†…å­˜å¼€é”€çš„åœºæ™¯ã€‚æœ¬æ–‡å°†ä»â€œæ˜¯ä»€ä¹ˆã€æ€ä¹ˆç”¨ã€ä¸ºä»€ä¹ˆå¥½ç”¨â€ä¸‰ä¸ªç»´åº¦ï¼Œå¸¦ä½ å¿«é€ŸæŒæ¡ ReadOnlySpan&lt;T&gt; çš„åŸºç¡€ç”¨æ³•å’Œæ ¸å¿ƒä¼˜åŠ¿ã€‚</p><h2 id="ä¸€ã€ReadOnlySpan-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ä¸€ã€ReadOnlySpan-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä¸€ã€ReadOnlySpan&lt;T&gt; æ˜¯ä»€ä¹ˆï¼Ÿ"></a>ä¸€ã€ReadOnlySpan&lt;T&gt; æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ReadOnlySpan&lt;T&gt; æ˜¯ .NET Core 2.1+&#x2F;.NET 5+ å¼•å…¥çš„<strong>åªè¯»å†…å­˜è·¨åº¦ç±»å‹</strong>ï¼Œæœ¬è´¨æ˜¯å¯¹ä¸€æ®µè¿ç»­å†…å­˜ï¼ˆå¦‚å­—ç¬¦ä¸²ã€æ•°ç»„ã€éæ‰˜ç®¡å†…å­˜ï¼‰çš„â€œè½»é‡è§†å›¾â€â€”â€”å®ƒä¸åˆ†é…æ–°å†…å­˜ï¼Œä»…è®°å½•å†…å­˜çš„èµ·å§‹åœ°å€å’Œé•¿åº¦ï¼Œä¸”<strong>æ— æ³•ä¿®æ”¹æŒ‡å‘çš„å†…å­˜å†…å®¹</strong>ï¼Œå› æ­¤å…¼å…·é«˜æ€§èƒ½å’Œå†…å­˜å®‰å…¨ã€‚</p><p>æ ¸å¿ƒç‰¹ç‚¹ï¼š</p><ul><li><strong>æ ˆåˆ†é…ï¼ˆstack-onlyï¼‰</strong>ï¼šå®ä¾‹å­˜å‚¨åœ¨æ ˆä¸Šï¼Œæ—  GC å¼€é”€ï¼›</li><li>åªè¯»ç‰¹æ€§ï¼šä»…èƒ½è¯»å–å†…å­˜å†…å®¹ï¼Œæ— æ³•ä¿®æ”¹ï¼Œé¿å…æ„å¤–æ•°æ®ç¯¡æ”¹ï¼›</li><li>é›¶æ‹·è´ï¼šæ“ä½œå†…å­˜æ—¶ä¸å¤åˆ¶æ•°æ®ï¼Œç›´æ¥å¼•ç”¨åŸå†…å­˜åŒºåŸŸã€‚</li></ul><blockquote><p>æ³¨æ„ï¼šReadOnlySpan&lt;T&gt; ä¸èƒ½ç”¨äºå¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼ã€ç±»çš„å­—æ®µç­‰åœºæ™¯ï¼ˆæ ˆç±»å‹é™åˆ¶ï¼‰ï¼Œè‹¥éœ€è·¨ä¸Šä¸‹æ–‡ä½¿ç”¨ï¼Œå¯æ”¹ç”¨ ReadOnlyMemory&lt;T&gt;ã€‚</p></blockquote><h2 id="äºŒã€å¦‚ä½•å°†å¸¸è§ç±»å‹è½¬ä¸º-ReadOnlySpanï¼Ÿ"><a href="#äºŒã€å¦‚ä½•å°†å¸¸è§ç±»å‹è½¬ä¸º-ReadOnlySpanï¼Ÿ" class="headerlink" title="äºŒã€å¦‚ä½•å°†å¸¸è§ç±»å‹è½¬ä¸º ReadOnlySpan&lt;T&gt;ï¼Ÿ"></a>äºŒã€å¦‚ä½•å°†å¸¸è§ç±»å‹è½¬ä¸º ReadOnlySpan&lt;T&gt;ï¼Ÿ</h2><p>ReadOnlySpan&lt;T&gt; æ— æ³•ç›´æ¥åˆ›å»ºï¼ˆæ— å…¬å…±æ„é€ å‡½æ•°ï¼‰ï¼Œéœ€é€šè¿‡ MemoryExtensions.AsSpan æ–¹æ³•å°†å­—ç¬¦ä¸²ã€æ•°ç»„ã€åˆ—è¡¨ç­‰è½¬ä¸º ReadOnlySpan&lt;T&gt;ã€‚</p><h3 id="å‰ç½®æ¡ä»¶ï¼šå®‰è£…ä¾èµ–ï¼ˆä½ç‰ˆæœ¬-NET-éœ€å¤„ç†ï¼‰"><a href="#å‰ç½®æ¡ä»¶ï¼šå®‰è£…ä¾èµ–ï¼ˆä½ç‰ˆæœ¬-NET-éœ€å¤„ç†ï¼‰" class="headerlink" title="å‰ç½®æ¡ä»¶ï¼šå®‰è£…ä¾èµ–ï¼ˆä½ç‰ˆæœ¬ .NET éœ€å¤„ç†ï¼‰"></a>å‰ç½®æ¡ä»¶ï¼šå®‰è£…ä¾èµ–ï¼ˆä½ç‰ˆæœ¬ .NET éœ€å¤„ç†ï¼‰</h3><p>è‹¥ä½ çš„ .NET ç‰ˆæœ¬ï¼ˆå¦‚ .NET Framework 4.xï¼‰æœªå†…ç½® MemoryExtensionsï¼Œéœ€å…ˆå®‰è£… NuGet åŒ…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Install-Package System.Memory</span><br><span class="line"><span class="comment"># æˆ– .NET CLI</span></span><br><span class="line">dotnet add package System.Memory</span><br></pre></td></tr></table></figure><h3 id="1-å­—ç¬¦ä¸²è½¬-ReadOnlySpan"><a href="#1-å­—ç¬¦ä¸²è½¬-ReadOnlySpan" class="headerlink" title="1. å­—ç¬¦ä¸²è½¬ ReadOnlySpan&lt;char&gt;"></a>1. å­—ç¬¦ä¸²è½¬ ReadOnlySpan&lt;char&gt;</h3><p>å­—ç¬¦ä¸²æœ¬è´¨æ˜¯ char æ•°ç»„ï¼Œè½¬æ¢åå¯ç›´æ¥æ“ä½œå­—ç¬¦ç‰‡æ®µï¼Œä¸”æ— å­—ç¬¦ä¸²æ‹·è´å¼€é”€ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="built_in">string</span> originalStr = <span class="string">&quot;Hello ReadOnlySpan!&quot;</span>;</span><br><span class="line"><span class="comment">// è½¬ä¸º ReadOnlySpan&lt;char&gt;</span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">char</span>&gt; strSpan = originalStr.AsSpan(); <span class="comment">// ç­‰ä»·äº MemoryExtensions.AsSpan(originalStr)</span></span><br><span class="line"></span><br><span class="line">Console.WriteLine(strSpan); <span class="comment">// è¾“å‡ºï¼šHello ReadOnlySpan!</span></span><br></pre></td></tr></table></figure><h3 id="2-æ•°ç»„è½¬-ReadOnlySpan"><a href="#2-æ•°ç»„è½¬-ReadOnlySpan" class="headerlink" title="2. æ•°ç»„è½¬ ReadOnlySpan&lt;T&gt;"></a>2. æ•°ç»„è½¬ ReadOnlySpan&lt;T&gt;</h3><p>ä»»æ„æ•°ç»„ï¼ˆå¦‚ int[]ã€byte[]ï¼‰å‡å¯ç›´æ¥è½¬æ¢ï¼Œé€‚é…ä»»æ„å€¼ç±»å‹&#x2F;å¼•ç”¨ç±»å‹ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹ int æ•°ç»„</span></span><br><span class="line"><span class="built_in">int</span>[] numArray = <span class="keyword">new</span> <span class="built_in">int</span>[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line"><span class="comment">// è½¬ä¸º ReadOnlySpan&lt;int&gt;</span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">int</span>&gt; arraySpan = numArray.AsSpan();</span><br><span class="line"></span><br><span class="line">Console.WriteLine(arraySpan.Length); <span class="comment">// è¾“å‡ºï¼š5</span></span><br></pre></td></tr></table></figure><h3 id="3-List-è½¬-ReadOnlySpan"><a href="#3-List-è½¬-ReadOnlySpan" class="headerlink" title="3. List&lt;T&gt; è½¬ ReadOnlySpan&lt;T&gt;"></a>3. List&lt;T&gt; è½¬ ReadOnlySpan&lt;T&gt;</h3><p>è‹¥è¦å°† List&lt;T&gt; è½¬ä¸º ReadOnlySpan&lt;T&gt;ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å®ç°ï¼š</p><ol><li>å…ˆå°† List&lt;T&gt; é€šè¿‡ ToArray() è½¬ä¸ºæ•°ç»„ï¼ˆå›  List å†…å­˜éç»å¯¹è¿ç»­ï¼‰ï¼Œå†è½¬ ReadOnlySpan&lt;T&gt;ï¼š</li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹ List&lt;string&gt;</span></span><br><span class="line">List&lt;<span class="built_in">string</span>&gt; strList = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt; &#123; <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span> &#125;;</span><br><span class="line"><span class="comment">// List â†’ æ•°ç»„ â†’ ReadOnlySpan&lt;T&gt;</span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">string</span>&gt; listSpan = strList.ToArray().AsSpan();</span><br><span class="line"></span><br><span class="line">Console.WriteLine(listSpan[<span class="number">1</span>]); <span class="comment">// è¾“å‡ºï¼šb</span></span><br></pre></td></tr></table></figure><ol start="2"><li>é€šè¿‡ CollectionsMarshal.AsSpan&lt;T&gt;(List&lt;T&gt;) è½¬ä¸º ReadOnlySpan&lt;T&gt;ï¼š</li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹ List&lt;string&gt;</span></span><br><span class="line">List&lt;<span class="built_in">string</span>&gt; strList = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt; &#123; <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span> &#125;;</span><br><span class="line"><span class="comment">// List â†’ æ•°ç»„ â†’ ReadOnlySpan&lt;T&gt;</span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">string</span>&gt; listSpan = CollectionsMarshal.AsSpan(strList);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(listSpan[<span class="number">1</span>]); <span class="comment">// è¾“å‡ºï¼šb</span></span><br></pre></td></tr></table></figure><blockquote><p>CollectionsMarshal ç±»éœ€è¦ .NET 5+ æ‰èƒ½ä½¿ç”¨ï¼Œæˆ–è€…é€šè¿‡ NuGet å®‰è£…åŒ… System.Runtime.InteropServicesï¼ˆæœªæµ‹è¯•è¿‡ï¼Œä¸ç¡®å®šå­˜ä¸å­˜åœ¨ CollectionsMarshal ç±»ï¼‰ã€‚</p></blockquote><h2 id="ä¸‰ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨-ReadOnlySpanï¼Ÿæ ¸å¿ƒä¼˜åŠ¿"><a href="#ä¸‰ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨-ReadOnlySpanï¼Ÿæ ¸å¿ƒä¼˜åŠ¿" class="headerlink" title="ä¸‰ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ ReadOnlySpan&lt;T&gt;ï¼Ÿæ ¸å¿ƒä¼˜åŠ¿"></a>ä¸‰ã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ ReadOnlySpan&lt;T&gt;ï¼Ÿæ ¸å¿ƒä¼˜åŠ¿</h2><p>ç›¸æ¯”ç›´æ¥æ“ä½œå­—ç¬¦ä¸²ã€æ•°ç»„ï¼ŒReadOnlySpan&lt;T&gt; æœ€å¤§çš„ä»·å€¼æ˜¯<strong>é›¶æ‹·è´ + ä½ GC å¼€é”€</strong>ï¼Œå…·ä½“ä¼˜åŠ¿å¦‚ä¸‹ï¼š</p><h3 id="1-æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“"><a href="#1-æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“" class="headerlink" title="1. æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“"></a>1. æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“</h3><table><thead><tr><th>ä¼˜åŠ¿</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>é›¶å†…å­˜æ‹·è´</td><td>æ“ä½œå†…å­˜ç‰‡æ®µæ—¶ï¼ˆå¦‚æˆªå–å­ä¸²ã€å–æ•°ç»„ç‰‡æ®µï¼‰ï¼Œä»…ä¿®æ”¹â€œè§†å›¾èŒƒå›´â€ï¼Œä¸å¤åˆ¶åŸæ•°æ®</td></tr><tr><td>æ—  GC å‹åŠ›</td><td>æ ˆåˆ†é…ç±»å‹ï¼Œå®ä¾‹æ— éœ€ GC å›æ”¶ï¼›é¿å…é¢‘ç¹åˆ›å»ºä¸´æ—¶å­—ç¬¦ä¸²&#x2F;æ•°ç»„å¯¼è‡´çš„ GC è§¦å‘</td></tr><tr><td>å†…å­˜å®‰å…¨</td><td>åªè¯»ç‰¹æ€§é˜²æ­¢æ„å¤–ä¿®æ”¹åŸæ•°æ®ï¼Œç´¢å¼•è¶Šç•Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å†…å­˜è¶Šè®¿é—®</td></tr><tr><td>é«˜æ€§èƒ½</td><td>ç›´æ¥æ“ä½œå†…å­˜åœ°å€ï¼Œæ¯”ä¼ ç»Ÿå­—ç¬¦ä¸²&#x2F;æ•°ç»„æ–¹æ³•ï¼ˆå¦‚ string.Substringï¼‰å¿«æ•°å€</td></tr></tbody></table><h3 id="2-å¯¹æ¯”-stringï¼šæ•ˆç‡å¤§å¹…æå‡"><a href="#2-å¯¹æ¯”-stringï¼šæ•ˆç‡å¤§å¹…æå‡" class="headerlink" title="2. å¯¹æ¯” stringï¼šæ•ˆç‡å¤§å¹…æå‡"></a>2. å¯¹æ¯” stringï¼šæ•ˆç‡å¤§å¹…æå‡</h3><p>ä¼ ç»Ÿ string æ˜¯ä¸å¯å˜ç±»å‹ï¼Œè°ƒç”¨ Substringã€Split ç­‰æ–¹æ³•æ—¶ï¼Œä¼šåˆ›å»º<strong>æ–°å­—ç¬¦ä¸²å®ä¾‹</strong>ï¼ˆæ‹·è´åŸå­—ç¬¦æ•°æ®ï¼‰ï¼Œé«˜é¢‘æ“ä½œæ—¶ä¼šäº§ç”Ÿå¤§é‡ä¸´æ—¶å¯¹è±¡ï¼Œè§¦å‘é¢‘ç¹ GCã€‚</p><p>è€Œ ReadOnlySpan&lt;char&gt; æ“ä½œå­—ç¬¦ä¸²æ—¶æ— æ‹·è´ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼ï¼šåˆ›å»ºæ–°å­—ç¬¦ä¸²ï¼ˆæ‹·è´æ•°æ®ï¼‰</span></span><br><span class="line"><span class="built_in">string</span> original = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line"><span class="built_in">string</span> subStr = original.Substring(<span class="number">0</span>, <span class="number">5</span>); <span class="comment">// ç”Ÿæˆæ–°å­—ç¬¦ä¸² &quot;Hello&quot;ï¼Œæ‹·è´5ä¸ªå­—ç¬¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ReadOnlySpan æ–¹å¼ï¼šé›¶æ‹·è´ï¼Œä»…è°ƒæ•´è§†å›¾èŒƒå›´</span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">char</span>&gt; span = original.AsSpan();</span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">char</span>&gt; subSpan = span.Slice(<span class="number">0</span>, <span class="number">5</span>); <span class="comment">// æ— æ‹·è´ï¼Œä»…æŒ‡å‘åŸå­—ç¬¦ä¸²çš„å‰5ä¸ªå­—ç¬¦</span></span><br></pre></td></tr></table></figure><blockquote><p>è¡¥å……ï¼šé«˜ç‰ˆæœ¬ .NET çš„ string å†…ç½®æ–¹æ³•ï¼ˆå¦‚ Substringï¼‰å·²åº•å±‚é€‚é… ReadOnlySpan&lt;char&gt;ï¼Œä½†ä½ç‰ˆæœ¬ .NET ä»ä¸ºæ‹·è´å®ç°â€”â€”å› æ­¤ä½ç‰ˆæœ¬ä¸­æ‰‹åŠ¨ç”¨ ReadOnlySpan&lt;char&gt; ä¼˜åŒ–æ•ˆæœæ›´æ˜¾è‘—ã€‚</p></blockquote><h3 id="3-å¯¹æ¯”æ•°ç»„-åˆ—è¡¨ï¼šæ›´è½»é‡çš„å†…å­˜æ“ä½œ"><a href="#3-å¯¹æ¯”æ•°ç»„-åˆ—è¡¨ï¼šæ›´è½»é‡çš„å†…å­˜æ“ä½œ" class="headerlink" title="3. å¯¹æ¯”æ•°ç»„&#x2F;åˆ—è¡¨ï¼šæ›´è½»é‡çš„å†…å­˜æ“ä½œ"></a>3. å¯¹æ¯”æ•°ç»„&#x2F;åˆ—è¡¨ï¼šæ›´è½»é‡çš„å†…å­˜æ“ä½œ</h3><p>ç›´æ¥æ“ä½œæ•°ç»„æ—¶ï¼Œæˆªå–ç‰‡æ®µï¼ˆå¦‚ Array.Copyï¼‰éœ€æ‹·è´æ•°æ®ï¼›è€Œ ReadOnlySpan&lt;T&gt; ä»…é€šè¿‡ Slice æ–¹æ³•è°ƒæ•´è§†å›¾ï¼Œæ— æ‹·è´å¼€é”€ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span>[] nums = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼ï¼šæ‹·è´æ•°ç»„ç‰‡æ®µï¼ˆåˆ›å»ºæ–°æ•°ç»„ï¼‰</span></span><br><span class="line"><span class="built_in">int</span>[] subNums = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">3</span>];</span><br><span class="line">Array.Copy(nums, <span class="number">1</span>, subNums, <span class="number">0</span>, <span class="number">3</span>); <span class="comment">// æ‹·è´ç´¢å¼•1-3çš„å…ƒç´ ï¼Œç”Ÿæˆæ–°æ•°ç»„ [2,3,4]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ReadOnlySpan æ–¹å¼ï¼šé›¶æ‹·è´ï¼Œä»…å®šä¹‰è§†å›¾</span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">int</span>&gt; subSpan = nums.AsSpan().Slice(<span class="number">1</span>, <span class="number">3</span>); <span class="comment">// ç›´æ¥æŒ‡å‘åŸæ•°ç»„çš„ç´¢å¼•1-3ï¼Œæ— æ‹·è´</span></span><br></pre></td></tr></table></figure><h2 id="å››ã€ReadOnlySpan-æ ¸å¿ƒå±æ€§ï¼ˆæ¡ˆä¾‹ï¼šstringï¼‰"><a href="#å››ã€ReadOnlySpan-æ ¸å¿ƒå±æ€§ï¼ˆæ¡ˆä¾‹ï¼šstringï¼‰" class="headerlink" title="å››ã€ReadOnlySpan&lt;T&gt; æ ¸å¿ƒå±æ€§ï¼ˆæ¡ˆä¾‹ï¼šstringï¼‰"></a>å››ã€ReadOnlySpan&lt;T&gt; æ ¸å¿ƒå±æ€§ï¼ˆæ¡ˆä¾‹ï¼šstringï¼‰</h2><p>ä»…ä»‹ç»é«˜é¢‘ä½¿ç”¨çš„ 2 ä¸ªæ ¸å¿ƒå±æ€§ï¼Œæ¡ˆä¾‹åŸºäºå­—ç¬¦ä¸²åœºæ™¯ï¼š</p><h3 id="1-Item-Int32-ï¼šè·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ "><a href="#1-Item-Int32-ï¼šè·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ " class="headerlink" title="1. Item[Int32]ï¼šè·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ "></a>1. Item[Int32]ï¼šè·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ </h3><p>é€šè¿‡ç´¢å¼•è®¿é—® ReadOnlySpan&lt;T&gt; ä¸­çš„å…ƒç´ ï¼Œè¯­æ³•ä¸æ•°ç»„ä¸€è‡´ï¼Œ<strong>åªè¯»ä¸å¯æ”¹</strong>ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> text = <span class="string">&quot;C# ReadOnlySpan Tutorial&quot;</span>;</span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">char</span>&gt; textSpan = text.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç´¢å¼•2çš„å­—ç¬¦ï¼ˆç´¢å¼•ä»0å¼€å§‹ï¼‰</span></span><br><span class="line"><span class="built_in">char</span> charAt2 = textSpan[<span class="number">2</span>]; </span><br><span class="line">Console.WriteLine(charAt2); <span class="comment">// è¾“å‡ºï¼šç©ºæ ¼ï¼ˆ&quot;C# &quot; çš„ç¬¬ä¸‰ä¸ªå­—ç¬¦ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•ä¿®æ”¹ä¼šç¼–è¯‘æŠ¥é”™ï¼šReadOnlySpan åªè¯»</span></span><br><span class="line"><span class="comment">// textSpan[2] = &#x27;x&#x27;; // é”™è¯¯ï¼šæ— æ³•ç»™åªè¯»ç´¢å¼•å™¨èµ‹å€¼</span></span><br></pre></td></tr></table></figure><h3 id="2-Lengthï¼šè·å–åªè¯»èŒƒå›´çš„å…ƒç´ æ•°é‡"><a href="#2-Lengthï¼šè·å–åªè¯»èŒƒå›´çš„å…ƒç´ æ•°é‡" class="headerlink" title="2. Lengthï¼šè·å–åªè¯»èŒƒå›´çš„å…ƒç´ æ•°é‡"></a>2. Lengthï¼šè·å–åªè¯»èŒƒå›´çš„å…ƒç´ æ•°é‡</h3><p>è¿”å› ReadOnlySpan&lt;T&gt; åŒ…å«çš„å…ƒç´ æ€»æ•°ï¼Œç­‰ä»·äºåŸæ•°æ®çš„æœ‰æ•ˆé•¿åº¦ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> text = <span class="string">&quot;Hello ReadOnlySpan&quot;</span>;</span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">char</span>&gt; textSpan = text.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–é•¿åº¦</span></span><br><span class="line"><span class="built_in">int</span> length = textSpan.Length;</span><br><span class="line">Console.WriteLine(length); <span class="comment">// è¾“å‡ºï¼š17ï¼ˆ&quot;Hello ReadOnlySpan&quot; å…±17ä¸ªå­—ç¬¦ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç©º Span çš„ Length ä¸º 0</span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">char</span>&gt; emptySpan = ReadOnlySpan&lt;<span class="built_in">char</span>&gt;.Empty;</span><br><span class="line">Console.WriteLine(emptySpan.Length); <span class="comment">// è¾“å‡ºï¼š0</span></span><br></pre></td></tr></table></figure><h2 id="äº”ã€ReadOnlySpan-æ ¸å¿ƒæ–¹æ³•ï¼ˆæ¡ˆä¾‹ï¼šæ•°ç»„ï¼‰"><a href="#äº”ã€ReadOnlySpan-æ ¸å¿ƒæ–¹æ³•ï¼ˆæ¡ˆä¾‹ï¼šæ•°ç»„ï¼‰" class="headerlink" title="äº”ã€ReadOnlySpan&lt;T&gt; æ ¸å¿ƒæ–¹æ³•ï¼ˆæ¡ˆä¾‹ï¼šæ•°ç»„ï¼‰"></a>äº”ã€ReadOnlySpan&lt;T&gt; æ ¸å¿ƒæ–¹æ³•ï¼ˆæ¡ˆä¾‹ï¼šæ•°ç»„ï¼‰</h2><p>ä»¥ä¸‹æ–¹æ³•å‡åŸºäº int[] æ•°ç»„æ¡ˆä¾‹ï¼Œèšç„¦é«˜é¢‘ä½¿ç”¨çš„ 4 ä¸ªæ–¹æ³•ï¼š</p><h3 id="1-CopyTo-Span-ï¼šå¤åˆ¶å†…å®¹åˆ°ç›®æ ‡-Span"><a href="#1-CopyTo-Span-ï¼šå¤åˆ¶å†…å®¹åˆ°ç›®æ ‡-Span" class="headerlink" title="1. CopyTo(Span&lt;T&gt;)ï¼šå¤åˆ¶å†…å®¹åˆ°ç›®æ ‡ Span&lt;T&gt;"></a>1. CopyTo(Span&lt;T&gt;)ï¼šå¤åˆ¶å†…å®¹åˆ°ç›®æ ‡ Span&lt;T&gt;</h3><p>å°† ReadOnlySpan&lt;T&gt; çš„å†…å®¹å¤åˆ¶åˆ°å¯å†™çš„ Span&lt;T&gt;ï¼ˆéœ€ä¿è¯ç›®æ ‡ Span é•¿åº¦è¶³å¤Ÿï¼Œå¦åˆ™æŠ›å¼‚å¸¸ï¼‰ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æºæ•°ç»„ â†’ ReadOnlySpan&lt;int&gt;</span></span><br><span class="line"><span class="built_in">int</span>[] source = &#123; <span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span> &#125;;</span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">int</span>&gt; sourceSpan = source.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›®æ ‡ Spanï¼ˆé•¿åº¦éœ€ â‰¥ æº Spanï¼‰</span></span><br><span class="line"><span class="built_in">int</span>[] target = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">4</span>];</span><br><span class="line">Span&lt;<span class="built_in">int</span>&gt; targetSpan = target.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤åˆ¶å†…å®¹</span></span><br><span class="line">sourceSpan.CopyTo(targetSpan);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºç›®æ ‡æ•°ç»„ï¼š[10,20,30,40]</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, target)); </span><br></pre></td></tr></table></figure><h3 id="2-TryCopyTo-Span-ï¼šå®‰å…¨å¤åˆ¶ï¼ˆè¿”å›æ“ä½œç»“æœï¼‰"><a href="#2-TryCopyTo-Span-ï¼šå®‰å…¨å¤åˆ¶ï¼ˆè¿”å›æ“ä½œç»“æœï¼‰" class="headerlink" title="2. TryCopyTo(Span&lt;T&gt;)ï¼šå®‰å…¨å¤åˆ¶ï¼ˆè¿”å›æ“ä½œç»“æœï¼‰"></a>2. TryCopyTo(Span&lt;T&gt;)ï¼šå®‰å…¨å¤åˆ¶ï¼ˆè¿”å›æ“ä½œç»“æœï¼‰</h3><p>ä¸ CopyTo åŠŸèƒ½ä¸€è‡´ï¼Œä½†ä¸ä¼šæŠ›å¼‚å¸¸â€”â€”è‹¥ç›®æ ‡ Span é•¿åº¦ä¸è¶³ï¼Œè¿”å› falseï¼Œå¦åˆ™è¿”å› trueï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span>[] source = &#123; <span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span> &#125;;</span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">int</span>&gt; sourceSpan = source.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›®æ ‡ Span é•¿åº¦ä¸è¶³ï¼ˆä»…3ä¸ªå…ƒç´ ï¼‰</span></span><br><span class="line"><span class="built_in">int</span>[] target = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">3</span>];</span><br><span class="line">Span&lt;<span class="built_in">int</span>&gt; targetSpan = target.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•å¤åˆ¶</span></span><br><span class="line"><span class="built_in">bool</span> isSuccess = sourceSpan.TryCopyTo(targetSpan);</span><br><span class="line">Console.WriteLine(isSuccess); <span class="comment">// è¾“å‡ºï¼šFalseï¼ˆé•¿åº¦ä¸è¶³ï¼Œå¤åˆ¶å¤±è´¥ï¼‰</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, target)); <span class="comment">// è¾“å‡ºï¼š0,0,0ï¼ˆæ— æ•°æ®å¤åˆ¶ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒæ•´ç›®æ ‡é•¿åº¦åé‡è¯•</span></span><br><span class="line"><span class="built_in">int</span>[] target2 = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">4</span>];</span><br><span class="line"><span class="built_in">bool</span> isSuccess2 = sourceSpan.TryCopyTo(target2.AsSpan());</span><br><span class="line">Console.WriteLine(isSuccess2); <span class="comment">// è¾“å‡ºï¼šTrue</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, target2)); <span class="comment">// è¾“å‡ºï¼š10,20,30,40</span></span><br></pre></td></tr></table></figure><h3 id="3-Slice-Int32-ï¼šä»æŒ‡å®šç´¢å¼•å¼€å§‹æˆªå–ç‰‡æ®µ"><a href="#3-Slice-Int32-ï¼šä»æŒ‡å®šç´¢å¼•å¼€å§‹æˆªå–ç‰‡æ®µ" class="headerlink" title="3. Slice(Int32)ï¼šä»æŒ‡å®šç´¢å¼•å¼€å§‹æˆªå–ç‰‡æ®µ"></a>3. Slice(Int32)ï¼šä»æŒ‡å®šç´¢å¼•å¼€å§‹æˆªå–ç‰‡æ®µ</h3><p>æˆªå–ä» startIndex åˆ°æœ«å°¾çš„æ‰€æœ‰å…ƒç´ ï¼Œé›¶æ‹·è´ä»…è°ƒæ•´è§†å›¾ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span>[] nums = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">int</span>&gt; numSpan = nums.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»ç´¢å¼•2å¼€å§‹æˆªå–ï¼ˆåŒ…å«ç´¢å¼•2ï¼‰</span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">int</span>&gt; sliceSpan = numSpan.Slice(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºï¼š3,4,5ï¼ˆç´¢å¼•2ã€3ã€4çš„å…ƒç´ ï¼‰</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, sliceSpan)); </span><br></pre></td></tr></table></figure><h3 id="4-Slice-Int32-Int32-ï¼šæŒ‡å®šç´¢å¼•-é•¿åº¦æˆªå–ç‰‡æ®µ"><a href="#4-Slice-Int32-Int32-ï¼šæŒ‡å®šç´¢å¼•-é•¿åº¦æˆªå–ç‰‡æ®µ" class="headerlink" title="4. Slice(Int32, Int32)ï¼šæŒ‡å®šç´¢å¼•+é•¿åº¦æˆªå–ç‰‡æ®µ"></a>4. Slice(Int32, Int32)ï¼šæŒ‡å®šç´¢å¼•+é•¿åº¦æˆªå–ç‰‡æ®µ</h3><p>æˆªå–ä» startIndex å¼€å§‹ã€é•¿åº¦ä¸º length çš„ç‰‡æ®µï¼Œéœ€ä¿è¯ startIndex + length â‰¤ åŸ Span é•¿åº¦ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span>[] nums = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">int</span>&gt; numSpan = nums.AsSpan();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»ç´¢å¼•1å¼€å§‹ï¼Œæˆªå–3ä¸ªå…ƒç´ </span></span><br><span class="line">ReadOnlySpan&lt;<span class="built_in">int</span>&gt; sliceSpan = numSpan.Slice(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºï¼š2,3,4ï¼ˆç´¢å¼•1ã€2ã€3çš„å…ƒç´ ï¼‰</span></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, sliceSpan)); </span><br><span class="line"></span><br><span class="line"><span class="comment">// ç´¢å¼•è¶Šç•Œä¼šæŠ›å¼‚å¸¸</span></span><br><span class="line"><span class="comment">// numSpan.Slice(1, 5); // é”™è¯¯ï¼šé•¿åº¦è¶…å‡ºèŒƒå›´</span></span><br></pre></td></tr></table></figure><h3 id="è¡¥å……ï¼šå…¶ä»–å¸¸ç”¨æ–¹æ³•"><a href="#è¡¥å……ï¼šå…¶ä»–å¸¸ç”¨æ–¹æ³•" class="headerlink" title="è¡¥å……ï¼šå…¶ä»–å¸¸ç”¨æ–¹æ³•"></a>è¡¥å……ï¼šå…¶ä»–å¸¸ç”¨æ–¹æ³•</h3><p>ReadOnlySpan&lt;T&gt; è¿˜å†…ç½®äº†å¤§é‡å®ç”¨æ–¹æ³•ï¼Œå¯å‚è€ƒå®˜æ–¹æ–‡æ¡£&#x2F;ç½‘ç»œæ•™ç¨‹ï¼š</p><ul><li>Contains(T)ï¼šåˆ¤æ–­æ˜¯å¦åŒ…å«æŒ‡å®šå…ƒç´ ï¼›</li><li>StartsWith(ReadOnlySpan&lt;T&gt;)ï¼šåˆ¤æ–­æ˜¯å¦ä»¥æŒ‡å®šç‰‡æ®µå¼€å¤´ï¼›</li><li>EndsWith(ReadOnlySpan&lt;T&gt;)ï¼šåˆ¤æ–­æ˜¯å¦ä»¥æŒ‡å®šç‰‡æ®µç»“å°¾ï¼›</li><li>IndexOf(T)ï¼šæŸ¥æ‰¾æŒ‡å®šå…ƒç´ çš„ç¬¬ä¸€ä¸ªç´¢å¼•ï¼›</li><li>LastIndexOf(T)ï¼šæŸ¥æ‰¾æŒ‡å®šå…ƒç´ çš„æœ€åä¸€ä¸ªç´¢å¼•ã€‚</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>ReadOnlySpan&lt;T&gt; æ˜¯åªè¯»çš„å†…å­˜è§†å›¾ï¼Œé€šè¿‡ AsSpan() ä»å­—ç¬¦ä¸²&#x2F;æ•°ç»„&#x2F;åˆ—è¡¨è½¬æ¢ï¼Œä½ç‰ˆæœ¬éœ€å®‰è£… System.Memoryï¼›</li><li>æ ¸å¿ƒä¼˜åŠ¿æ˜¯é›¶æ‹·è´ã€ä½ GC å¼€é”€ï¼Œç›¸æ¯”ä¼ ç»Ÿå­—ç¬¦ä¸²&#x2F;æ•°ç»„æ“ä½œæ•ˆç‡å¤§å¹…æå‡ï¼›</li><li>æ ¸å¿ƒå±æ€§ï¼šItem[Int32]ï¼ˆç´¢å¼•è®¿é—®ï¼‰ã€Lengthï¼ˆè·å–é•¿åº¦ï¼‰ï¼›</li><li>æ ¸å¿ƒæ–¹æ³•ï¼šCopyTo&#x2F;TryCopyToï¼ˆå¤åˆ¶ï¼‰ã€Sliceï¼ˆæˆªå–ç‰‡æ®µï¼‰ï¼Œé€‚é…é«˜æ€§èƒ½å†…å­˜æ“ä½œåœºæ™¯ã€‚</li></ol><p>ReadOnlySpan&lt;T&gt; å°¤å…¶é€‚åˆé«˜é¢‘å¤„ç†å­—ç¬¦ä¸²ã€å­—èŠ‚æ•°ç»„çš„åœºæ™¯ï¼ˆå¦‚ç½‘ç»œIOã€æ•°æ®è§£æï¼‰ï¼Œæ˜¯ C# é«˜æ€§èƒ½ç¼–ç¨‹çš„å¿…å¤‡å·¥å…·ã€‚</p><h2 id="å¤–éƒ¨é“¾æ¥"><a href="#å¤–éƒ¨é“¾æ¥" class="headerlink" title="å¤–éƒ¨é“¾æ¥"></a>å¤–éƒ¨é“¾æ¥</h2><p><a href="https://www.nuget.org/packages/System.Memory">System.Memory - NuGet Gallery</a><br><a href="https://www.nuget.org/packages/System.Runtime.InteropServices">System.Runtime.InteropServices - NuGet Gallery</a><br><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.memoryextensions?view=net-8.0">ReadOnlySpan&lt;T&gt; ç»“æ„ - Microsoft Learn</a><br><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.memoryextensions?view=net-8.0">MemoryExtensions ç±» - Microsoft Learn</a><br><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.runtime.interopservices.collectionsmarshal?view=net-9.0">CollectionsMarshal ç±» - Microsoft Learn</a></p>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> ReadOnlySpan </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äº ArrayPool çš„ä½ åº”è¯¥äº†è§£çš„å†…å®¹</title>
      <link href="/2026/01/17/arraypool-what-you-should-know/"/>
      <url>/2026/01/17/arraypool-what-you-should-know/</url>
      
        <content type="html"><![CDATA[<h3 id="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-17-15-30-37"><a href="#æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-17-15-30-37" class="headerlink" title="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-17 15:30:37"></a><strong>æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-17 15:30:37</strong></h3><hr><h2 id="ArrayPool-Rent-æ–¹æ³•ï¼šæ˜¯å¦éœ€è¦-try-catchï¼Ÿæºç è§†è§’çš„ç»ˆæè§£ç­”"><a href="#ArrayPool-Rent-æ–¹æ³•ï¼šæ˜¯å¦éœ€è¦-try-catchï¼Ÿæºç è§†è§’çš„ç»ˆæè§£ç­”" class="headerlink" title="ArrayPool&lt;T&gt;.Rent æ–¹æ³•ï¼šæ˜¯å¦éœ€è¦ try-catchï¼Ÿæºç è§†è§’çš„ç»ˆæè§£ç­”"></a>ArrayPool&lt;T&gt;.Rent æ–¹æ³•ï¼šæ˜¯å¦éœ€è¦ try-catchï¼Ÿæºç è§†è§’çš„ç»ˆæè§£ç­”</h2><p>åœ¨ä½¿ç”¨ ArrayPool&lt;T&gt;.Shared.Rent(int minimumLength) æ—¶ï¼Œå¾ˆå¤šå¼€å‘è€…ä¼šçº ç»“â€œæ˜¯å¦éœ€è¦ç”¨ try-catch åŒ…è£¹â€ã€‚ä»¥ä¸‹ç»“åˆ ArrayPool æºç ï¼Œä»â€œé£é™©åœºæ™¯ã€æŠ¥é”™æ¡ä»¶ã€ç‰¹æ®Šæƒ…å†µâ€ä¸‰æ–¹é¢ï¼Œæ˜ç¡®æœ€ä½³å®è·µå’Œä»£ç å†™æ³•ã€‚</p><h3 id="ä¸€ã€æ— æºç è®¤çŸ¥æ—¶çš„å®‰å…¨å†™æ³•"><a href="#ä¸€ã€æ— æºç è®¤çŸ¥æ—¶çš„å®‰å…¨å†™æ³•" class="headerlink" title="ä¸€ã€æ— æºç è®¤çŸ¥æ—¶çš„å®‰å…¨å†™æ³•"></a>ä¸€ã€æ— æºç è®¤çŸ¥æ—¶çš„å®‰å…¨å†™æ³•</h3><p>å¦‚æœä¸äº†è§£ Rent æ–¹æ³•çš„åº•å±‚é€»è¾‘ï¼Œæœ€ç¨³å¦¥çš„ä»£ç å®ç°å¦‚ä¸‹ï¼ˆæ ¸å¿ƒæ˜¯â€œç¡®ä¿æ•°ç»„æœ€ç»ˆå½’è¿˜â€ï¼‰ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">byte</span>[]? buffer = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å°è¯•ä»å¯¹è±¡æ± ç§Ÿå€Ÿæ•°ç»„</span></span><br><span class="line">    buffer = ArrayPool&lt;<span class="built_in">byte</span>&gt;.Shared.Rent(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸šåŠ¡é€»è¾‘ï¼šä½¿ç”¨æ•°ç»„å¤„ç†æ•°æ®</span></span><br><span class="line">    buffer[<span class="number">0</span>] = <span class="number">123</span>;</span><br><span class="line">    buffer[<span class="number">1</span>] = <span class="number">234</span>;</span><br><span class="line">    buffer[<span class="number">2</span>] = <span class="number">255</span>;</span><br><span class="line">    <span class="comment">// ... å…¶ä»–æ•°æ®å¤„ç†</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å…³é”®ï¼šæ— è®ºæ˜¯å¦æŠ¥é”™ï¼Œéƒ½å¿…é¡»å½’è¿˜æ•°ç»„ï¼ˆé¿å…æ± èµ„æºæ³„æ¼ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (buffer != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ArrayPool&lt;<span class="built_in">byte</span>&gt;.Shared.Return(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒç›®çš„ï¼šä¸ç¡®å®š Rent æ˜¯å¦ä¼šæŠ›å¼‚å¸¸ã€ä¸šåŠ¡é€»è¾‘æ˜¯å¦ä¼šå‡ºé”™ï¼Œç”¨ try-finally ä¿è¯æ•°ç»„â€œç§Ÿå€Ÿ-å½’è¿˜â€çš„é—­ç¯ï¼Œé¿å…å¯¹è±¡æ± èµ„æºè€—å°½ã€‚</p><h3 id="äºŒã€æºç è§†è§’ï¼šRent-æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ï¼ˆå†³å®šæ˜¯å¦éœ€è¦-try-catchï¼‰"><a href="#äºŒã€æºç è§†è§’ï¼šRent-æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ï¼ˆå†³å®šæ˜¯å¦éœ€è¦-try-catchï¼‰" class="headerlink" title="äºŒã€æºç è§†è§’ï¼šRent æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ï¼ˆå†³å®šæ˜¯å¦éœ€è¦ try-catchï¼‰"></a>äºŒã€æºç è§†è§’ï¼šRent æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ï¼ˆå†³å®šæ˜¯å¦éœ€è¦ try-catchï¼‰</h3><p>é€šè¿‡åˆ†æ ArrayPool æºç ï¼Œå¯æ˜ç¡® Rent çš„æŠ¥é”™åœºæ™¯ã€èµ„æºè€—å°½å¤„ç†ã€ç‰¹æ®Šå‚æ•°å¤„ç†ï¼Œè¿›è€Œåˆ¤æ–­ try-catch çš„å¿…è¦æ€§ã€‚</p><ol><li><strong>å¯¹è±¡æ± â€œæ— å¯ç”¨æ•°ç»„â€æ—¶ï¼šä¸ä¼šæŠ¥é”™ï¼Œè‡ªåŠ¨æ–°å»ºæ•°ç»„</strong></li></ol><p>å¾ˆå¤šäººæ‹…å¿ƒâ€œé¢‘ç¹ Rent ä¸ Returnï¼Œå¯¼è‡´æ± ä¸ºç©ºæ—¶ä¼šæŠ¥é”™â€â€”â€”ä½†æºç å·²å¤„ç†æ­¤åœºæ™¯ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æºç æ ¸å¿ƒé€»è¾‘ï¼šæ± æ— å¯ç”¨æ•°ç»„æ—¶çš„é™çº§å¤„ç†</span></span><br><span class="line">T[]? buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... å°è¯•ä»å¯¹è±¡æ± çš„å¯¹åº”æ¡¶ä¸­è·å–æ•°ç»„ï¼ˆçœç•¥æ± æŸ¥æ‰¾é€»è¾‘ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é™çº§ï¼šç›´æ¥æ–°å»ºæ•°ç»„ï¼ˆåŒºåˆ†åŸºå…ƒç±»å‹ä¼˜åŒ–ï¼‰</span></span><br><span class="line">buffer = <span class="keyword">typeof</span>(T).IsPrimitive &amp;&amp; <span class="keyword">typeof</span>(T) != <span class="keyword">typeof</span>(<span class="built_in">bool</span>) </span><br><span class="line">    ? GC.AllocateUninitializedArray&lt;T&gt;(minimumLength)  <span class="comment">// åŸºå…ƒç±»å‹ï¼ˆé™¤boolï¼‰ï¼šæ— é›¶åˆå§‹åŒ–ï¼Œæ€§èƒ½æ›´ä¼˜</span></span><br><span class="line">    : <span class="keyword">new</span> T[minimumLength];  <span class="comment">// å…¶ä»–ç±»å‹ï¼šå¸¸è§„é›¶åˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure><p>ç»“è®ºï¼šå¯¹è±¡æ± è€—å°½æ—¶ï¼ŒRent ä¼šè‡ªåŠ¨æ–°å»ºæ•°ç»„è¿”å›ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ã€‚</p><p><strong>å…³é”®è¯´æ˜</strong>ï¼š</p><ul><li>Type.IsPrimitiveï¼šåˆ¤æ–­ç±»å‹æ˜¯å¦ä¸º .NET <a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.type.isprimitive?view=net-9.0">åŸºå…ƒç±»å‹</a>ï¼›</li><li>GC.AllocateUninitializedArray&lt;T&gt;ï¼šåŠŸèƒ½ç­‰ä»·äº new T[length]ï¼Œä½†å¯¹åŸºå…ƒç±»å‹è·³è¿‡â€œé›¶åˆå§‹åŒ–â€ï¼ˆé¿å…é¢å¤–æ€§èƒ½å¼€é”€ï¼‰ã€‚</li></ul><ol start="2"><li><strong>Rent ä»…æœ‰çš„æŠ¥é”™åœºæ™¯ï¼šminimumLength &lt; 0</strong></li></ol><p>æºç æ˜ç¡®é™åˆ¶â€œè¯·æ±‚é•¿åº¦ä¸èƒ½ä¸ºè´Ÿæ•°â€ï¼Œå¦åˆ™ç›´æ¥æŠ›å¼‚å¸¸ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æºç æ ¡éªŒé€»è¾‘ï¼šè´Ÿæ•°é•¿åº¦ç›´æ¥æŠ¥é”™</span></span><br><span class="line">ArgumentOutOfRangeException.ThrowIfNegative(minimumLength);</span><br></pre></td></tr></table></figure><p><strong>å…³é”®è¯´æ˜</strong>ï¼š</p><ul><li>åªæœ‰å½“ minimumLength &lt; 0 æ—¶ï¼ŒRent æ‰ä¼šæŠ›å‡º ArgumentOutOfRangeExceptionï¼›</li><li>æ— éœ€ç”¨ try-catch æ•è·æ­¤å¼‚å¸¸ï¼šè°ƒç”¨å‰ç›´æ¥åˆ¤æ–­å‚æ•°å³å¯ï¼ˆå¼‚å¸¸æ•è·ä¼šå¢åŠ æ€§èƒ½æŸè€—ï¼‰ã€‚</li></ul><ol start="3"><li><strong>ç‰¹æ®Šæƒ…å†µï¼šminimumLength &#x3D; 0 æ—¶çš„å¤„ç†</strong></li></ol><p>å½“ä¼ å…¥ minimumLength &#x3D; 0ï¼ˆåˆæ³•å‚æ•°ï¼‰ï¼Œæºç ä¼šè¿”å›ç©ºæ•°ç»„å•ä¾‹ï¼Œä¸ä¼šæ–°å»ºæˆ–ä»æ± è·å–ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æºç é€»è¾‘ï¼šå¤„ç† 0 é•¿åº¦è¯·æ±‚</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (minimumLength == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å…è®¸ 0 é•¿åº¦è¯·æ±‚ï¼ˆè™½æ— æ± å¤ç”¨ä»·å€¼ï¼Œä½†ä¿è¯ API é€šç”¨æ€§ï¼‰</span></span><br><span class="line">    <span class="comment">// ä¸ä¼šåˆ†é…å†…å­˜ï¼Œç›´æ¥è¿”å›ç©ºæ•°ç»„å•ä¾‹ï¼Œå½’è¿˜æ—¶ä¹Ÿä¸ä¼šå­˜å…¥æ± </span></span><br><span class="line">    <span class="keyword">return</span> Array.Empty&lt;T&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®è¯´æ˜</strong>ï¼š</p><ul><li>è¿”å›å€¼æ˜¯ Array.Empty&lt;T&gt;()ï¼ˆç©ºæ•°ç»„å•ä¾‹ï¼‰ï¼Œé•¿åº¦ä¸º 0ï¼›</li><li>ä½¿ç”¨æ—¶éœ€å…ˆåˆ¤æ–­æ•°ç»„é•¿åº¦ï¼šif (buffer.Length &#x3D;&#x3D; 0)ï¼Œé¿å…ç´¢å¼•è¶Šç•Œã€‚</li></ul><h2 id="ä¸‰ã€æœ€ç»ˆç»“è®ºï¼šæ˜¯å¦éœ€è¦-try-catchï¼Ÿ"><a href="#ä¸‰ã€æœ€ç»ˆç»“è®ºï¼šæ˜¯å¦éœ€è¦-try-catchï¼Ÿ" class="headerlink" title="ä¸‰ã€æœ€ç»ˆç»“è®ºï¼šæ˜¯å¦éœ€è¦ try-catchï¼Ÿ"></a>ä¸‰ã€æœ€ç»ˆç»“è®ºï¼šæ˜¯å¦éœ€è¦ try-catchï¼Ÿ</h2><ol><li><strong>é’ˆå¯¹ Rent æ–¹æ³•æœ¬èº«ï¼šä¸éœ€è¦ try-catch</strong></li></ol><ul><li>Rent ä»…åœ¨ minimumLength &lt; 0 æ—¶æŠ›å¼‚å¸¸ï¼Œå¯æå‰åˆ¤æ–­å‚æ•°é¿å…ï¼›</li><li>æ± èµ„æºè€—å°½æ—¶ä¼šè‡ªåŠ¨æ–°å»ºæ•°ç»„ï¼Œæ— å…¶ä»–æŠ¥é”™åœºæ™¯ã€‚</li></ul><ol start="2"><li><strong>é’ˆå¯¹ä¸šåŠ¡é€»è¾‘ï¼šå»ºè®®ç”¨ try-finallyï¼ˆæ— éœ€ catchï¼‰</strong></li></ol><ul><li>æ ¸å¿ƒç›®çš„ä¸æ˜¯æ•è· Rent çš„å¼‚å¸¸ï¼Œè€Œæ˜¯<strong>ç¡®ä¿æ•°ç»„å¿…é¡»å½’è¿˜</strong>ï¼ˆå³ä½¿ä¸šåŠ¡é€»è¾‘æŠ¥é”™ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´æ± èµ„æºæ³„æ¼ï¼‰ï¼›</li><li>ä¼˜åŒ–åçš„æœ€ç»ˆå†™æ³•ï¼ˆæ— å¤šä½™ catchï¼Œä»…ç”¨ try-finally ä¿è¯å½’è¿˜ï¼‰ï¼š</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">byte</span>[]? buffer = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æå‰æ ¡éªŒå‚æ•°ï¼šé¿å… Rent æŠ›å‡ºè´Ÿæ•°å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (minimumLength &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="keyword">nameof</span>(minimumLength), <span class="string">&quot;æ•°ç»„é•¿åº¦ä¸èƒ½ä¸ºè´Ÿæ•°&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buffer = ArrayPool&lt;<span class="built_in">byte</span>&gt;.Shared.Rent(minimumLength);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸šåŠ¡é€»è¾‘ï¼ˆå¯èƒ½æŠ¥é”™ï¼Œå¦‚ç´¢å¼•è¶Šç•Œã€æ•°æ®å¤„ç†å¼‚å¸¸ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (buffer.Length &gt; <span class="number">0</span>) <span class="comment">// å¤„ç† minimumLength=0 è¿”å›ç©ºæ•°ç»„çš„æƒ…å†µ</span></span><br><span class="line">    &#123;</span><br><span class="line">        buffer[<span class="number">0</span>] = <span class="number">123</span>;</span><br><span class="line">        <span class="comment">// ... å…¶ä»–é€»è¾‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ— è®ºä¸šåŠ¡æ˜¯å¦æŠ¥é”™ï¼Œå¼ºåˆ¶å½’è¿˜æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (buffer != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ArrayPool&lt;<span class="built_in">byte</span>&gt;.Shared.Return(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››ã€å…³é”®è¡¥å……ï¼šå½’è¿˜æ•°ç»„çš„æ³¨æ„äº‹é¡¹"><a href="#å››ã€å…³é”®è¡¥å……ï¼šå½’è¿˜æ•°ç»„çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="å››ã€å…³é”®è¡¥å……ï¼šå½’è¿˜æ•°ç»„çš„æ³¨æ„äº‹é¡¹"></a>å››ã€å…³é”®è¡¥å……ï¼šå½’è¿˜æ•°ç»„çš„æ³¨æ„äº‹é¡¹</h2><ol><li>å³ä½¿ minimumLength&#x3D;0 è¿”å›ç©ºæ•°ç»„ï¼ŒReturn ä¹Ÿä¸ä¼šæŠ¥é”™ï¼ˆæºç ä¼šå¿½ç•¥ç©ºæ•°ç»„çš„å½’è¿˜ï¼Œä¸ä¼šå­˜å…¥æ± ï¼‰ï¼›</li><li>æ•°ç»„å½’è¿˜åä¸å¯å†ä½¿ç”¨ï¼šReturn åæ•°ç»„å¯èƒ½è¢«æ± å¤ç”¨ï¼Œå†æ¬¡æ“ä½œä¼šå¯¼è‡´æ•°æ®ç¯¡æ”¹ï¼›</li><li>åŸºå…ƒç±»å‹çš„æ€§èƒ½ä¼˜åŒ–ï¼šGC.AllocateUninitializedArray&lt;T&gt; æ— é›¶åˆå§‹åŒ–ï¼Œæ¯” new T[length] æ›´å¿«ï¼Œæ— éœ€æ‰‹åŠ¨ä¼˜åŒ–ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
          <category> Array </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> Array </tag>
            
            <tag> ArrayPool </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å°½é‡ä½¿ç”¨ ArrayPool ç±»</title>
      <link href="/2026/01/16/perfer-arraypool-usage/"/>
      <url>/2026/01/16/perfer-arraypool-usage/</url>
      
        <content type="html"><![CDATA[<h3 id="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-17-14-39-55"><a href="#æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-17-14-39-55" class="headerlink" title="æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-17 14:39:55"></a><strong>æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-17 14:39:55</strong></h3><hr><h2 id="ArrayPool-æ¦‚è¿°"><a href="#ArrayPool-æ¦‚è¿°" class="headerlink" title="ArrayPool æ¦‚è¿°"></a>ArrayPool æ¦‚è¿°</h2><p>ArrayPool&lt;T&gt; æ˜¯ .NET æ¡†æ¶æä¾›çš„æ•°ç»„å¯¹è±¡æ± ç±»ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯é€šè¿‡å¤ç”¨æ•°ç»„å‡å°‘å†…å­˜åˆ†é…ä¸åƒåœ¾å›æ”¶ï¼ˆGCï¼‰å¼€é”€ï¼Œæå‡é«˜æ€§èƒ½åœºæ™¯ä¸‹çš„ç¨‹åºæ•ˆç‡ã€‚</p><ul><li><strong>æ ¸å¿ƒç‰¹æ€§</strong></li></ul><ol><li>é¿å…é‡å¤åˆ›å»º &#x2F; é”€æ¯æ•°ç»„ï¼šé’ˆå¯¹é¢‘ç¹ä½¿ç”¨çŸ­ç”Ÿå‘½å‘¨æœŸæ•°ç»„çš„åœºæ™¯ï¼ˆå¦‚ç½‘ç»œä¼ è¾“ã€æ•°æ®å¤„ç†ï¼‰ï¼Œä»å¯¹è±¡æ± è·å–æ•°ç»„ï¼Œä½¿ç”¨åå½’è¿˜ï¼Œçœå»é‡å¤åˆ†é…å†…å­˜çš„æˆæœ¬ï¼›</li><li>æ³›å‹é€‚é…ï¼šæ”¯æŒä»»æ„ç±»å‹ &lt;T&gt;ï¼ˆå¦‚ ArrayPool&lt;int&gt;ã€ArrayPool&lt;byte&gt;ï¼‰ï¼Œé€‚é…ä¸åŒæ•°æ®åœºæ™¯ï¼›</li><li>å¹³è¡¡æ€§èƒ½ä¸å†…å­˜ï¼šå†…ç½®é»˜è®¤å®ç°ï¼ˆArrayPool&lt;T&gt;.Sharedï¼‰ï¼Œä¹Ÿå¯è‡ªå®šä¹‰æ± å¤§å°ã€æ•°ç»„ä¸Šé™ç­‰é…ç½®ï¼Œé¿å…å†…å­˜æµªè´¹ï¼›</li><li>çº¿ç¨‹å®‰å…¨ï¼šé»˜è®¤å®ç°æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œæ— éœ€é¢å¤–åŠ é”ã€‚</li></ol><ul><li><strong>æ ¸å¿ƒä»·å€¼</strong></li></ul><p>è§£å†³é«˜é¢‘æ•°ç»„æ“ä½œä¸­â€œé¢‘ç¹åˆ†é… - å›æ”¶â€å¯¼è‡´çš„ GC å‹åŠ›ï¼Œå°¤å…¶é€‚åˆé«˜å¹¶å‘ã€ä½å»¶è¿Ÿçš„åº”ç”¨ï¼ˆå¦‚ Web APIã€ç¼“å­˜æœåŠ¡ï¼‰ï¼Œæ˜¯ .NET æ€§èƒ½ä¼˜åŒ–çš„å…³é”®å·¥å…·ä¹‹ä¸€ã€‚</p><p>ArrayPool ç±»æºç å¦‚ä¸‹ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">ArrayPool</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ArrayPool</span>()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ArrayPool&lt;T&gt; Shared &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ArrayPool&lt;T&gt; <span class="title">Create</span>()</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ArrayPool&lt;T&gt; <span class="title">Create</span>(<span class="params"><span class="built_in">int</span> maxArrayLength, <span class="built_in">int</span> maxArraysPerBucket</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T[] <span class="title">Rent</span>(<span class="params"><span class="built_in">int</span> minimumLength</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Return</span>(<span class="params">T[] array, <span class="built_in">bool</span> clearArray = <span class="literal">false</span></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ArrayPool-ä½¿ç”¨æ•™ç¨‹"><a href="#ArrayPool-ä½¿ç”¨æ•™ç¨‹" class="headerlink" title="ArrayPool ä½¿ç”¨æ•™ç¨‹"></a>ArrayPool ä½¿ç”¨æ•™ç¨‹</h2><p>ArrayPool&lt;T&gt; æ˜¯.NET ä¸­ç”¨äºå¤ç”¨æ•°ç»„çš„å·¥å…·ç±»ï¼Œæ ¸å¿ƒåªéœ€æŒæ¡ Shared å®ä¾‹ã€Rentï¼ˆç§Ÿå€Ÿæ•°ç»„ï¼‰ã€Returnï¼ˆå½’è¿˜æ•°ç»„ï¼‰ è¿™ä¸‰ä¸ªå…³é”®éƒ¨åˆ†ï¼š</p><ol><li><strong>æ ¸å¿ƒå¯¹è±¡ä¸æ–¹æ³•è¯´æ˜</strong></li></ol><ul><li>ArrayPool&lt;T&gt;.Sharedï¼š</li></ul><p>æ˜¯æ¡†æ¶æä¾›çš„é»˜è®¤ ArrayPool å®ä¾‹ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»ºï¼Œç›´æ¥ä½¿ç”¨å³å¯ï¼ˆä¹Ÿå¯è‡ªå®šä¹‰æ± é…ç½®ï¼Œä¸€èˆ¬åœºæ™¯ç”¨ Shared è¶³å¤Ÿï¼‰ã€‚</p><ul><li><p>Rent(int minimumLength) æ–¹æ³•ï¼ˆç§Ÿå€Ÿæ•°ç»„ï¼‰ï¼š</p><ul><li>ä½œç”¨ï¼šä»å¯¹è±¡æ± é‡Œè·å–ä¸€ä¸ª <strong>é•¿åº¦ â‰¥ minimumLength</strong> çš„æ•°ç»„ï¼ˆå®é™…é•¿åº¦ä¸ç¡®å®šï¼‰ï¼›</li><li>è¿”å›å€¼ï¼šT[] ç±»å‹çš„æ•°ç»„ï¼Œå¯ç›´æ¥ç”¨äºæ•°æ®æ“ä½œã€‚</li></ul></li><li><p>Return(T[] array) æ–¹æ³•ï¼ˆå½’è¿˜æ•°ç»„ï¼‰ï¼š</p><ul><li>ä½œç”¨ï¼šå°†ç§Ÿå€Ÿçš„æ•°ç»„è¿˜å›å¯¹è±¡æ± ï¼Œä¾›åç»­å¤ç”¨ï¼›</li><li>å…³é”®å‚æ•° clearArrayï¼ˆé»˜è®¤ falseï¼‰ï¼š<ul><li>è®¾ä¸º trueï¼šå½’è¿˜å‰ä¼šè‡ªåŠ¨æ¸…ç©ºæ•°ç»„æ•°æ®ï¼ˆç”¨ Array.Clear å°†æ‰€æœ‰å…ƒç´ ç½®ä¸ºé»˜è®¤å€¼ï¼Œæ¯”å¦‚ byte æ•°ç»„ä¼šæ¸…ä¸º 0ï¼‰ï¼›</li><li>è®¾ä¸º falseï¼ˆé»˜è®¤ï¼‰ï¼šæ•°ç»„æ•°æ®ä¼šä¿ç•™ï¼Œåç»­ç§Ÿå€Ÿè€…å¯èƒ½è¯»å–åˆ°æ—§æ•°æ®ï¼Œéœ€è‡ªè¡Œæ³¨æ„æ¸…ç©ºã€‚</li></ul></li></ul></li></ul><ol start="2"><li>ç®€å•ä½¿ç”¨ç¤ºä¾‹ï¼ˆä»¥byteæ•°ç»„ä¸ºä¾‹ï¼‰</li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ä»é»˜è®¤æ± ç§Ÿå€Ÿé•¿åº¦â‰¥256çš„byteæ•°ç»„ï¼ˆå®é™…è¿”å›256é•¿åº¦ï¼‰</span></span><br><span class="line"><span class="built_in">byte</span>[] buffer = ArrayPool&lt;<span class="built_in">byte</span>&gt;.Shared.Rent(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 2. å¯¹æ•°ç»„è¿›è¡Œä¸šåŠ¡æ“ä½œ</span></span><br><span class="line">    buffer[<span class="number">0</span>] = <span class="number">123</span>;</span><br><span class="line">    buffer[<span class="number">1</span>] = <span class="number">234</span>;</span><br><span class="line">    buffer[<span class="number">2</span>] = <span class="number">255</span>;</span><br><span class="line">    <span class="comment">// ... å…¶ä»–æ•°æ®å¤„ç†é€»è¾‘</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (buffer != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 3. ç”¨å®Œåå½’è¿˜æ•°ç»„ï¼ˆå¿…é¡»æ‰§è¡Œï¼å¦åˆ™æ± èµ„æºä¼šæ³„æ¼ï¼‰</span></span><br><span class="line">        <span class="comment">// è‹¥éœ€æ¸…ç©ºæ•°æ®ï¼ŒåŠ å‚æ•°ï¼šArrayPool&lt;byte&gt;.Shared.Return(buffer, clearArray: true)</span></span><br><span class="line">        ArrayPool&lt;<span class="built_in">byte</span>&gt;.Shared.Return(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å…³äº Rent éœ€ä¸éœ€è¦ try-catch çš„é—®é¢˜ï¼Œå…·ä½“è¯·æŸ¥çœ‹ï¼š<a href="https://as436845345.github.io/2026/01/17/arraypool-what-you-should-know/">å…³äº ArrayPool çš„ä½ åº”è¯¥äº†è§£çš„å†…å®¹</a>ã€‚</p></blockquote><ol start="3"><li><strong>å…³é”®æ³¨æ„äº‹é¡¹</strong></li></ol><ul><li>å¿…é¡»å½’è¿˜æ•°ç»„ï¼šè‹¥ç§Ÿå€Ÿåä¸è°ƒç”¨ Returnï¼Œå¯¹è±¡æ± ä¼šé€æ¸è€—å°½å¯ç”¨æ•°ç»„ï¼Œå¤±å»å¤ç”¨æ„ä¹‰ï¼›</li><li>æ•°ç»„é•¿åº¦ä¸å›ºå®šï¼šRent è¿”å›çš„æ•°ç»„é•¿åº¦å¯èƒ½å¤§äºè¯·æ±‚çš„ minimumLengthï¼Œæ“ä½œæ—¶éœ€ä»¥å®é™…é•¿åº¦ä¸ºå‡†ï¼›</li><li>æ•°æ®å®‰å…¨é—®é¢˜ï¼šé»˜è®¤ Return ä¸æ¸…ç†æ•°æ®ï¼Œè‹¥æ•°ç»„å­˜æ•æ„Ÿä¿¡æ¯ï¼ŒåŠ¡å¿…åŠ  clearArray: true æ¸…ç©ºåå†å½’è¿˜ã€‚</li></ul><h2 id="ä¸ºä»€ä¹ˆå°½é‡ä½¿ç”¨-ArrayPool-ç±»"><a href="#ä¸ºä»€ä¹ˆå°½é‡ä½¿ç”¨-ArrayPool-ç±»" class="headerlink" title="ä¸ºä»€ä¹ˆå°½é‡ä½¿ç”¨ ArrayPool ç±»"></a>ä¸ºä»€ä¹ˆå°½é‡ä½¿ç”¨ ArrayPool ç±»</h2><p>åœ¨.NET ä¸­åˆ›å»ºæ•°ç»„æ—¶ï¼Œå¼€å‘è€…é€šå¸¸ä¼šä½¿ç”¨ new T[length] è¯­æ³•ï¼Œè¿™ç§æ–¹å¼è™½ç„¶ç®€å•ï¼Œä½†åœ¨<strong>é«˜é¢‘åˆ›å»º &#x2F; é”€æ¯çŸ­ç”Ÿå‘½å‘¨æœŸæ•°ç»„</strong>çš„åœºæ™¯ä¸‹ï¼Œä¼šæ˜¾è‘—å½±å“ç¨‹åºæ€§èƒ½ â€”â€” è€Œ ArrayPool&lt;T&gt; æ­£æ˜¯ä¸ºè§£å†³è¿™ä¸€é—®é¢˜è®¾è®¡çš„å†…å­˜å¤ç”¨å·¥å…·ç±»ã€‚</p><h3 id="ä¸€ã€ç›´æ¥ç”¨-new-åˆ›å»ºæ•°ç»„çš„æ€§èƒ½ç—›ç‚¹"><a href="#ä¸€ã€ç›´æ¥ç”¨-new-åˆ›å»ºæ•°ç»„çš„æ€§èƒ½ç—›ç‚¹" class="headerlink" title="ä¸€ã€ç›´æ¥ç”¨ new åˆ›å»ºæ•°ç»„çš„æ€§èƒ½ç—›ç‚¹"></a>ä¸€ã€ç›´æ¥ç”¨ new åˆ›å»ºæ•°ç»„çš„æ€§èƒ½ç—›ç‚¹</h3><p>ä½¿ç”¨ new åˆ›å»ºæ•°ç»„æ—¶ï¼ŒCLRï¼ˆå…¬å…±è¯­è¨€è¿è¡Œæ—¶ï¼‰ä¼šåœ¨<strong>æ‰˜ç®¡å †ï¼ˆManaged Heapï¼‰</strong>ä¸­ç”³è¯·ä¸€å—è¿ç»­çš„å†…å­˜å—ï¼Œå†…å­˜å¤§å°ä¸æ•°ç»„é•¿åº¦åŒ¹é…ã€‚æ•°ç»„ä¸å†è¢«å¼•ç”¨åï¼Œä¸ä¼šç«‹å³é‡Šæ”¾å†…å­˜ï¼Œéœ€ç­‰å¾…åƒåœ¾å›æ”¶ï¼ˆGCï¼‰è§¦å‘åæ‰èƒ½æ¸…ç†ã€‚é¢‘ç¹åˆ›å»ºæ•°ç»„æ—¶ï¼Œä¼šå¸¦æ¥ä¸¤å¤§æ ¸å¿ƒæ€§èƒ½æŸè€—ï¼š</p><ol><li><strong>å†…å­˜åˆ†é…è€—æ—¶å¢åŠ </strong></li></ol><p>æ¯æ¬¡ç”¨ new åˆ›å»ºæ•°ç»„ï¼ŒCLR éƒ½éœ€è¦åœ¨å †ä¸­æŸ¥æ‰¾å¹¶åˆ†é…ä¸€å—ç¬¦åˆå¤§å°çš„è¿ç»­ç©ºé—²å†…å­˜ï¼š</p><ul><li>å•æ¬¡åˆ†é…çš„è€—æ—¶è™½çŸ­ï¼Œä½†é«˜é¢‘æ“ä½œï¼ˆå¦‚ç½‘ç»œ IOã€æ•°æ®æµå¤„ç†ä¸­æ¯ç§’åˆ›å»ºæ•°ç™¾æ¬¡æ•°ç»„ï¼‰ä¼šè®©è¿™éƒ¨åˆ†è€—æ—¶ç´¯ç§¯ï¼Œæˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼›</li><li>è‹¥å †ä¸­æ— è¶³å¤Ÿè¿ç»­å†…å­˜ï¼ŒCLR è¿˜ä¼šè§¦å‘â€œå†…å­˜å‹ç¼©â€ï¼ˆGC Compactï¼‰ï¼Œè¿›ä¸€æ­¥é˜»å¡ç¨‹åºæ‰§è¡Œã€‚</li></ul><ol start="2"><li><strong>åƒåœ¾å›æ”¶ï¼ˆGCï¼‰å¼€é”€é£™å‡</strong></li></ol><ul><li>é¢‘ç¹åˆ›å»ºæ•°ç»„ä¼šå¿«é€Ÿæ¶ˆè€—å †å†…å­˜ï¼Œå¯¼è‡´ GC æ›´é¢‘ç¹è§¦å‘ï¼ˆå°¤å…¶æ˜¯ Gen 0 ä»£å›æ”¶ï¼‰ï¼›</li><li>GC æ‰§è¡Œæ—¶ä¼šæš‚åœæ‰€æœ‰æ‰˜ç®¡çº¿ç¨‹ï¼ˆSTWï¼ŒStop-The-Worldï¼‰ï¼Œå›æ”¶è¶Šå¤šï¼Œç¨‹åºçš„å“åº”å»¶è¿Ÿå’Œ CPU å ç”¨ç‡è¶Šé«˜ï¼›</li><li>å¤§æ•°ç»„è¿˜å¯èƒ½è¿›å…¥ Gen 1&#x2F;Gen 2 ä»£ï¼Œå¢åŠ å…¨é‡åƒåœ¾å›æ”¶çš„æˆæœ¬ï¼ˆGen 2 å›æ”¶è€—æ—¶è¿œé«˜äº Gen 0ï¼‰ã€‚</li></ul><h3 id="äºŒã€ArrayPool-çš„æ ¸å¿ƒä»·å€¼ï¼šå†…å­˜å¤ç”¨"><a href="#äºŒã€ArrayPool-çš„æ ¸å¿ƒä»·å€¼ï¼šå†…å­˜å¤ç”¨" class="headerlink" title="äºŒã€ArrayPool&lt;T&gt; çš„æ ¸å¿ƒä»·å€¼ï¼šå†…å­˜å¤ç”¨"></a>äºŒã€ArrayPool&lt;T&gt; çš„æ ¸å¿ƒä»·å€¼ï¼šå†…å­˜å¤ç”¨</h3><p>ArrayPool&lt;T&gt; æ˜¯ .NET æä¾›çš„æ•°ç»„å¯¹è±¡æ± ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯â€œé¢„åˆ†é…ä¸€æ‰¹æ•°ç»„å­˜äºæ± ä¸­ï¼Œä½¿ç”¨æ—¶ç§Ÿå€Ÿï¼ˆRentï¼‰ï¼Œç”¨å®Œåå½’è¿˜ï¼ˆReturnï¼‰â€ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³ä¸Šè¿°é—®é¢˜ï¼š</p><ul><li>é¿å…é‡å¤åˆ†é…ï¼šä»æ± ä¸­ç§Ÿå€Ÿæ•°ç»„æ—¶ï¼Œç›´æ¥å¤ç”¨å·²åˆ†é…çš„å†…å­˜å—ï¼Œæ— éœ€æ¯æ¬¡åœ¨å †ä¸­æŸ¥æ‰¾ &#x2F; ç”³è¯·ï¼›</li><li>é™ä½ GC å‹åŠ›ï¼šæ•°ç»„å½’è¿˜åå¯è¢«å†æ¬¡ä½¿ç”¨ï¼Œä¸ä¼šè¢« GC å›æ”¶ï¼Œå‡å°‘å †å†…å­˜å ç”¨å’Œ GC è§¦å‘é¢‘ç‡ï¼›</li><li>é«˜æ€§èƒ½è®¾è®¡ï¼šArrayPool&lt;T&gt;.Shared æ˜¯æ¡†æ¶å†…ç½®çš„å…¨å±€é»˜è®¤å®ä¾‹ï¼ˆåº•å±‚ä¸º SharedArrayPool ç±»ï¼‰ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»ºï¼Œå¼€ç®±å³ç”¨ã€‚</li></ul><h3 id="ä¸‰ã€ä½¿ç”¨å»ºè®®"><a href="#ä¸‰ã€ä½¿ç”¨å»ºè®®" class="headerlink" title="ä¸‰ã€ä½¿ç”¨å»ºè®®"></a>ä¸‰ã€ä½¿ç”¨å»ºè®®</h3><ol><li>ä¼˜å…ˆä½¿ç”¨ï¼šåœ¨.NET Core 1.0+&#x2F;.NET 5+ ç­‰æ”¯æŒ ArrayPool&lt;T&gt; çš„ç‰ˆæœ¬ä¸­ï¼Œé«˜é¢‘åˆ›å»ºçŸ­ç”Ÿå‘½å‘¨æœŸæ•°ç»„ï¼ˆå¦‚å­—èŠ‚æ•°ç»„ã€ä¸´æ—¶æ•°æ®ç¼“å†²åŒºï¼‰æ—¶ï¼ŒåŠ¡å¿…æ›¿æ¢ä¸º ArrayPool&lt;T&gt;ï¼›</li><li>é™çº§æ–¹æ¡ˆï¼šè‹¥é¡¹ç›®åŸºäºä¸æ”¯æŒ ArrayPool&lt;T&gt; çš„æ—§ç‰ˆæœ¬ï¼ˆå¦‚.NET Framework 4.xï¼‰ï¼Œå¯å‚è€ƒ GitHub ä¸Š .NET å®˜æ–¹æºç ï¼Œè‡ªè¡Œå®ç°ç®€åŒ–ç‰ˆçš„æ•°ç»„æ± ï¼ˆæ ¸å¿ƒé€»è¾‘ä¸ºâ€œç»´æŠ¤æ•°ç»„åˆ—è¡¨ï¼Œç§Ÿå€Ÿæ—¶å–å¯ç”¨æ•°ç»„ï¼Œå½’è¿˜æ—¶å›æ”¶â€ï¼‰ã€‚</li></ol><h2 id="å¤–éƒ¨é“¾æ¥"><a href="#å¤–éƒ¨é“¾æ¥" class="headerlink" title="å¤–éƒ¨é“¾æ¥"></a>å¤–éƒ¨é“¾æ¥</h2><ul><li><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.buffers.arraypool-1?view=net-8.0">ArrayPool<T> ç±» - Microsoft Learn</a></li><li><a href="https://github.com/dotnet/runtime/blob/main/src/libraries/System.Private.CoreLib/src/System/Buffers/ArrayPool.cs">ArrayList.cs - Github</a></li><li><a href="https://github.com/dotnet/runtime/blob/main/src/libraries/System.Private.CoreLib/src/System/Buffers/SharedArrayPool.cs">SharedArrayPool.cs - Github</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
          <category> Array </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> Array </tag>
            
            <tag> ArrayPool </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¦æ­¢ä½¿ç”¨ ArrayList ç±»</title>
      <link href="/2026/01/16/do-not-use-arraylist/"/>
      <url>/2026/01/16/do-not-use-arraylist/</url>
      
        <content type="html"><![CDATA[<h2 id="æ·±å…¥ç†è§£-C-ArrayList"><a href="#æ·±å…¥ç†è§£-C-ArrayList" class="headerlink" title="æ·±å…¥ç†è§£ C# ArrayList"></a>æ·±å…¥ç†è§£ C# ArrayList</h2><p>ArrayList æ˜¯ C# ä¸­çš„ä¸€ä¸ªåŠ¨æ€åˆ—è¡¨ç±»ï¼Œå…¶å†…éƒ¨é€šè¿‡ç»´æŠ¤ä¸€ä¸ª object ç±»å‹çš„æ•°ç»„ _items æ¥å­˜å‚¨æ•°æ®ã€‚å½“ä½ è°ƒç”¨ Add æ–¹æ³•æ·»åŠ å…ƒç´ æ—¶ï¼Œæ•°æ®å°±è¢«å­˜å…¥è¿™ä¸ªæ•°ç»„ä¸­ã€‚</p><p>å®ƒçš„å­˜å‚¨å­—æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">object</span>?[] _items;  <span class="comment">// å­˜å‚¨å…ƒç´ çš„åº•å±‚æ•°ç»„</span></span><br></pre></td></tr></table></figure><ul><li><strong>Add æ–¹æ³•çš„å·¥ä½œåŸç†</strong></li></ul><p>Add æ–¹æ³•è´Ÿè´£å°†å…ƒç´ è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾ï¼Œå…¶å‚æ•°ç±»å‹ä¸º objectï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">int</span> <span class="title">Add</span>(<span class="params"><span class="built_in">object</span>? <span class="keyword">value</span></span>)</span>;</span><br></pre></td></tr></table></figure><h2 id="è£…ç®±"><a href="#è£…ç®±" class="headerlink" title="è£…ç®±"></a>è£…ç®±</h2><p>å› ä¸º ArrayList å†…éƒ¨å­˜å‚¨çš„æ˜¯ object ç±»å‹ï¼ˆå¼•ç”¨ç±»å‹ï¼‰ï¼Œå½“ä½ å‘å…¶ä¸­æ·»åŠ å€¼ç±»å‹ï¼ˆå¦‚ intã€charã€doubleï¼‰æ—¶ï¼Œä¼šè§¦å‘ <strong>è£…ç®±ï¼ˆboxingï¼‰æ“ä½œï¼›å½“ä½ ä»åˆ—è¡¨ä¸­å–å‡ºå€¼ç±»å‹æ—¶ï¼Œåˆ™ä¼šè§¦å‘æ‹†ç®±ï¼ˆunboxingï¼‰</strong> æ“ä½œã€‚</p><ul><li>ArrayList æµ‹è¯•ä»£ç </li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">M</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ArrayList arrayList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    arrayList.Add(<span class="number">1</span>);      <span class="comment">// int ç±»å‹å€¼ â†’ è£…ç®±ä¸º object</span></span><br><span class="line">    arrayList.Add(<span class="string">&#x27;a&#x27;</span>);    <span class="comment">// char ç±»å‹å€¼ â†’ è£…ç®±ä¸º object</span></span><br><span class="line">    arrayList.Add(<span class="number">3.0</span>);    <span class="comment">// double ç±»å‹å€¼ â†’ è£…ç®±ä¸º object</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ArrayList æµ‹è¯•ä»£ç ç¼–è¯‘ä¸º IL</li></ul><p>ä¸Šè¿° C# ä»£ç ç¼–è¯‘ä¸º IL åï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°çœ‹åˆ°è£…ç®±çš„è¿‡ç¨‹ï¼š</p><p><img src="/../images/arraylist/arraylist_add_valuetype_il_code.png" alt="ArrayList æµ‹è¯•ä»£ç ç¼–è¯‘ä¸º IL"></p><h2 id="è£…ç®±çš„æ€§èƒ½å½±å“"><a href="#è£…ç®±çš„æ€§èƒ½å½±å“" class="headerlink" title="è£…ç®±çš„æ€§èƒ½å½±å“"></a>è£…ç®±çš„æ€§èƒ½å½±å“</h2><p><strong>è£…ç®±</strong>æ˜¯æŒ‡å°†å€¼ç±»å‹è½¬æ¢ä¸ºå¼•ç”¨ç±»å‹ï¼ˆobjectï¼‰çš„è¿‡ç¨‹ã€‚</p><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæ·»åŠ å€¼ç±»å‹ 1ï¼ˆintï¼‰æ—¶ï¼ŒIL ä¼šå…ˆæ‰§è¡Œ box [System.Runtime]System.Int32 æŒ‡ä»¤ï¼Œå†è°ƒç”¨ Add(object) æ–¹æ³•ã€‚è¿™ä¸ª box æŒ‡ä»¤æœ¬èº«ä¼šå ç”¨ 5 ä¸ªå­—èŠ‚çš„ IL ä»£ç ç©ºé—´ï¼ˆ1 å­—èŠ‚æ“ä½œç  + 4 å­—èŠ‚å…ƒæ•°æ®ä»¤ç‰Œï¼‰ï¼Œè€Œå¦‚æœæ·»åŠ çš„æ˜¯å¼•ç”¨ç±»å‹ï¼Œåˆ™ä¸ä¼šæœ‰è¿™ä¸ªé¢å¤–å¼€é”€ã€‚</p><p>é¢‘ç¹çš„è£…ç®± &#x2F; æ‹†ç®±ä¼šå¢åŠ å†…å­˜åˆ†é…å’Œç±»å‹è½¬æ¢çš„å¼€é”€ï¼Œä»è€Œå½±å“ç¨‹åºæ€§èƒ½ã€‚å› æ­¤åœ¨å®é™…å¼€å‘ä¸­ï¼Œåº”å°½é‡é¿å…ä¸å¿…è¦çš„è£…ç®±æ“ä½œï¼Œæ¨èä½¿ç”¨æ³›å‹é›†åˆï¼ˆå¦‚ List&lt;T&gt;ï¼‰ï¼Œé€šè¿‡æŒ‡å®šå…·ä½“çš„å­˜å‚¨ç±»å‹ï¼Œä»æ ¹æœ¬ä¸Šé¿å…è£…ç®± &#x2F; æ‹†ç®±ã€‚</p><h2 id="å¤–éƒ¨é“¾æ¥"><a href="#å¤–éƒ¨é“¾æ¥" class="headerlink" title="å¤–éƒ¨é“¾æ¥"></a>å¤–éƒ¨é“¾æ¥</h2><ul><li><a href="https://learn.microsoft.com/zh-cn/dotnet/csharp/fundamentals/types/">C# ç±»å‹ç³»ç»Ÿ - Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/zh-cn/dotnet/csharp/programming-guide/types/boxing-and-unboxing">è£…ç®±å’Œå–æ¶ˆè£…ç®±ï¼ˆC# ç¼–ç¨‹æŒ‡å—ï¼‰ - Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.reflection.emit.opcodes.box?view=net-9.0">IL-box å­—æ®µ - Microsoft Learn</a></li><li><a href="https://github.com/dotnet/runtime/blob/main/src/libraries/System.Private.CoreLib/src/System/Collections/ArrayList.cs">ArrayList.cs - Github</a></li><li><a href="https://sharplab.io/#v2:C4LglgNgPgAgTARgLACgYAYAEMEDoDCA9hBAKYDGwYhAdgM4DcqMAzNnJvpgN6qb/Y2MACyYAsgAoAlDz4D5AQQBOSgIYBPADJg6wTKpUbtuzAF5MNUgHdMytVp3BpTFPPkH7x4LgUATXxIIUi5uAh5Gjj7+EgDkqjHBcqHhDrpRASy46ImuAgC+qHlAA===">æµ‹è¯•ä»£ç  - sharplab</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
          <category> Array </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> Array </tag>
            
            <tag> ArrayList </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
